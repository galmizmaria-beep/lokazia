<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Генератор интерактивных карточек</title>
    <style>
        :root{
            --bg-dark:#101820;
            --panel-bg:rgba(23,37,51,0.85);
            --accent-color:#00ffe7;
            --text-light:#e0e0e0;
            --text-dark:#333;
            --border-color:rgba(0,255,231,0.2);
            --hover-bg:rgba(0,255,231,0.05);
            --correct-color:#4ade80;
            --incorrect-color:#f87171;
            /* New Design Properties */
            --card-bg-image: linear-gradient(45deg,#00776b,#00bfa5);
            --card-bg-color: transparent;
            --dynamic-glow-color: var(--accent-color);
            --dynamic-glow-shadow: 0 0 15px var(--dynamic-glow-color);

            /* Customizable */
            --base-font: 'Segoe UI', Roboto, Arial, sans-serif;
            --title-font: 'Segoe UI', Roboto, Arial, sans-serif;
            --title-size: 1.8em;
            --button-size: 16px;
            --game-bg-color: transparent;
            --game-bg-image: none;
        }
        html,body{width:100%;height:100%;margin:0;padding:0;overflow:hidden;font-family: var(--base-font);}
        body{
            background-image:linear-gradient(180deg,#1a2a3a,#101820);
            color:var(--text-light);
            display:flex;justify-content:center;align-items:center;
        }
        .master-container{ width:100%; height:100%; display:flex; flex-direction:column; box-sizing:border-box; padding:12px; }
        .master-container.editor{
            width: min(1400px, 95vw);
            aspect-ratio: 16 / 9;
            height: auto;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(180deg, rgba(26,42,58,0.95), rgba(16,24,32,0.95));
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }

        .main-title{ text-align:center; color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); margin-bottom:8px; flex-shrink:0; font-family:var(--title-font); }

        button{ background-color:transparent; color:var(--accent-color); border:1px solid var(--accent-color); padding:8px 12px; border-radius:6px; cursor:pointer; font-size:var(--button-size); font-weight:bold; transition:all .25s; }
        button:hover, #difficulty-selector button.selected {
            background-color:var(--accent-color);
            color:var(--bg-dark);
            box-shadow:0 0 15px var(--accent-color);
        }
        button:disabled{ background-color:#4a5568; border-color:#4a5568; color:#a0aec0; cursor:not-allowed; box-shadow:none; }

        input,textarea,select{ width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; box-sizing:border-box; margin-top:5px; margin-bottom:10px; background-color:rgba(0,0,0,0.15); color:var(--text-light); transition:all .3s; font-size:14px; font-family: var(--base-font); }
        input:hover,textarea:hover,select:hover,input:focus,textarea:focus,select:focus{ border-color:var(--accent-color); box-shadow:0 0 5px var(--accent-color); outline:none; }
        input[type="color"] { padding: 0; height: 40px; border-radius: 8px; cursor: pointer; }
        input[type="range"] { padding: 0; }

        #editor-wrapper{ display:flex; gap:12px; height:100%; overflow:hidden; padding:12px; box-sizing:border-box; }
        #editor-panel{ flex:1.2; min-width:320px; max-width: 500px; }
        #preview-section{ flex:1.8; display:flex; flex-direction:column; }

        .editor-panel-inner{ background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:18px; backdrop-filter:blur(8px); height:100%; box-sizing:border-box; overflow-y:auto; }
        .editor-panel-inner h2, .editor-panel-inner h3{ color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); margin:6px 0; font-family: var(--title-font); }

        .editor-section{ margin-bottom:12px; padding:10px; border-radius:8px; border:1px solid transparent; transition:all .3s; }
        .editor-section:hover{ background-color:var(--hover-bg); border-color:var(--border-color); }

        .question-block{ background:rgba(0,0,0,0.18); padding:12px; border-radius:6px; margin-bottom:12px; border:1px solid var(--border-color); }
        .question-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .option-group{ display:flex; align-items:center; margin-bottom:8px; gap:8px; }

        .char-remove-btn-x{ position:absolute; top:-5px; right:-5px; width:22px; height:22px; border-radius:50%; background:#e53e3e; color:white; border:none; font-size:16px; font-weight:bold; display:flex; align-items:center; justify-content:center; cursor:pointer; padding:0; box-shadow:0 2px 4px rgba(0,0,0,.4); }

        #preview-iframe{ width:100%; flex-grow:1; border-radius:8px; border:1px solid var(--border-color); background-color:var(--bg-dark); }
        #iframe-code{ display:none; margin-top:10px; min-height:80px; font-size:12px; }

        /* --- GAME STYLES --- */
        #game-container{ width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; box-sizing:border-box; background:var(--game-bg-color) var(--game-bg-image) no-repeat center center; background-size: cover; }
        #start-screen{ width:100%; max-width:900px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:22px; backdrop-filter:blur(10px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; box-sizing:border-box; position:relative; }
        #game-title-display{ text-align:center; color:var(--accent-color); font-size:var(--title-size); margin:6px 0; text-shadow:0 0 5px var(--accent-color); font-family:var(--title-font); }
        #character-selector{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom: 8px; }
        #character-selector img{ width:80px; height:80px; border-radius:50%; border:3px solid transparent; cursor:pointer; object-fit:cover; transition:all .2s; }
        #character-selector img.selected{ border-color:var(--dynamic-glow-color); box-shadow:var(--dynamic-glow-shadow); transform:scale(1.05); }

        #game-process{ width:100%; height:100%; position:relative; padding:12px; box-sizing:border-box; display:block; }
        #game-ui-top{ position:absolute; top:20px; left:20px; right:20px; display:flex; justify-content:space-between; align-items:center; z-index: 100; }
        #lives-container{ display:flex; gap:5px; font-size:1.8em; }
        #back-to-map-btn { font-size: 14px; padding: 6px 10px; }
        
        #current-mission-game-area { display: flex; align-items: center; justify-content: space-around; gap: 12px; width: 100%; height: 100%; }
        #character-display { position: relative; flex: 1; max-width: 36%; height: 90%; display: flex; justify-content: center; align-items: flex-end; background: transparent; }
        #player-char-img{ max-width:100%; max-height:100%; object-fit: contain; transition:transform .3s ease, filter .3s ease; }
        #player-char-img.correct-answer{ animation:jump-animation .6s ease; filter: drop-shadow(var(--dynamic-glow-shadow)); }
        #player-char-img.incorrect-answer{ animation:shake-animation .6s ease; filter: drop-shadow(0 0 15px var(--incorrect-color)); }

        #card-grid-area{ position: relative; flex: 1.5; max-width: 60%; height: 90%; overflow-y: auto; display:flex; flex-wrap: wrap; gap:12px; padding:12px; background:rgba(0,0,0,0.25); border-radius:8px; align-content: flex-start; justify-content: center; }
        .card{ width: 90px; height: 130px; background-image: var(--card-bg-image); background-color: var(--card-bg-color); background-size: cover; background-position: center; color:white; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:2.2em; font-weight:bold; cursor:pointer; transition: all 0.3s ease; box-shadow:0 5px 15px rgba(0,0,0,.3); position: relative; }
        .card:hover{ transform: translateY(-5px); box-shadow: 0 8px 20px var(--dynamic-glow-color); }
        .card.completed{ background: var(--correct-color); cursor: not-allowed; opacity: 0.6; pointer-events: none; }
        .card.completed::after { content: '✔'; font-size: 2.0em; color: white; position: absolute; }
        .card.incorrect { background: var(--incorrect-color); cursor: not-allowed; opacity: 0.85; pointer-events: none; }
        .card.incorrect::after { content: '✖'; font-size: 2.0em; color: white; position: absolute; }

        #question-modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter: blur(5px); display:flex; align-items:center; justify-content:center; z-index: 2000; }
        #question-modal-content{ background-color:#e0e0e0; color:var(--text-dark); padding:24px; border-radius:12px; min-width: 420px; max-width: 90vw; }
        .card-question{ font-size:1.1em; font-weight:bold; margin-bottom:12px; }
        .card-answers button, .card-input-area button{ width:100%; margin-bottom:10px; background-color:#f1f5f9; color:var(--text-dark); border:1px solid #ccc; text-align:left; padding:10px; font-size:14px; }

        #end-screen{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; width:100%; max-width:900px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:22px; box-sizing:border-box; }
        #end-screen .end-player{ width:45%; max-width:320px; height:auto; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
        #end-player-img{ width:100%; height:auto; object-fit:contain; display:block; }

        .hidden{ display:none !important; }

        @keyframes jump-animation{ 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-20px);} }
        @keyframes shake-animation{ 0%,100%{ transform:translateX(0);} 25%{ transform:translateX(-8px) rotate(-2deg);} 75%{ transform:translateX(8px) rotate(2deg);} }
        @keyframes fade-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(1.4); } }
        @keyframes pulse-animation { 0% { box-shadow: var(--dynamic-glow-shadow); } 50% { box-shadow: 0 0 25px var(--dynamic-glow-color); } 100% { box-shadow: var(--dynamic-glow-shadow); } }

        .title-anim-none {}
        .title-anim-bounce { animation: bounce-title 1.4s ease-in-out infinite; }
        .title-anim-fade { animation: fade-title 2s ease-in-out infinite; }
        .title-anim-pulse { animation: pulse-title 1.6s ease-in-out infinite; }
        .title-anim-rotate { animation: rotate-title 4s linear infinite; transform-origin: center; }
        .title-anim-sway { animation: sway-title 2.5s ease-in-out infinite; }
        .title-anim-zoom { animation: zoom-title 2.2s ease-in-out infinite; }
        @keyframes bounce-title { 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-8px);} }
        @keyframes fade-title { 0%{opacity:1}50%{opacity:.6}100%{opacity:1} }
        @keyframes pulse-title { 0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)} }
        @keyframes rotate-title { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }
        @keyframes sway-title { 0%{transform:translateX(-4px)}50%{transform:translateX(4px)}100%{transform:translateX(-4px)} }
        @keyframes zoom-title { 0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)} }

        .mission-map-icon { position: absolute; display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: transform 0.25s ease; z-index: 20; transform: translate(-50%, -50%); }
        .mission-map-icon img { width: 110px; height: 110px; object-fit: cover; border-radius: 50%; border: 4px solid var(--dynamic-glow-color); }
        .mission-map-icon .icon-fallback { width:110px; height:110px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.06); border:4px solid var(--dynamic-glow-color); color:white; font-weight:bold; font-size:28px; }
        .mission-map-icon span { font-size: 1em; color: white; text-shadow: 0 0 5px black; background: rgba(0,0,0,0.45); padding: 6px 12px; border-radius: 8px; }
        .mission-map-icon:not(.locked):hover { transform: scale(1.12) translate(-50%, -50%); }
        .mission-map-icon.active { animation: pulse-animation 1.5s ease-in-out infinite; }
        .mission-map-icon.completed { filter: grayscale(100%) brightness(0.75); opacity: 0.85; pointer-events: none; }
        .mission-map-icon.locked { pointer-events: none; filter: grayscale(80%) brightness(0.6); opacity: 0.7; }

        #map-area { position: absolute; inset: 0; }
        #mission-description-panel { position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%); background-color: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px 16px; max-width: 80%; text-align: center; z-index: 60; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.25s ease; }
        #mission-description-panel:not(.hidden) { opacity: 1; visibility: visible; }
        #mission-description-panel h3 { margin-top: 0; color: var(--accent-color); font-size:1.05em; }
        #mission-description-panel p { margin-bottom: 0; min-height: 1.2em; }

        #start-screen button, #start-screen select, #start-screen input { font-size: var(--button-size); }

        @media (max-width:700px){
            .master-container.editor{ aspect-ratio: auto; width: 100vw; height: 100vh; flex-direction: column;}
            #editor-wrapper { flex-direction: column; }
            #editor-panel{ max-width: 100%; }
            #character-selector img{ width:56px;height:56px;}
            .card{ width:76px;height:110px;}
            .mission-map-icon img, .mission-map-icon .icon-fallback { width:80px;height:80px;font-size:18px;border-width:3px;}
        }
    </style>
</head>
<body>
    <div class="master-container">
        <h1 class="main-title">Генератор интерактивных карточек</h1>

        <div id="editor-wrapper">
            <div id="editor-panel">
                <div class="editor-panel-inner">
                    <div class="editor-section">
                        <h2>1. Название игры</h2>
                        <input type="text" id="game-title" value="Проверь свои знания!">
                    </div>

                    <div class="editor-section">
                        <h2>2. Язык интерфейса</h2>
                        <select id="language-select">
                            <option value="ru">Русский</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <div class="editor-section">
                        <h2>3. Дизайн и обложка</h2>
                        <label for="game-bg-upload">Загрузить фон/обложку игры</label>
                        <input type="file" id="game-bg-upload" accept="image/*">
                        
                        <label for="card-bg-upload">Фон для карточек</label>
                        <input type="file" id="card-bg-upload" accept="image/*">
                        <label for="card-color-picker">Цвет карточек (если нет фона)</label>
                        <input type="color" id="card-color-picker" value="#00bfa5">
                        <label for="glow-color-picker">Цвет свечения</label>
                        <input type="color" id="glow-color-picker" value="#00ffe7">
                        <label for="glow-intensity-slider">Интенсивность свечения</label>
                        <input type="range" id="glow-intensity-slider" min="5" max="30" value="15">

                        <label for="font-select">Выбор шрифта названия</label>
                        <select id="font-select">
                            <option value="'Segoe UI', Roboto, Arial, sans-serif">System (Segoe/Roboto)</option>
                            <option value="'Times New Roman', Times, serif">Times New Roman</option>
                            <option value="Arial, Helvetica, sans-serif">Arial</option>
                            <option value="Verdana, Geneva, sans-serif">Verdana</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Comic Sans MS', cursive, sans-serif">Comic Sans</option>
                            <option value="'Courier New', monospace">Monospace</option>
                        </select>

                        <label for="title-size-input">Размер названия (em)</label>
                        <input type="number" id="title-size-input" value="1.8" step="0.1" min="0.8">
                        <label for="button-size-input">Размер кнопок (px)</label>
                        <input type="number" id="button-size-input" value="16" min="10" step="1">
                        <label for="game-bg-color-picker">Цвет фона игры (если нет обложки)</label>
                        <input type="color" id="game-bg-color-picker" value="#00000000">
                    </div>

                    <div class="editor-section">
                        <h2>4. Анимация названия</h2>
                        <select id="title-animation-select">
                            <option value="title-anim-none">Нет</option>
                            <option value="title-anim-bounce">Прыжок</option>
                            <option value="title-anim-fade">Исчезание</option>
                            <option value="title-anim-pulse">Пульсация</option>
                            <option value="title-anim-rotate">Вращение</option>
                            <option value="title-anim-sway">Качающийся</option>
                            <option value="title-anim-zoom">Зум</option>
                        </select>
                    </div>

                    <div class="editor-section">
                        <h2>5. Миссии и Задания (до 5)</h2>
                        <div id="missions-container"></div>
                        <button id="add-mission-btn">Добавить миссию</button>
                    </div>

                    <div class="editor-section">
                        <h2>6. Персонажи</h2>
                        <div id="characters-container"></div>
                        <button id="add-character-btn">Добавить персонажа</button>
                    </div>

                    <div class="editor-section">
                        <h2>7. Фоновая музыка</h2>
                        <input type="file" id="bg-music-upload" accept="audio/*">
                    </div>

                    <div class="editor-section">
                        <h2>8. Настройки жизней</h2>
                        <div>
                            <label for="easy-lives">Легкий:</label>
                            <input type="number" id="easy-lives" value="5" min="0">
                        </div>
                        <div>
                            <label for="medium-lives">Средний:</label>
                            <input type="number" id="medium-lives" value="3" min="0">
                        </div>
                        <div>
                            <label for="hard-lives">Сложный:</label>
                            <input type="number" id="hard-lives" value="1" min="0">
                        </div>
                    </div>

                     <div class="editor-section">
                        <h2>Опции генерации</h2>
                        <label><input type="checkbox" id="compress-images-checkbox" checked> Сжимать изображения</label>
                        <label for="max-image-width">Макс. ширина (px)</label>
                        <input type="number" id="max-image-width" value="1024" min="200">
                        <label for="jpeg-quality">Качество JPEG (0.1–1)</label>
                        <input type="number" id="jpeg-quality" value="0.75" min="0.1" max="1" step="0.05">
                    </div>

                </div>
            </div>

            <div id="preview-section">
                <iframe id="preview-iframe"></iframe>
                <button id="generate-code-btn">Сгенерировать код</button>
                <textarea id="iframe-code"></textarea>
            </div>
        </div>

        <div id="game-container" class="hidden">
            <div id="start-screen" class="game-frame">
                <h1 id="game-title-display"></h1>
                <h2 data-lang-key="game_select_char">Выберите персонажа:</h2>
                <div id="character-selector"></div>
                <h2 data-lang-key="game_select_difficulty">Выберите уровень сложности:</h2>
                <div id="difficulty-selector">
                    <button data-difficulty="easy" data-lang-key="difficulty_easy">Легкий</button>
                    <button data-difficulty="medium" data-lang-key="difficulty_medium">Средний</button>
                    <button data-difficulty="hard" data-lang-key="difficulty_hard">Сложный</button>
                </div>
                <button id="start-game-btn" disabled data-lang-key="game_start">Начать!</button>
            </div>

            <div id="game-process" class="hidden">
                <div id="mission-map-screen" class="hidden">
                    <div id="game-ui-top">
                         <div id="lives-container"></div>
                         <button id="back-btn-map" data-lang-key="game_back_to_start">Назад</button>
                         <audio id="game-bg-music" loop></audio>
                    </div>
                    <div id="map-area"></div>
                    <div id="mission-description-panel" class="hidden">
                        <h3 id="current-mission-title"></h3>
                        <p id="current-mission-description"></p>
                    </div>
                </div>

                <div id="current-mission-game-area" class="hidden">
                     <div id="game-ui-top">
                         <div id="lives-container"></div>
                         <button id="back-btn-mission" data-lang-key="game_back_to_map">К карте</button>
                     </div>
                    <div id="character-display"><img id="player-char-img" src=""></div>
                    <div id="card-grid-area"></div>
                </div>

                <div id="question-modal-overlay" class="hidden">
                    <div id="question-modal-content">
                        <div class="card-question"></div>
                        <div class="card-content-area"></div>
                    </div>
                </div>
            </div>

            <div id="end-screen" class="hidden">
                <div class="end-player"><img id="end-player-img" src=""></div>
                <h2 id="end-title">Игра окончена!</h2>
                <!-- FIX: Changed from window.location.reload() to a button with an ID for iframe compatibility -->
                <button id="play-again-btn" data-lang-key="game_play_again">Сыграть еще раз</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const TRANSPARENT_PNG = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8Xw8AAn8B9ah0uQAAAABJRU5ErkJggg==';
    const urlParams = new URLSearchParams(window.location.search);
    const isPlayerMode = urlParams.get('mode') === 'player';

    let gameDataUrls = {
        gameBackground: null,
        cardBackground: null,
        backgroundMusic: null,
    };
    let isCodeGenerated = false;

    const translations = {
        ru: {
            game_back_to_start: "К началу",
            game_back_to_map: "К карте",
            editor_add_mission: "Добавить миссию",
            editor_add_questions: "Добавить вопросы из списка",
            editor_questions_added: "Вопросы добавлены!",
            mission_name_placeholder: "Название миссии",
            mission_desc_placeholder: "Описание миссии",
            editor_add_char: "Добавить персонажа",
            editor_generate: "Сгенерировать код",
            editor_copy: "Копировать",
            editor_copied: "Скопировано!",
            game_select_char: "Выберите персонажа:",
            game_select_difficulty: "Выберите уровень сложности:",
            game_start: "Начать!",
            game_check: "Проверить",
            game_end_win: "ТЫ ПОБЕДИЛ!",
            game_end_lose: "ТЫ ПРОИГРАЛ!",
            game_play_again: "Сыграть еще раз",
            difficulty_easy: "Легкий",
            difficulty_medium: "Средний",
            difficulty_hard: "Сложный",
            all_missions_completed: "Все миссии выполнены!"
        },
        en: {
            game_back_to_start: "To Start",
            game_back_to_map: "To Map",
            editor_add_mission: "Add Mission",
            editor_add_questions: "Add Questions from List",
            editor_questions_added: "Questions Added!",
            mission_name_placeholder: "Mission Name",
            mission_desc_placeholder: "Mission Description",
            editor_add_char: "Add Character",
            editor_generate: "Generate Code",
            editor_copy: "Copy",
            editor_copied: "Copied!",
            game_select_char: "Select a Character:",
            game_select_difficulty: "Select Difficulty Level:",
            game_start: "Start!",
            game_check: "Check",
            game_end_win: "YOU WIN!",
            game_end_lose: "YOU LOSE!",
            game_play_again: "Play Again",
            difficulty_easy: "Easy",
            difficulty_medium: "Medium",
            difficulty_hard: "Hard",
            all_missions_completed: "All Missions Completed!"
        }
    };

    const MISSION_POSITIONS = [ { x: 25, y: 20 }, { x: 75, y: 20 }, { x: 50, y: 50 }, { x: 25, y: 80 }, { x: 75, y: 80 } ];

    let gameConfig = {};
    let gameState = { lang: 'ru', character: '', difficulty: null, globalLives: 0, completedMissions: new Set() };

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    if (isPlayerMode) {
        document.getElementById('editor-wrapper').style.display = 'none';
        document.querySelector('.main-title').style.display = 'none';
        document.body.style.padding = '0';
        document.getElementById('game-container').classList.remove('hidden');
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'gameConfig') {
                initGame(event.data.config);
            }
        });
    } else {
        document.querySelector('.master-container').classList.add('editor');
        initEditor();
    }

    function updateUI(lang) {
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            const translation = translations[lang]?.[key];
            if (translation) {
                if ('placeholder' in el) el.placeholder = translation;
                else el.textContent = translation;
            }
        });
    }

    function initEditor() {
        document.getElementById('add-character-btn').addEventListener('click', addCharacterInput);
        document.getElementById('add-mission-btn').addEventListener('click', addMissionBlock);
        document.getElementById('generate-code-btn').addEventListener('click', handleGenerateCodeClick);
        document.getElementById('editor-panel').addEventListener('input', updatePreview);
        document.getElementById('editor-panel').addEventListener('change', updatePreview);

        const previewIframe = document.getElementById('preview-iframe');
        previewIframe.src = `${window.location.pathname}?mode=player`;
        previewIframe.onload = () => updatePreview();
        
        addCharacterInput();
        addMissionBlock();
        updateUI('ru');

        document.getElementById('game-bg-upload').addEventListener('change', createFileHandler('gameBackground'));
        document.getElementById('card-bg-upload').addEventListener('change', createFileHandler('cardBackground'));
        document.getElementById('bg-music-upload').addEventListener('change', createFileHandler('backgroundMusic'));
    }

    function collectConfig() {
        const missions = Array.from(document.getElementById('missions-container').children).map(block => {
            const questions = Array.from(block.querySelectorAll('.question-block')).map(qBlock => {
                return {
                    type: 'multiple-choice',
                    question: qBlock.querySelector('.question-text').value.trim(),
                    options: Array.from(qBlock.querySelectorAll('.option-text')).map(i => i.value),
                    answer: qBlock.querySelector('input[type="radio"]:checked') ? parseInt(qBlock.querySelector('input[type="radio"]:checked').value, 10) : 0
                };
            }).filter(q => q.question);

            const imgEl = block.querySelector('img');
            return {
                name: block.querySelector('.mission-name-input').value.trim(),
                description: block.querySelector('.mission-desc-input').value.trim(),
                iconUrl: imgEl && imgEl.dataset.local === 'true' ? imgEl.src : null,
                questions: questions,
            };
        }).filter(m => m.name && m.questions.length > 0);

        return {
            lang: document.getElementById('language-select').value,
            title: document.getElementById('game-title').value,
            characters: Array.from(document.getElementById('characters-container').querySelectorAll('img')).map(img => img.dataset.local === 'true' ? img.src : null).filter(Boolean),
            difficultySettings: {
                easy: { lives: parseInt(document.getElementById('easy-lives').value, 10) },
                medium: { lives: parseInt(document.getElementById('medium-lives').value, 10) },
                hard: { lives: parseInt(document.getElementById('hard-lives').value, 10) },
            },
            design: {
                gameBackground: gameDataUrls.gameBackground,
                cardBackground: gameDataUrls.cardBackground,
                cardColor: document.getElementById('card-color-picker').value,
                glowColor: document.getElementById('glow-color-picker').value,
                glowIntensity: document.getElementById('glow-intensity-slider').value,
                titleFont: document.getElementById('font-select').value,
                titleSize: parseFloat(document.getElementById('title-size-input').value) || 1.8,
                buttonSize: parseInt(document.getElementById('button-size-input').value, 10) || 16,
                titleAnimation: document.getElementById('title-animation-select').value || 'title-anim-none',
                gameBgColor: document.getElementById('game-bg-color-picker').value || 'transparent'
            },
            music: gameDataUrls.backgroundMusic,
            missions: missions,
        };
    }

    function updatePreview() {
        const config = collectConfig();
        const previewIframe = document.getElementById('preview-iframe');
        if (previewIframe.contentWindow) {
            previewIframe.contentWindow.postMessage({ type: 'gameConfig', config }, '*');
        }
        isCodeGenerated = false;
        const lang = document.getElementById('language-select').value || 'ru';
        document.getElementById('generate-code-btn').textContent = translations[lang].editor_generate;
    }

    function compressImage(dataUrl, maxWidth = 1024, quality = 0.75) {
        return new Promise((resolve) => {
            if (!dataUrl || !dataUrl.startsWith('data:image')) return resolve(dataUrl);
            const img = new Image();
            img.onload = () => {
                const ratio = Math.min(1, maxWidth / img.width);
                const canvas = document.createElement('canvas');
                const w = Math.round(img.width * ratio);
                const h = Math.round(img.height * ratio);
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0,0,w,h);
                ctx.drawImage(img, 0, 0, w, h);
                try { resolve(canvas.toDataURL('image/jpeg', quality)); } catch (e) { resolve(dataUrl); }
            };
            img.onerror = () => resolve(dataUrl);
            img.src = dataUrl;
        });
    }

    async function compressConfigImages(config, maxWidth, quality) {
        if (Array.isArray(config.characters)) config.characters = await Promise.all(config.characters.map(char => compressImage(char, maxWidth, quality)));
        if (config.design) {
            if (config.design.cardBackground) config.design.cardBackground = await compressImage(config.design.cardBackground, maxWidth, quality);
            if (config.design.gameBackground) config.design.gameBackground = await compressImage(config.design.gameBackground, maxWidth, quality);
        }
        if (Array.isArray(config.missions)) {
            for (let m of config.missions) {
                if (m.iconUrl) m.iconUrl = await compressImage(m.iconUrl, maxWidth, quality);
            }
        }
        return config;
    }

    async function handleGenerateCodeClick() {
        const codeTextarea = document.getElementById('iframe-code');
        const btn = document.getElementById('generate-code-btn');
        const lang = document.getElementById('language-select').value;
        if (!isCodeGenerated) {
            let config = collectConfig();
            if (document.getElementById('compress-images-checkbox').checked) {
                const maxW = parseInt(document.getElementById('max-image-width').value,10) || 1024;
                const q = parseFloat(document.getElementById('jpeg-quality').value) || 0.75;
                config = await compressConfigImages(JSON.parse(JSON.stringify(config)), maxW, q);
            }
            const configString = JSON.stringify(config).replace(/</g, '\\u003c');
            codeTextarea.value = `<div style="position:relative;width:100%;padding-bottom:56.25%;"><iframe id="game-iframe-123" src="${window.location.href.split('?')[0]}?mode=player" frameborder="0" allow="autoplay" style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div><script>(function(){var iframe=document.getElementById('game-iframe-123');var gameConfig=${configString};var sendConf=function(){if(iframe.contentWindow){iframe.contentWindow.postMessage({type:'gameConfig',config:gameConfig},'*');}else{setTimeout(sendConf,100);}};if(iframe.contentDocument&&iframe.contentDocument.readyState==='complete'){sendConf();}else{iframe.onload=sendConf;}})();<\/script>`;
            codeTextarea.style.display = 'block';
            btn.textContent = translations[lang].editor_copy;
            isCodeGenerated = true;
        } else {
            codeTextarea.select();
            navigator.clipboard.writeText(codeTextarea.value).then(() => {
                btn.textContent = translations[lang].editor_copied;
                setTimeout(() => { btn.textContent = translations[lang].editor_copy; }, 2000);
            });
        }
    }

    function createFileHandler(urlKey) {
        return (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    gameDataUrls[urlKey] = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(file);
            }
        };
    }

    function addCharacterInput() {
        const container = document.getElementById('characters-container');
        const uniqueId = `char-${Date.now()}`;
        const group = document.createElement('div');
        group.style = "display:flex; align-items:center; gap:8px; position:relative;";
        group.innerHTML = `<img src="${TRANSPARENT_PNG}" alt="preview" id="preview-${uniqueId}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;background:rgba(255,255,255,0.03);border:2px solid rgba(255,255,255,0.04);"><input type="file" id="${uniqueId}" accept="image/*" style="display:none;"><label for="${uniqueId}" style="flex-grow:1;text-align:center;background-color:#4a5568;padding:8px;border-radius:5px;cursor:pointer;">Добавить</label><button type="button" class="char-remove-btn-x">&times;</button>`;
        container.appendChild(group);
        group.querySelector('.char-remove-btn-x').onclick = () => { group.remove(); updatePreview(); };
        document.getElementById(uniqueId).addEventListener('change', (e) => {
            if (e.target.files[0]) {
                const r = new FileReader();
                r.onload = (ev) => {
                    const img = document.getElementById(`preview-${uniqueId}`);
                    img.src = ev.target.result;
                    img.dataset.local = 'true';
                    updatePreview();
                };
                r.readAsDataURL(e.target.files[0]);
            }
        });
    }
    
    // FIX: Modified this function to return true if questions were added, for UI feedback.
    function parseAndAddQuestions(textarea, questionsContainer) {
        const text = textarea.value.trim();
        if (!text) return false;
        
        let questionsAdded = 0;
        const questionBlocks = text.split(/\n\s*\n/);

        questionBlocks.forEach(blockText => {
            const lines = blockText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return;

            const questionText = lines[0].trim();
            const answers = lines.slice(1);
            
            const correctAnswers = answers.filter(a => a.startsWith('+')).map(a => a.substring(1).trim());
            const incorrectAnswers = answers.filter(a => a.startsWith('-')).map(a => a.substring(1).trim());

            if (correctAnswers.length === 0 || (correctAnswers.length + incorrectAnswers.length < 2)) return;
            
            const firstCorrectAnswerText = correctAnswers[0];
            let allOptions = [...correctAnswers, ...incorrectAnswers];
            allOptions = shuffle(allOptions);
            const correctIndex = allOptions.indexOf(firstCorrectAnswerText);

            createQuestionElementFromData({
                type: 'multiple-choice',
                question: questionText,
                options: allOptions,
                answer: correctIndex >= 0 ? correctIndex : 0
            }, questionsContainer);
            questionsAdded++;
        });

        if (questionsAdded > 0) {
            textarea.value = '';
            updatePreview();
            return true;
        }
        return false;
    }

    function addMissionBlock() {
        const container = document.getElementById('missions-container');
        const addBtn = document.getElementById('add-mission-btn');
        if (container.children.length >= 5) { addBtn.disabled = true; return; }

        const uniqueId = Date.now();
        const block = document.createElement('div');
        block.className = 'editor-section';
        block.innerHTML = `
            <div style="display:flex;gap:12px;align-items:flex-start;position:relative;">
                <img src="${TRANSPARENT_PNG}" id="mission-icon-${uniqueId}" style="background:rgba(255,255,255,0.03);border:2px solid rgba(255,255,255,0.04);width:70px;height:70px;border-radius:50%;object-fit:cover;" data-local="false">
                <div style="flex:1;">
                    <input type="text" class="mission-name-input" placeholder="Название миссии" value="Миссия ${container.children.length + 1}">
                    <textarea class="mission-desc-input" placeholder="Описание миссии" rows="2"></textarea>
                    <input type="file" id="mission-file-${uniqueId}" accept="image/*" style="display:none;">
                    <label for="mission-file-${uniqueId}" style="cursor:pointer; text-decoration:underline;">Загрузить иконку</label>
                </div>
                <button type="button" class="char-remove-btn-x">&times;</button>
            </div>
            <details style="margin-top:8px;">
                <summary>Задания</summary>
                <div class="mission-questions-container" style="margin-top:8px;"></div>
                <div class="bulk-add-section" style="margin-top:10px; border-top: 1px solid var(--border-color); padding-top: 10px;">
                    <h4>Массовое добавление</h4>
                    <textarea class="bulk-questions-input" rows="6" placeholder="Вставьте вопросы:\nВопрос 1\n+Правильный ответ\n-Неправильный ответ 1\n\nВопрос 2..."></textarea>
                    <button type="button" class="parse-questions-btn">Добавить вопросы из списка</button>
                </div>
            </details>
        `;
        container.appendChild(block);

        block.querySelector('.char-remove-btn-x').onclick = () => {
            block.remove();
            addBtn.disabled = container.children.length >= 5;
            updatePreview();
        };

        // FIX: Added UI feedback for the "Add Questions" button.
        block.querySelector('.parse-questions-btn').onclick = (e) => {
            const button = e.target;
            const bulkAddSection = button.closest('.bulk-add-section');
            if (bulkAddSection) {
                const textarea = bulkAddSection.querySelector('.bulk-questions-input');
                const questionsContainer = button.closest('details').querySelector('.mission-questions-container');
                if (textarea && questionsContainer) {
                    if (parseAndAddQuestions(textarea, questionsContainer)) {
                        const lang = document.getElementById('language-select').value;
                        const originalText = translations[lang].editor_add_questions;
                        button.style.backgroundColor = 'var(--correct-color)';
                        button.style.color = 'var(--text-dark)';
                        button.textContent = translations[lang].editor_questions_added;
                        
                        setTimeout(() => {
                           button.style.backgroundColor = '';
                           button.style.color = '';
                           button.textContent = originalText;
                        }, 2500);
                    }
                }
            }
        };

        document.getElementById(`mission-file-${uniqueId}`).addEventListener('change', (e) => {
            if (e.target.files[0]) {
                const r = new FileReader();
                r.onload = (ev) => {
                    document.getElementById(`mission-icon-${uniqueId}`).src = ev.target.result;
                    document.getElementById(`mission-icon-${uniqueId}`).dataset.local = 'true';
                    updatePreview();
                };
                r.readAsDataURL(e.target.files[0]);
            }
        });
        if (container.children.length >= 5) addBtn.disabled = true;
        updatePreview();
    }
    
    function createQuestionElementFromData(qData, container) {
        const qIndex = Date.now() + Math.random();
        const block = document.createElement('div');
        block.className = 'question-block';
        block.innerHTML = `
            <div class="question-header"><span>Вопрос ${container.children.length + 1}</span><button type="button" class="remove-question-btn">Удалить</button></div>
            <textarea class="question-text"></textarea>
            <div class="mc-options"><div class="options-container"></div><button type="button" class="add-option-btn">+ Добавить вариант</button></div>
        `;
        container.appendChild(block);

        block.querySelector('.question-text').value = qData.question;
        const optionsContainer = block.querySelector('.options-container');

        qData.options.forEach((opt, index) => {
            const group = document.createElement('div');
            group.className = 'option-group';
            group.innerHTML = `<input type="radio" name="correct_q${qIndex}" value="${index}"><input type="text" class="option-text" value="${escapeHtml(opt)}">`;
            optionsContainer.appendChild(group);
        });
        const correctRadio = optionsContainer.querySelector(`input[value="${qData.answer}"]`);
        if (correctRadio) correctRadio.checked = true;
        
        block.querySelector('.remove-question-btn').onclick = () => { block.remove(); updatePreview(); };
        block.querySelector('.add-option-btn').onclick = () => addOption(optionsContainer, qIndex);
    }

    function addOption(container, qIndex) {
        const optionIndex = container.children.length;
        const group = document.createElement('div');
        group.className = 'option-group';
        group.innerHTML = `<input type="radio" name="correct_q${qIndex}" value="${optionIndex}"><input type="text" class="option-text" placeholder="Вариант ${optionIndex + 1}">`;
        container.appendChild(group);
    }

    // GAME FUNCTIONS
    function initGame(config) {
        gameConfig = config;
        gameState.lang = config.lang || 'ru';
        updateUI(gameState.lang);

        const d = config.design || {};
        const root = document.documentElement;

        root.style.setProperty('--game-bg-image', d.gameBackground ? `url(${d.gameBackground})` : 'none');
        root.style.setProperty('--card-bg-image', d.cardBackground ? `url(${d.cardBackground})` : 'none');
        root.style.setProperty('--card-bg-color', d.cardColor || 'transparent');
        root.style.setProperty('--dynamic-glow-color', d.glowColor || '#00ffe7');
        root.style.setProperty('--dynamic-glow-shadow', `0 0 ${d.glowIntensity || 15}px ${d.glowColor || '#00ffe7'}`);
        root.style.setProperty('--title-font', d.titleFont || "var(--base-font)");
        root.style.setProperty('--title-size', (d.titleSize ? d.titleSize + 'em' : '1.8em'));
        root.style.setProperty('--button-size', (d.buttonSize ? d.buttonSize + 'px' : '16px'));
        root.style.setProperty('--game-bg-color', d.gameBgColor || 'transparent');

        const titleEl = document.getElementById('game-title-display');
        titleEl.textContent = config.title;
        titleEl.className = 'main-title'; // Clear previous animations
        if (d.titleAnimation) titleEl.classList.add(d.titleAnimation);

        const charSelector = document.getElementById('character-selector');
        charSelector.innerHTML = '';
        if (config.characters?.length > 0) {
            config.characters.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.onclick = () => {
                    charSelector.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
                    img.classList.add('selected');
                    gameState.character = url;
                    checkStartButton();
                };
                charSelector.appendChild(img);
            });
        }
        document.querySelectorAll('#difficulty-selector button').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('#difficulty-selector button').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                gameState.difficulty = btn.dataset.difficulty;
                checkStartButton();
            };
        });
        
        document.getElementById('start-game-btn').onclick = startGame;
        document.getElementById('back-btn-map').onclick = showStartScreen;
        document.getElementById('back-btn-mission').onclick = showMissionMap;
        // FIX: Added event listener for the new play-again button ID
        document.getElementById('play-again-btn').onclick = showStartScreen;

        checkStartButton();
        prepareBuiltInSounds();
    }

    function checkStartButton() {
        const btn = document.getElementById('start-game-btn');
        const canStart = gameState.character && gameState.difficulty && gameConfig.missions?.length > 0;
        btn.disabled = !canStart;
    }

    function showStartScreen() {
        document.getElementById('game-process').classList.add('hidden');
        document.getElementById('end-screen').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
        const music = document.getElementById('game-bg-music');
        if (music) {
            music.pause();
            music.currentTime = 0;
        }
        // Reset state for a new game
        gameState.completedMissions = new Set();
        gameState.character = '';
        gameState.difficulty = null;
        document.querySelectorAll('#character-selector img.selected').forEach(el => el.classList.remove('selected'));
        document.querySelectorAll('#difficulty-selector button.selected').forEach(el => el.classList.remove('selected'));
        checkStartButton();
    }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-process').classList.remove('hidden');
        document.getElementById('player-char-img').src = gameState.character || '';
        gameState.globalLives = gameConfig.difficultySettings?.[gameState.difficulty]?.lives ?? 3;
        gameState.completedMissions = new Set();
        const music = document.getElementById('game-bg-music');
        if(gameConfig.music) {
            music.src = gameConfig.music;
            music.play().catch(()=>{});
        }
        showMissionMap();
    }

    function updateLivesDisplay() {
        document.querySelectorAll('#lives-container').forEach(container => {
            container.innerHTML = Array(Math.max(0, gameState.globalLives)).fill('<span>❤️</span>').join('');
        });
    }

    function loseLife() {
        if(gameState.globalLives > 0) gameState.globalLives--;
        updateLivesDisplay();
        if (gameState.globalLives <= 0) setTimeout(() => endGame('lose'), 700);
    }

    function showMissionMap() {
        document.getElementById('current-mission-game-area').classList.add('hidden');
        document.getElementById('mission-map-screen').classList.remove('hidden');
        updateLivesDisplay();

        const mapArea = document.getElementById('map-area');
        mapArea.innerHTML = '';
        const firstUncompleted = gameConfig.missions.findIndex((_, idx) => !gameState.completedMissions.has(idx));

        gameConfig.missions.slice(0, 5).forEach((mission, index) => {
            const iconDiv = document.createElement('div');
            iconDiv.className = 'mission-map-icon';
            const pos = MISSION_POSITIONS[index];
            iconDiv.style.left = `${pos.x}%`; iconDiv.style.top = `${pos.y}%`;

            if (mission.iconUrl) {
                iconDiv.innerHTML = `<img src="${mission.iconUrl}" alt="ic"><span>${escapeHtml(mission.name)}</span>`;
            } else {
                const initials = (mission.name || '').split(' ').map(w => w[0] || '').join('').slice(0,2).toUpperCase() || 'M';
                iconDiv.innerHTML = `<div class="icon-fallback">${initials}</div><span>${escapeHtml(mission.name)}</span>`;
            }

            if (gameState.completedMissions.has(index)) iconDiv.classList.add('completed');
            else if (firstUncompleted !== -1 && index > firstUncompleted) iconDiv.classList.add('locked');
            else if (index === firstUncompleted) iconDiv.classList.add('active');

            if (!gameState.completedMissions.has(index) && (firstUncompleted === -1 || index <= firstUncompleted)) {
                iconDiv.onmouseenter = () => displayMissionDescription(mission);
                iconDiv.onmouseleave = () => document.getElementById('mission-description-panel').classList.add('hidden');
                iconDiv.onclick = () => startMission(index);
            }
            mapArea.appendChild(iconDiv);
        });
    }

    function displayMissionDescription(mission) {
        const panel = document.getElementById('mission-description-panel');
        panel.querySelector('h3').textContent = mission.name;
        typewriter(panel.querySelector('p'), mission.description || '');
        panel.classList.remove('hidden');
    }

    function startMission(missionIndex) {
        document.getElementById('mission-map-screen').classList.add('hidden');
        document.getElementById('current-mission-game-area').classList.remove('hidden');
        updateLivesDisplay();

        gameState.currentMissionIndex = missionIndex;
        gameState.currentMissionQuestions = shuffle(gameConfig.missions[missionIndex].questions.slice());
        gameState.completedCardsInMission = 0;

        const cardGrid = document.getElementById('card-grid-area');
        cardGrid.innerHTML = '';
        gameState.currentMissionQuestions.forEach((q, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.qindex = index;
            card.onclick = () => showQuestionModal(index);
            cardGrid.appendChild(card);
        });
    }

    let typeWriterTimeout;
    function typewriter(element, text, speed = 40) {
        clearTimeout(typeWriterTimeout);
        element.textContent = "";
        let i = 0;
        function type() { if (i < text.length) { element.textContent += text.charAt(i++); typeWriterTimeout = setTimeout(type, speed); } }
        type();
    }

    function showQuestionModal(qIndex) {
        const qData = gameState.currentMissionQuestions[qIndex];
        const modal = document.getElementById('question-modal-overlay');
        modal.querySelector('.card-question').textContent = qData.question;
        const content = modal.querySelector('.card-content-area');
        content.innerHTML = '';
        content.className = 'card-content-area card-answers';
        
        qData.options.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.textContent = opt;
            btn.onclick = () => handleAnswer(qIndex, i === qData.answer);
            content.appendChild(btn);
        });
        modal.classList.remove('hidden');
    }

    let audioCtx = null;
    function playTone(freq, duration=0.12, type='sine', gain=0.12) {
        try {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.type = type; o.frequency.value = freq; g.gain.value = gain;
            o.connect(g); g.connect(audioCtx.destination); o.start();
            o.stop(audioCtx.currentTime + duration);
        } catch (e) {}
    }
    function playCorrectSound() { playTone(880, 0.12, 'sine', 0.12); playTone(1320, 0.08, 'sine', 0.08); }
    function playIncorrectSound() { playTone(180, 0.14, 'sawtooth', 0.14); }
    function prepareBuiltInSounds() {}

    function handleAnswer(qIndex, isCorrect) {
        const playerImg = document.getElementById('player-char-img');
        playerImg.classList.remove('correct-answer', 'incorrect-answer');
        void playerImg.offsetWidth;
        const cardEl = document.querySelector(`.card[data-qindex="${qIndex}"]`);

        if (isCorrect) {
            playCorrectSound();
            playerImg.classList.add('correct-answer');
            if (cardEl) cardEl.classList.add('completed');
        } else {
            playIncorrectSound();
            playerImg.classList.add('incorrect-answer');
            if (cardEl) cardEl.classList.add('incorrect');
            loseLife();
        }
        document.getElementById('question-modal-overlay').classList.add('hidden');
        setTimeout(finalizeCardAfterAnswer, 400);
    }

    function finalizeCardAfterAnswer() {
        gameState.completedCardsInMission++;
        if (gameState.completedCardsInMission >= gameState.currentMissionQuestions.length) {
            completeMission(gameState.currentMissionIndex);
        }
    }

    function completeMission(missionIndex) {
        gameState.completedMissions.add(missionIndex);
        if (gameState.completedMissions.size >= gameConfig.missions.length) {
            setTimeout(() => endGame('win'), 1000);
        } else {
            setTimeout(showMissionMap, 800);
        }
    }

    function endGame(status) {
        document.getElementById('game-process').classList.add('hidden');
        const endScreen = document.getElementById('end-screen');
        endScreen.classList.remove('hidden');
        document.getElementById('end-player-img').src = gameState.character || TRANSPARENT_PNG;
        const titleKey = status === 'win' ? 'all_missions_completed' : 'game_end_lose';
        document.getElementById('end-title').textContent = translations[gameState.lang][titleKey];
    }

    function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
});
</script>
</body>
</html>
