<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Генератор интерактивных карточек</title>
    <style>
        :root{
            --bg-dark:#101820;
            --panel-bg:rgba(23,37,51,0.85);
            --accent-color:#00ffe7;
            --text-light:#e0e0e0;
            --text-dark:#333;
            --border-color:rgba(0,255,231,0.2);
            --hover-bg:rgba(0,255,231,0.05);
            --correct-color:#4ade80;
            --incorrect-color:#f87171;
            --card-bg-image: linear-gradient(45deg,#00776b,#00bfa5);
            --card-bg-color: transparent;
            --dynamic-glow-color: var(--accent-color);
            --dynamic-glow-shadow: 0 0 15px var(--dynamic-glow-color);
            /* Customizable */
            /* расширенный стек шрифтов (включая популярные кириллические) */
            --title-font: "Noto Sans", "PT Sans", "Roboto", "Inter", "Segoe UI", "Arial", sans-serif;
            --title-size: 1.8em;
            --button-size: 16px;
            --game-bg-color: transparent;
            --map-bg-image: none;
            --game-cover-image: none;
        }
        html,body{width:100%;height:100%;margin:0;padding:0;overflow:hidden;font-family:var(--title-font);}
        body{
            background-image:linear-gradient(180deg,#1a2a3a,#101820);
            color:var(--text-light);
            display:flex;justify-content:center;align-items:center;
        }
        .master-container{ width:100%; height:100%; display:flex; flex-direction:column; box-sizing:border-box; padding:12px; }
        .master-container.editor{
            width: min(1400px, 95vw);
            aspect-ratio: 16 / 9;
            height: auto;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(180deg, rgba(26,42,58,0.95), rgba(16,24,32,0.95));
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }

        .main-title{ text-align:center; color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); margin-bottom:8px; flex-shrink:0; font-family:var(--title-font); }

        button{ background-color:transparent; color:var(--accent-color); border:1px solid var(--accent-color); padding:8px 12px; border-radius:6px; cursor:pointer; font-size:var(--button-size); font-weight:bold; transition:all .25s; }
        button:hover{ background-color:var(--accent-color); color:var(--bg-dark); box-shadow:0 0 15px var(--accent-color); }
        button:disabled{ background-color:#4a5568; border-color:#4a5568; color:#a0aec0; cursor:not-allowed; box-shadow:none; }

        input,textarea,select{ width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; box-sizing:border-box; margin-top:5px; margin-bottom:10px; background-color:rgba(0,0,0,0.15); color:var(--text-light); transition:all .3s; font-size:14px; }
        input:hover,textarea:hover,select:hover,input:focus,textarea:focus,select:focus{ border-color:var(--accent-color); box-shadow:0 0 5px var(--accent-color); outline:none; }
        input[type="color"] { padding: 0; height: 40px; border-radius: 8px; cursor: pointer; }
        input[type="range"] { padding: 0; }

        #editor-wrapper{ display:flex; gap:12px; height:100%; overflow:hidden; padding:12px; box-sizing:border-box; }
        #editor-panel{ flex:1; min-width:320px; max-width: 420px; }
        /* уменьшили секцию предпросмотра */
        #preview-section{ flex:0.95; display:flex; flex-direction:column; min-width: 420px; max-width:560px; }

        .editor-panel-inner{ background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:18px; backdrop-filter:blur(8px); height:100%; box-sizing:border-box; overflow-y:auto; }
        .editor-panel-inner h2, .editor-panel-inner h3{ color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); margin:6px 0; }

        .editor-section{ margin-bottom:12px; padding:10px; border-radius:8px; border:1px solid transparent; transition:all .3s; }
        .editor-section:hover{ background-color:var(--hover-bg); border-color:var(--border-color); }

        .question-block{ background:rgba(0,0,0,0.18); padding:12px; border-radius:6px; margin-bottom:12px; border:1px solid var(--border-color); }
        .question-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .option-group{ display:flex; align-items:center; margin-bottom:8px; gap:8px; }

        .char-remove-btn-x{ position:absolute; top:-5px; right:-5px; width:22px; height:22px; border-radius:50%; background:#e53e3e; color:white; border:none; font-size:16px; font-weight:bold; display:flex; align-items:center; justify-content:center; cursor:pointer; padding:0; box-shadow:0 2px 4px rgba(0,0,0,.4); }

        /* предпросмотр iframe */
        #preview-iframe{ width:100%; flex-grow:1; border-radius:8px; border:1px solid var(--border-color); background-color:var(--bg-dark); min-height:340px; }
        #open-preview-btn{ margin-top:8px; display:none; }

        /* --- GAME STYLES --- */
        #game-container{ width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; box-sizing:border-box; background:none; }
        #start-screen{ width:100%; max-width:900px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:22px; backdrop-filter:blur(10px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; box-sizing:border-box; position:relative; background-size:cover; background-position:center; /* cover fallback */ background-image: var(--game-cover-image); background-color: var(--game-bg-color); }
        #game-title-display{ text-align:center; color:var(--accent-color); font-size:var(--title-size); margin:6px 0; text-shadow:0 0 5px var(--accent-color); font-family:var(--title-font); }
        #character-selector{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom: 8px; }
        #character-selector img{ width:80px; height:80px; border-radius:50%; border:3px solid transparent; cursor:pointer; object-fit:cover; transition:all .2s; }
        #character-selector img.selected{ border-color:var(--dynamic-glow-color); box-shadow:var(--dynamic-glow-shadow); transform:scale(1.05); }

        #game-process{ width:100%; height:100%; position:relative; padding:12px; box-sizing:border-box; display:block; background: var(--game-bg-color); background-image: var(--game-cover-image); background-size: cover; background-position: center; }
        #game-ui-top{ position:absolute; top:20px; left:20px; right:20px; display:flex; justify-content:space-between; align-items:center; z-index: 100; }
        #lives-container{ display:flex; gap:5px; font-size:1.8em; color: #ff6b6b; }

        /* map area uses map background variable (set by JS) */
        #mission-map-screen{ width:100%; height:100%; position:relative; background-image: var(--map-bg-image); background-size:cover; background-position:center; background-repeat:no-repeat; }
        #map-area { position: absolute; inset: 0; } /* icons positioned inside */

        /* New Mission Layout */
        #current-mission-game-area { display: flex; align-items: center; justify-content: space-around; gap: 12px; width: 100%; height: 100%; }
        #character-display { position: relative; flex: 1; max-width: 36%; height: 90%; display: flex; justify-content: center; align-items: flex-end; }
        #player-char-img{ max-width:100%; max-height:100%; object-fit: contain; transition:transform .3s ease, filter .3s ease; }
        #player-char-img.correct-answer{ animation:jump-animation .6s ease; filter: drop-shadow(var(--dynamic-glow-shadow)); }
        #player-char-img.incorrect-answer{ animation:shake-animation .6s ease; filter: drop-shadow(0 0 15px var(--incorrect-color)); }

        #card-grid-area{ position: relative; flex: 1.5; max-width: 60%; height: 90%; overflow-y: auto; display:flex; flex-wrap: wrap; gap:12px; padding:12px; background:rgba(0,0,0,0.25); border-radius:8px; align-content: flex-start; justify-content: center; }
        .card{ width: 90px; height: 90px; /* квадрат для круглой формы */ background-image: var(--card-bg-image); background-color: var(--card-bg-color); background-size: cover; background-position: center; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.6em; font-weight:bold; cursor:pointer; transition: all 0.3s ease; box-shadow:0 5px 15px rgba(0,0,0,.3); position: relative; }
        .card:hover{ transform: translateY(-5px); box-shadow: 0 8px 20px var(--dynamic-glow-color); }
        .card.completed{ background: var(--correct-color); cursor: not-allowed; opacity: 0.8; pointer-events: none; }
        .card.completed::after { content: '✔'; font-size: 1.6em; color: white; position: absolute; }
        .card.incorrect { background: var(--incorrect-color); cursor: not-allowed; opacity: 0.85; pointer-events: none; }
        .card.incorrect::after { content: '✖'; font-size: 1.6em; color: white; position: absolute; }

        #question-modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter: blur(5px); display:flex; align-items:center; justify-content:center; z-index: 2000; }
        #question-modal-content{ background-color:#e0e0e0; color:var(--text-dark); padding:24px; border-radius:12px; min-width: 320px; max-width: 90vw; }
        .card-question{ font-size:1.1em; font-weight:bold; margin-bottom:12px; font-family:var(--title-font); }
        .card-answers button, .card-input-area button{ width:100%; margin-bottom:10px; background-color:#f1f5f9; color:var(--text-dark); border:1px solid #ccc; text-align:left; padding:10px; font-size:14px; font-family:var(--title-font); }
        .card-input-area input{ font-family:var(--title-font); padding:8px; margin-bottom:8px; width:100%; box-sizing:border-box; }

        /* mission icons (bigger) */
        .mission-map-icon { position: absolute; display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: transform 0.25s ease; z-index: 20; transform: translate(-50%, -50%); }
        .mission-map-icon img { width: 110px; height: 110px; object-fit: cover; border-radius: 50%; border: 4px solid var(--dynamic-glow-color); }
        .mission-map-icon .icon-fallback { width:110px; height:110px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.06); border:4px solid var(--dynamic-glow-color); color:white; font-weight:bold; font-size:28px; }
        .mission-map-icon span { font-size: 1em; color: white; text-shadow: 0 0 5px black; background: rgba(0,0,0,0.45); padding: 6px 12px; border-radius: 8px; }
        .mission-map-icon:not(.locked):hover { transform: scale(1.12) translate(-50%, -50%); }
        .mission-map-icon.active { animation: pulse-animation 1.5s ease-in-out infinite; }
        .mission-map-icon.completed { filter: grayscale(100%) brightness(0.75); opacity: 0.85; pointer-events: none; }
        .mission-map-icon.locked { pointer-events: none; filter: grayscale(80%) brightness(0.6); opacity: 0.7; }

        #mission-description-panel { position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%); background-color: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px 16px; max-width: 80%; text-align: center; z-index: 60; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.25s ease; }
        #mission-description-panel:not(.hidden) { opacity: 1; visibility: visible; }
        #mission-description-panel h3 { margin-top: 0; color: var(--accent-color); font-size:1.05em; }
        #mission-description-panel p { margin-bottom: 0; min-height: 1.2em; }

        #end-screen{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; width:100%; max-width:900px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:22px; box-sizing:border-box; }
        #end-screen .end-player{ width:45%; max-width:320px; height:auto; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
        #end-player-img{ width:100%; height:auto; object-fit:contain; display:block; }

        .hidden{ display:none !important; }

        @keyframes jump-animation{ 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-20px);} }
        @keyframes shake-animation{ 0%,100%{ transform:translateX(0);} 25%{ transform:translateX(-8px) rotate(-2deg);} 75%{ transform:translateX(8px) rotate(2deg);} }
        @keyframes fade-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(1.4); } }
        @keyframes pulse-animation { 0% { box-shadow: var(--dynamic-glow-shadow); } 50% { box-shadow: 0 0 25px var(--dynamic-glow-color); } -selector img{ width:56px;height:56px;}
            .card{ width:76px;height:76px;}
            .mission-map-icon img, .mission-map-icon .icon-fallback { width:80px;height:80px;font-size:18px;border-width:3px;}
        }
    </style>
</head>
<body>
    <div class="master-container">
        <h1 class="main-title">Генератор интерактивных карточек</h1>

        <div id="editor-wrapper">
            <div id="editor-panel">
                <div class="editor-panel-inner">
                    <div class="editor-section">
                        <h2 data-lang-key="editor_title_game">1. Название игры</h2>
                        <input type="text" id="game-title" value="Проверь свои знания!">
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_lang_heading">2. Язык интерфейса</h2>
                        <select id="language-select">
                            <option value="ru">Русский</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_map_heading">3. Карта / Обложка</h2>
                        <label for="map-bg-upload" data-lang-key="editor_upload_map_bg">Фон карты (отдельно)</label>
                        <input type="file" id="map-bg-upload" accept="image/*">
                        <label for="cover-upload">Обложка (единый фон для всей игры)</label>
                        < s.trim()).filter(Boolean);
        const result = [];
        blocks.forEach(block => {
            const lines = block.split('\n').map(l => l.trim()).filter(Boolean);
            if (lines.length < 2) return; // need at least question + 1 answer
            const question
