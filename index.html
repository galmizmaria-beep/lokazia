<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</title>
    <style>
        :root {
            --bg-dark: #101820; --panel-bg: rgba(23, 37, 51, 0.85); --accent-color: #00ffe7; --text-light: #e0e0e0;
            --text-dark: #333; --border-color: rgba(0, 255, 231, 0.2); --hover-bg: rgba(0, 255, 231, 0.05);
        }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-image: linear-gradient(180deg, #1a2a3a, #101820); color: var(--text-light);
            display: flex; justify-content: center; align-items: center;
        }
        .master-container { width: 95vw; max-width: 1400px; height: calc(95vw * 9 / 16); max-height: 95vh; display: flex; flex-direction: column; }
        .main-title { text-align: center; color: var(--accent-color); text-shadow: 0 0 5px var(--accent-color); margin-bottom: 20px; flex-shrink: 0; }
        button {
            background-color: transparent; color: var(--accent-color); border: 1px solid var(--accent-color); padding: 10px 15px;
            border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s;
        }
        button:hover { background-color: var(--accent-color); color: var(--bg-dark); box-shadow: 0 0 15px var(--accent-color); }
        button:disabled { background-color: #4a5568; border-color: #4a5568; color: #a0aec0; cursor: not-allowed; box-shadow: none; }
        input, textarea, select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box;
            margin-top: 5px; margin-bottom: 10px; background-color: rgba(0,0,0,0.2); color: var(--text-light); transition: all 0.3s;
        }
        input:hover, textarea:hover, select:hover, input:focus, textarea:focus, select:focus { border-color: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); outline: none; }
        #editor-wrapper { display: flex; gap: 20px; height: 100%; overflow: hidden; }
        #editor-panel { flex: 1; min-width: 350px; }
        #preview-section { flex: 1.5; display: flex; flex-direction: column; }
        .editor-panel-inner {
            background-color: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px;
            backdrop-filter: blur(10px); height: 100%; box-sizing: border-box; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--accent-color) transparent;
        }
        .editor-panel-inner h2 { color: var(--accent-color); text-shadow: 0 0 5px var(--accent-color); }
        .editor-section { margin-bottom: 15px; padding: 10px; border-radius: 8px; border: 1px solid transparent; transition: all 0.3s; }
        .editor-section:hover { background-color: var(--hover-bg); border-color: var(--border-color); }
        .question-block { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .option-group { display: flex; align-items: center; margin-bottom: 8px; }
        .option-group input[type="radio"] { width: auto; margin-right: 10px; margin-top: 0; }
        .character-upload-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; position: relative; }
        .character-upload-group img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .character-upload-group input[type="file"] { display: none; }
        .character-upload-group label { background-color: #4a5568; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; text-align: center; flex-grow: 1; }
        .char-remove-btn {
            position: absolute; top: -5px; right: -5px; width: 22px; height: 22px; background-color: #e53e3e; color: white;
            border: none; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; line-height: 1;
        }
        .question-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .remove-btn { border-color: #e53e3e; color: #e53e3e; }
        .remove-btn:hover { background-color: #e53e3e; color: white; box-shadow: 0 0 15px #e53e3e;}
        #preview-iframe { width: 100%; flex-grow: 1; border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--bg-dark); }
        #generate-code-wrapper { margin-top: 20px; }
        #iframe-code { display: none; margin-top: 10px; min-height: 100px; font-size: 12px; white-space: pre; }
        .timer-options { display: flex; align-items: center; gap: 10px; }
        .timer-options input[type=checkbox] { width: auto; }
        
        /* --- –°–¢–ò–õ–ò –ò–ì–†–´ --- */
        body.game-mode { background: transparent; }
        #game-container { width: 100%; height: 100%; text-align: center; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 20px; box-sizing: border-box; }
        #hud { display: flex; justify-content: space-between; width: 100%; color: white; font-size: 2em; font-weight: bold; }
        #lives-display { display: flex; gap: 5px; }
        #lives-display span { transition: all 0.3s; }
        #lives-display span.lost { animation: life-lost-blink 0.5s ease-in-out; }
        @keyframes life-lost-blink { 50% { transform: scale(1.5); opacity: 0.5; filter: drop-shadow(0 0 5px #ff0000); } }
        #timer-display { text-shadow: 0 0 5px var(--accent-color); }
        #card-stack-area { position: relative; perspective: 1000px; width: 350px; height: 500px; }
        .card {
            position: absolute; width: 100%; height: 100%; transform-style: preserve-3d; transition: all 0.6s ease;
            cursor: pointer; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        .card.swiped-away { transform: translate(150%, -50%) rotate(30deg) !important; opacity: 0; }
        .card.flipped { transform: rotateY(180deg); cursor: default; }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column;
            justify-content: center; align-items: center; border-radius: 20px; overflow: auto;
        }
        .card-front { background: linear-gradient(45deg, #00776b, #00bfa5); color: white; font-size: 3em; }
        .card-back {
            background-color: #e0e0e0; color: var(--text-dark); transform: rotateY(180deg); padding: 20px;
            box-sizing: border-box; text-align: left; justify-content: flex-start;
        }
        .card-question { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; }
        .card-answers button, .card-input-area button { width: 100%; margin-bottom: 10px; background-color: #f1f5f9; color: var(--text-dark); border: 1px solid #ccc; text-align: left; }
        .card-answers button:hover:not(:disabled) { background-color: #e2e8f0; }
        .card-answers button.correct, .card-input-area button.correct { background-color: #4ade80 !important; border-color: #38a169 !important; color: white; }
        .card-answers button.incorrect, .card-input-area button.incorrect { background-color: #f87171 !important; border-color: #c53030 !important; color: white; }
        #end-screen h2 { font-size: 2.5em; color: var(--accent-color); }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="master-container">
        <h1 class="main-title" data-translate-key="mainTitle">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</h1>
        <div id="editor-wrapper">
            <div id="editor-panel">
                <div class="editor-panel-inner">
                    <div class="editor-section">
                        <h2>1. <span data-translate-key="langSettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–∞</span></h2>
                        <select id="language-select">
                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div class="editor-section">
                        <h2 data-translate-key="gameTitleHeader">2. –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</h2>
                        <input type="text" id="game-title" value="–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è!" data-translate-key="gameTitlePlaceholder" data-translate-type="placeholder">
                    </div>
                    <div class="editor-section">
                        <h2 data-translate-key="charactersHeader">3. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
                        <div id="characters-container"></div>
                        <button id="add-character-btn" data-translate-key="addCharacter">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                    </div>
                    <div class="editor-section">
                        <h2 data-translate-key="gameplayHeader">4. –ì–µ–π–º–ø–ª–µ–π</h2>
                        <label for="card-count" data-translate-key="cardCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∏–≥—Ä–µ:</label>
                        <input type="number" id="card-count" value="5" min="1">
                        <label data-translate-key="timerHeader">–¢–∞–π–º–µ—Ä</label>
                        <div class="timer-options">
                            <input type="checkbox" id="timer-enabled">
                            <label for="timer-enabled" data-translate-key="timerEnable">–í–∫–ª—é—á–∏—Ç—å</label>
                            <input type="number" id="timer-duration" value="60" min="1" placeholder="—Å–µ–∫." style="flex-grow:1;">
                        </div>
                    </div>
                    <div class="editor-section">
                        <h2 data-translate-key="tasksHeader">5. –ó–∞–¥–∞–Ω–∏—è</h2>
                        <div id="questions-container"></div>
                        <button id="add-question-btn" data-translate-key="addQuestion">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                    </div>
                </div>
            </div>
            <div id="preview-section">
                <iframe id="preview-iframe"></iframe>
                <div id="generate-code-wrapper">
                    <button id="generate-code-btn" data-translate-key="generateCode">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                    <textarea id="iframe-code"></textarea>
                </div>
            </div>
        </div>
        <div id="game-container" class="hidden">
            <div id="hud">
                <div id="lives-display"></div>
                <div id="timer-display"></div>
            </div>
            <div id="card-stack-area"></div>
            <div id="end-screen" class="hidden">
                <h2 id="end-title" data-translate-key="gameFinished">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
                <button onclick="window.location.reload()" data-translate-key="playAgain">–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const TRANSLATIONS = {
            ru: {
                mainTitle: "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫", langSettings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–∞", gameTitleHeader: "2. –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã",
                gameTitlePlaceholder: "–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è!", charactersHeader: "3. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏", addCharacter: "–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞",
                gameplayHeader: "4. –ì–µ–π–º–ø–ª–µ–π", cardCount: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∏–≥—Ä–µ:", timerHeader: "–¢–∞–π–º–µ—Ä",
                timerEnable: "–í–∫–ª—é—á–∏—Ç—å", tasksHeader: "5. –ó–∞–¥–∞–Ω–∏—è", addQuestion: "–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å", generateCode: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥",
                copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å", copied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!", upload: "–ó–∞–≥—Ä—É–∑–∏—Ç—å...", question: "–í–æ–ø—Ä–æ—Å", typeSelect: "–¢–∏–ø",
                mcOption: "–û–¥–∏–Ω –∏–∑ –º–Ω–æ–≥–∏—Ö", textOption: "–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞", mcPlaceholder: "–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞", textPlaceholder: "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç",
                addOption: "–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç", removeQuestion: "–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å", selectCharacter: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞",
                startGame: "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!", gameFinished: "–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!", playAgain: "–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑", outOfLives: "–ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∂–∏–∑–Ω–∏!", timeIsUp: "–í—Ä–µ–º—è –≤—ã—à–ª–æ!",
                youWon: "–û—Ç–ª–∏—á–Ω–æ! –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∏–≥—Ä—É!", check: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å"
            },
            en: {
                mainTitle: "Interactive Card Generator", langSettings: "Language Settings", gameTitleHeader: "2. Game Title",
                gameTitlePlaceholder: "Test your knowledge!", charactersHeader: "3. Characters", addCharacter: "Add Character",
                gameplayHeader: "4. Gameplay", cardCount: "Number of cards in game:", timerHeader: "Timer",
                timerEnable: "Enable", tasksHeader: "5. Tasks", addQuestion: "Add Question", generateCode: "Generate Code",
                copy: "Copy", copied: "Copied!", upload: "Upload...", question: "Question", typeSelect: "Type",
                mcOption: "Multiple Choice", textOption: "Text Input", mcPlaceholder: "Answer option", textPlaceholder: "Correct answer",
                addOption: "Add Option", removeQuestion: "Remove question", selectCharacter: "Select a character",
                startGame: "Start Game!", gameFinished: "Game Over!", playAgain: "Play Again", outOfLives: "Out of lives!", timeIsUp: "Time is up!",
                youWon: "Great! You have completed the game!", check: "Check"
            }
        };
        const urlParams = new URLSearchParams(window.location.search);
        const isPlayerMode = urlParams.get('mode') === 'player';
        let characterDataUrls = [];
        let isCodeGenerated = false;

        const translateUI = (lang) => {
            const dict = TRANSLATIONS[lang];
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                const type = el.dataset.translateType || 'textContent';
                if (dict[key]) el[type] = dict[key];
            });
        };
        
        if (isPlayerMode) {
            document.getElementById('editor-wrapper').style.display = 'none';
            document.querySelector('.main-title').style.display = 'none';
            document.body.classList.add('game-mode');
            document.getElementById('game-container').classList.remove('hidden');
            
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'gameConfig') {
                    initGame(event.data.config);
                }
            });
        } else {
            initEditor();
        }

        function initEditor() {
            document.getElementById('add-character-btn').addEventListener('click', addCharacterInput);
            document.getElementById('add-question-btn').addEventListener('click', addQuestionBlock);
            document.getElementById('generate-code-btn').addEventListener('click', handleGenerateCodeClick);
            document.getElementById('editor-panel').addEventListener('input', updatePreview);
            document.getElementById('language-select').addEventListener('change', (e) => {
                translateUI(e.target.value);
                updatePreview();
            });
            
            const previewIframe = document.getElementById('preview-iframe');
            previewIframe.src = `${window.location.pathname}?mode=player`;
            previewIframe.onload = () => updatePreview();
            
            translateUI('ru');
            addCharacterInput();
            addQuestionBlock();
        }
        
        async function collectConfig() {
            return {
                lang: document.getElementById('language-select').value,
                title: document.getElementById('game-title').value,
                characters: characterDataUrls.filter(Boolean),
                cardCount: parseInt(document.getElementById('card-count').value) || 5,
                timer: {
                    enabled: document.getElementById('timer-enabled').checked,
                    duration: parseInt(document.getElementById('timer-duration').value) || 60
                },
                questions: Array.from(document.querySelectorAll('.question-block')).map(block => {
                    const questionType = block.querySelector('.question-type-select').value;
                    const question = { type: questionType, question: block.querySelector('.question-text').value };
                    if (questionType === 'multiple-choice') {
                        question.options = Array.from(block.querySelectorAll('.option-text')).map(input => input.value);
                        const correctInput = block.querySelector('input[type="radio"]:checked');
                        question.answer = correctInput ? parseInt(correctInput.value) : 0;
                    } else if (questionType === 'text-input') {
                        question.answer = block.querySelector('.text-answer-input').value;
                    }
                    return question;
                }).filter(q => q.question)
            };
        }

        async function updatePreview() {
            const config = await collectConfig();
            const previewIframe = document.getElementById('preview-iframe');
            if (previewIframe.contentWindow) {
                previewIframe.contentWindow.postMessage({ type: 'gameConfig', config }, '*');
            }
            isCodeGenerated = false;
            document.getElementById('generate-code-btn').textContent = TRANSLATIONS[config.lang].generateCode;
        }

        async function handleGenerateCodeClick() {
            const config = await collectConfig();
            const codeTextarea = document.getElementById('iframe-code');
            const btn = document.getElementById('generate-code-btn');
            
            if (!isCodeGenerated) {
                const gameUrl = `${window.location.origin}${window.location.pathname}?mode=player`;
                const configString = JSON.stringify(config);

                codeTextarea.value = 
`<!-- Genially Animation & Sound Code. Paste into 'Others' tab -->
<!-- IMPORTANT: Give your character image in Genially the name 'game_character' -->
<style>
    @keyframes jump-glow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    .char-correct { animation: jump-glow 0.5s ease-in-out; filter: drop-shadow(0 0 15px #0f0) drop-shadow(0 0 5px #fff); }
    @keyframes shake-glow { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    .char-incorrect { animation: shake-glow 0.5s ease-in-out; filter: drop-shadow(0 0 15px #f00) drop-shadow(0 0 5px #fff); }
</style>
<div style="position: relative; width: 100%; height: 100%;">
    <iframe id="game-iframe-123" src="${gameUrl}" frameborder="0" allowtransparency="true" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent;"></iframe>
</div>
<script>
    (function() {
        var iframe = document.getElementById('game-iframe-123');
        var gameConfig = ${configString};
        var char = document.querySelector('[data-id-genial="game_character"], #game_character');
        var successSound = new Audio("data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjM0LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAA//uQJAnwAANEgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJBsMAAADYgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJCAEAAADUgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJCEwAAADdgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJCgEAAADhAQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJCoMAAADpAQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJDAMAAADxAQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJDEwAAAD9AQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJDoEAAAEJgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJDwMAAAEWgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJEAwAAAFlgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJEUEAAAFtgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJEgEAAAF1gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJEsMAAAGIgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJFAwAAAGagQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJFQEAAAG5gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJFUEAAAHNgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJFgMAAAHlgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJFwEAAAH6gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJGAEAAAIIgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJGMEAAAIlgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJGQEAAAI0gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJGgMAAAJRgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJHAwAAAJxgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJHQEAAAKHgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJHUEAAAKdgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJHcEAAAKvgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJIEMAAALGgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJIEwAAALcgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJIgEAAALvgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJIoEAAAMHgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJIwEAAAMYgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJJAEAAAMwgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJJMwAAANcgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJJcEAAAN3gQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJKAEAAAN/gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJKMEAAAOQgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJKgMAAAOkgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJK4EAAAO8gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJLAEAAAPLgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJLMwAAAPkgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJLsEAAAQCgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJMAEAAAQegQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJMMwAAARAgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJMgEAAARZgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJMwMAAARvgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNAMAAAR/gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNEwAAASRgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNQEAAASggQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNYMAAAS3gQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNsEAAAS+gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNwEAAATGgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJOMQAAATbgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJOYMAAAUHgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJOoMAAAUagQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJO8MAAAU1gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJPEwAAAU+gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJPYMAAAWNgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJPYEAAAWUgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//u√°");
        var failSound = new Audio("data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjM0LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAA//uQJAnwAANEgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJBsMAAADYgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJCAEAAADUgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJCEwAAADdgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJCgEAAADhAQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJCoMAAADpAQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJDAMAAADxAQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJDEwAAAD9AQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJDoEAAAEJgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJDwMAAAEWgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJEAwAAAFlgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJEUEAAAFtgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJEgEAAAF1gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJEsMAAAGIgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJFAwAAAGagQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJFQEAAAG5gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJFUEAAAHNgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJFgMAAAHlgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJFwEAAAH6gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJGAEAAAIIgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJGMEAAAIlgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJGQEAAAI0gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJGgMAAAJRgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJHAwAAAJxgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJHQEAAAKHgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJHUEAAAKdgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJHcEAAAKvgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJIEMAAALGgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJIEwAAALcgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJIgEAAALvgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJIoEAAAMHgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJIwEAAAMYgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJJAEAAAMwgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJJMwAAANcgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJJcEAAAN3gQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJKAEAAAN/gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJKMEAAAOQgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJKgMAAAOkgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJK4EAAAO8gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJLAEAAAPLgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJLMwAAAPkgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJLsEAAAQCgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJMAEAAAQegQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJMMwAAARAgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJMgEAAARZgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJMwMAAARvgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNAMAAAR/gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNEwAAASRgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNQEAAASggQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNYMAAAS3gQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNsEAAAS+gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJNwEAAATGgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJOMQAAATbgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJOYMAAAUHgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJOoMAAAUagQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJO8MAAAU1gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJPEwAAAU+gQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJPYMAAAWNgQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJPYEAAAWUgQADAAADQAIABVkQgAAVaAwAAqsAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQJAAAAAwAAAC5gQADAAADQAIABVkQgAAVaBwAAqgAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg//uQIAAEAAADsYQADAAADQAIABVkQgAAVaBQAAqcAAAAqgAAAAagAAAApAAAAVgAAAFAAABWAAAAUAAAAADg");
        iframe.onload = function() { iframe.contentWindow.postMessage({ type: 'gameConfig', config: gameConfig }, '*'); };
        window.addEventListener('message', function(event) {
            if (event.source !== iframe.contentWindow || !char) return;
            if (event.data.type === 'answerResult') {
                var animClass = event.data.result === 'correct' ? 'char-correct' : 'char-incorrect';
                if (event.data.result === 'correct') successSound.play(); else failSound.play();
                char.classList.add(animClass);
                setTimeout(function() { char.classList.remove(animClass); }, 500);
            }
        });
    })();
<\/script>`;
                codeTextarea.style.display = 'block';
                btn.textContent = TRANSLATIONS[config.lang].copy;
                isCodeGenerated = true;
            } else {
                codeTextarea.select();
                navigator.clipboard.writeText(codeTextarea.value).then(() => {
                    btn.textContent = TRANSLATIONS[config.lang].copied;
                    setTimeout(() => { btn.textContent = TRANSLATIONS[config.lang].copy; }, 2000);
                });
            }
        }
        
        function addCharacterInput() {
            const container = document.getElementById('characters-container');
            const index = Date.now();
            const group = document.createElement('div');
            group.className = 'character-upload-group';
            group.innerHTML = `
                <button type="button" class="char-remove-btn">√ó</button>
                <img src="https://placehold.co/40x40/101820/00ffe7?text=+" alt="preview" id="char-preview-${index}">
                <input type="file" id="char-upload-${index}" accept="image/*">
                <label for="char-upload-${index}" data-translate-key="upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å...</label>`;
            container.appendChild(group);
            characterDataUrls.push({id: index, data: null});

            group.querySelector('.char-remove-btn').onclick = () => {
                characterDataUrls = characterDataUrls.filter(c => c.id !== index);
                group.remove(); updatePreview();
            };
            document.getElementById(`char-upload-${index}`).addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById(`char-preview-${index}`).src = e.target.result;
                        const char = characterDataUrls.find(c => c.id === index);
                        if(char) char.data = e.target.result;
                        updatePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
            translateUI(document.getElementById('language-select').value);
        }
        
        function addQuestionBlock() {
            const container = document.getElementById('questions-container');
            const qIndex = Date.now();
            const block = document.createElement('div');
            block.className = 'question-block';
            block.innerHTML = `
                <h4 data-translate-key="question">${TRANSLATIONS.ru.question} ${container.children.length + 1}</h4>
                <select class="question-type-select"><option value="multiple-choice" data-translate-key="mcOption">${TRANSLATIONS.ru.mcOption}</option><option value="text-input" data-translate-key="textOption">${TRANSLATIONS.ru.textOption}</option></select>
                <textarea class="question-text" placeholder="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞..."></textarea>
                <div class="question-type-wrapper multiple-choice"><div class="options-container"></div></div>
                <div class="question-type-wrapper text-input hidden"><input type="text" class="text-answer-input" placeholder="${TRANSLATIONS.ru.textPlaceholder}"></div>
                <div class="question-buttons">
                    <button type="button" class="add-option-btn" data-translate-key="addOption">${TRANSLATIONS.ru.addOption}</button>
                    <button type="button" class="remove-question-btn remove-btn" data-translate-key="removeQuestion">${TRANSLATIONS.ru.removeQuestion}</button>
                </div>`;
            container.appendChild(block);
            
            const typeSelect = block.querySelector('.question-type-select');
            const mcWrapper = block.querySelector('.multiple-choice');
            const textWrapper = block.querySelector('.text-input');
            const addOptionBtn = block.querySelector('.add-option-btn');
            
            typeSelect.addEventListener('change', () => {
                const isMc = typeSelect.value === 'multiple-choice';
                mcWrapper.classList.toggle('hidden', !isMc); addOptionBtn.style.display = isMc ? '' : 'none';
                textWrapper.classList.toggle('hidden', isMc); updatePreview();
            });

            addOption(block.querySelector('.options-container'), qIndex); addOption(block.querySelector('.options-container'), qIndex);
            block.querySelector('input[type="radio"]').checked = true;
            addOptionBtn.onclick = () => addOption(block.querySelector('.options-container'), qIndex);
            block.querySelector('.remove-question-btn').onclick = () => { block.remove(); updatePreview(); };
            translateUI(document.getElementById('language-select').value);
        }
        
        function addOption(container, qIndex) {
            const optionIndex = container.children.length;
            const group = document.createElement('div');
            group.className = 'option-group';
            group.innerHTML = `<input type="radio" name="correct_q${qIndex}" value="${optionIndex}"><input type="text" class="option-text" placeholder="${TRANSLATIONS[document.getElementById('language-select').value].mcPlaceholder} ${optionIndex + 1}">`;
            container.appendChild(group);
        }
        
        // ======================= –õ–û–ì–ò–ö–ê –ò–ì–†–´ =======================
        let gameConfig = {}; let gameState = { character: '', lives: 5, timerId: null };
        
        function initGame(config) {
            gameConfig = config; translateUI(gameConfig.lang);
            const startScreen = document.createElement('div');
            startScreen.className = 'game-frame';
            startScreen.innerHTML = `<h2 data-translate-key="selectCharacter">${TRANSLATIONS[gameConfig.lang].selectCharacter}</h2><div id="character-selector"></div><button id="start-game-btn" disabled data-translate-key="startGame">${TRANSLATIONS[gameConfig.lang].startGame}</button>`;
            document.getElementById('game-container').insertBefore(startScreen, document.getElementById('card-stack-area'));
            
            const charSelector = startScreen.querySelector('#character-selector');
            gameConfig.characters.forEach(url => {
                const img = document.createElement('img'); img.src = url;
                img.onclick = () => {
                    charSelector.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
                    img.classList.add('selected'); gameState.character = url;
                    startScreen.querySelector('#start-game-btn').disabled = false;
                };
                charSelector.appendChild(img);
            });
            startScreen.querySelector('#start-game-btn').onclick = () => {
                startScreen.remove(); startGame();
            };
        }
        
        function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

        function startGame() {
            gameState.lives = 5; updateLives();
            const questions = shuffle([...gameConfig.questions]).slice(0, gameConfig.cardCount);
            if(gameConfig.timer.enabled) {
                let timeLeft = gameConfig.timer.duration;
                const timerEl = document.getElementById('timer-display');
                const updateTimer = () => {
                    timerEl.textContent = `${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}`;
                    if(timeLeft-- <= 0) endGame(TRANSLATIONS[gameConfig.lang].timeIsUp);
                };
                updateTimer();
                gameState.timerId = setInterval(updateTimer, 1000);
            }
            const stackArea = document.getElementById('card-stack-area');
            stackArea.innerHTML = '';
            gameState.currentCardIndex = 0;
            const reversedQuestions = [...questions].reverse();
            reversedQuestions.forEach((q, index) => {
                const card = createCardElement(q, questions.length - 1 - index, questions);
                const offset = index * 4; card.style.transform = `translateX(${offset}px) translateY(${offset}px)`;
                stackArea.appendChild(card);
            });
        }

        function createCardElement(qData, index, questions) {
            const card = document.createElement('div'); card.className = 'card'; card.dataset.index = index;
            card.innerHTML = `<div class="card-face card-front"></div><div class="card-face card-back"><div class="card-question">${qData.question}</div><div class="card-content"></div></div>`;
            const content = card.querySelector('.card-content');
            if (qData.type === 'multiple-choice') {
                content.classList.add('card-answers');
                qData.options.forEach((opt, optIndex) => {
                    const btn = document.createElement('button'); btn.textContent = opt;
                    btn.onclick = () => checkAnswer(optIndex === qData.answer, btn, questions); content.appendChild(btn);
                });
            } else if (qData.type === 'text-input') {
                content.classList.add('card-input-area');
                const input = document.createElement('input'); input.type = 'text'; input.placeholder = '...';
                const btn = document.createElement('button'); btn.textContent = TRANSLATIONS[gameConfig.lang].check;
                btn.onclick = () => checkAnswer(input.value.trim().toLowerCase() === qData.answer.trim().toLowerCase(), btn, questions);
                content.appendChild(input); content.appendChild(btn);
            }
            card.addEventListener('click', (e) => { if (!card.classList.contains('flipped') && e.target.closest('.card-front')) card.classList.add('flipped'); }, { capture: true });
            return card;
        }
        
        function updateLives() {
            const livesEl = document.getElementById('lives-display'); livesEl.innerHTML = '';
            for(let i=0; i<5; i++) livesEl.innerHTML += `<span>${i < gameState.lives ? '‚ù§Ô∏è' : 'üñ§'}</span>`;
        }

        function checkAnswer(isCorrect, button, questions) {
            const cardBack = button.closest('.card-back');
            cardBack.querySelectorAll('button, input').forEach(el => el.disabled = true);
            window.parent.postMessage({ type: 'answerResult', result: isCorrect ? 'correct' : 'incorrect' }, '*');
            
            button.classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) {
                gameState.lives--;
                const lifeSpans = document.getElementById('lives-display').children;
                if(lifeSpans[gameState.lives]) lifeSpans[gameState.lives].classList.add('lost');
                setTimeout(updateLives, 500);

                if (button.closest('.card-answers')) {
                    const correctButton = cardBack.querySelectorAll('button')[questions[gameState.currentCardIndex].answer];
                    if (correctButton) correctButton.classList.add('correct');
                }
            }
            if (gameState.lives > 0) setTimeout(() => nextCard(questions), 2000);
            else endGame(TRANSLATIONS[gameConfig.lang].outOfLives);
        }
        
        function nextCard(questions) {
            const stackArea = document.getElementById('card-stack-area');
            const currentCard = stackArea.querySelector(`.card[data-index="${gameState.currentCardIndex}"]`);
            if (currentCard) currentCard.classList.add('swiped-away');
            gameState.currentCardIndex++;
            if (gameState.currentCardIndex >= questions.length) {
                endGame(TRANSLATIONS[gameConfig.lang].youWon);
            }
        }
        
        function endGame(message) {
            clearInterval(gameState.timerId);
            document.getElementById('card-stack-area').innerHTML = '';
            const endScreen = document.getElementById('end-screen');
            endScreen.classList.remove('hidden');
            endScreen.querySelector('#end-title').textContent = message;
        }
    });
    </script>
</body>
</html>
