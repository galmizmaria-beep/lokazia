<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</title>
    <style>
        :root{
            --bg-dark:#101820;
            --panel-bg:rgba(23,37,51,0.85);
            --accent-color:#00ffe7;
            --text-light:#e0e0e0;
            --text-dark:#333;
            --border-color:rgba(0,255,231,0.2);
            --hover-bg:rgba(0,255,231,0.05);
            --correct-color:#4ade80;
            --incorrect-color:#f87171;
        }
        html,body{width:100%;height:100%;margin:0;padding:0;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;}
        body{
            background-image:linear-gradient(180deg,#1a2a3a,#101820);
            color:var(--text-light);
            display:flex;justify-content:center;align-items:center;
        }
        .master-container{
            width:95vw;max-width:1400px;height:calc(95vw * 9 / 16);max-height:95vh;display:flex;flex-direction:column;
        }
        .main-title{ text-align:center; color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); margin-bottom:20px; flex-shrink:0; }

        button{ background-color:transparent; color:var(--accent-color); border:1px solid var(--accent-color); padding:10px 15px; border-radius:6px; cursor:pointer; font-size:16px; font-weight:bold; transition:all .3s; }
        button:hover{ background-color:var(--accent-color); color:var(--bg-dark); box-shadow:0 0 15px var(--accent-color); }
        button:disabled{ background-color:#4a5568; border-color:#4a5568; color:#a0aec0; cursor:not-allowed; box-shadow:none; }

        input,textarea,select{ width:100%; padding:10px; border:1px solid var(--border-color); border-radius:4px; box-sizing:border-box; margin-top:5px; margin-bottom:10px; background-color:rgba(0,0,0,0.2); color:var(--text-light); transition:all .3s; }
        input:hover,textarea:hover,select:hover,input:focus,textarea:focus,select:focus{ border-color:var(--accent-color); box-shadow:0 0 5px var(--accent-color); outline:none; }

        #editor-wrapper{ display:flex; gap:20px; height:100%; overflow:hidden; }
        #editor-panel{ flex:1; min-width:350px; }
        #preview-section{ flex:1.5; display:flex; flex-direction:column; }

        .editor-panel-inner{ background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:25px; backdrop-filter:blur(10px); height:100%; box-sizing:border-box; overflow-y:auto; }
        .editor-panel-inner h2{ color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); }

        .editor-section{ margin-bottom:15px; padding:10px; border-radius:8px; border:1px solid transparent; transition:all .3s; }
        .editor-section:hover{ background-color:var(--hover-bg); border-color:var(--border-color); }

        .question-block{ background:rgba(0,0,0,0.2); padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid var(--border-color); }
        .question-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .question-header h4{ margin:0; font-size:1.1em; }
        .question-actions .icon-btn{ background:none; border:none; color:var(--text-light); font-size:20px; cursor:pointer; padding:2px 5px; opacity:0.7; }
        .question-actions .icon-btn:hover{ opacity:1; color:var(--accent-color); }
        .question-actions .icon-btn.edit-btn{ cursor:not-allowed; opacity:0.3; }

        .option-group{ display:flex; align-items:center; margin-bottom:8px; }
        .character-upload-group{ display:flex; align-items:center; gap:10px; margin-bottom:15px; position:relative; }
        .character-upload-group img{ width:40px;height:40px;border-radius:50%;object-fit:cover; }
        .character-upload-group input[type="file"]{ display:none; }
        .character-upload-group label{ background-color:#4a5568; color:white; padding:8px 12px; border-radius:5px; cursor:pointer; text-align:center; flex-grow:1; }

        .char-remove-btn-x{ position:absolute; top:-5px; right:-5px; width:22px; height:22px; border-radius:50%; background:#e53e3e; color:white; border:none; font-size:16px; font-weight:bold; display:flex; align-items:center; justify-content:center; cursor:pointer; padding:0; box-shadow:0 2px 4px rgba(0,0,0,.4); }

        #preview-iframe{ width:100%; flex-grow:1; border-radius:12px; border:1px solid var(--border-color); background-color:var(--bg-dark); }
        #iframe-code{ display:none; margin-top:10px; min-height:80px; font-size:12px; }

        /* --- GAME STYLES --- */
        #game-container{ width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; box-sizing:border-box; background:none; }

        #start-screen{ width:100%; max-width:700px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:30px; backdrop-filter:blur(10px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; box-sizing:border-box; }
        #game-title-display{ text-align:center; color:var(--accent-color); font-size:1.8em; margin:0; text-shadow:0 0 5px var(--accent-color); }
        #character-selector{ display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; }
        #character-selector img{ width:80px; height:80px; border-radius:50%; border:3px solid transparent; cursor:pointer; object-fit:cover; transition:all .2s; }
        #character-selector img.selected{ border-color:var(--accent-color); box-shadow:0 0 10px var(--accent-color); transform:scale(1.05); }

        #start-game-btn{ align-self:center; }

        .game-frame{ width:100%; max-width:700px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:20px; box-sizing:border-box; }

        #game-process{ width:100%; height:100%; position:relative; padding:20px; box-sizing:border-box; display:block; }
        #game-ui-top{ position:absolute; top:20px; left:20px; right:20px; display:flex; justify-content:space-between; align-items:center; }
        #timer-display{ font-size:2em; color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); }
        #lives-container{ display:flex; gap:5px; font-size:2.0em; }
        .life-heart { transition: all 0.5s ease; }

        #character-display{ position:absolute; bottom:5%; left:10%; width:25%; height:50%; display:flex; justify-content:center; align-items:center; }
        #player-char-img{ max-width:100%; max-height:100%; transition:transform .3s ease, filter .3s ease; }
        #player-char-img.correct-answer{ animation:jump-animation .6s ease; filter: drop-shadow(0 0 15px var(--correct-color)); }
        #player-char-img.incorrect-answer{ animation:shake-animation .6s ease; filter: drop-shadow(0 0 15px var(--incorrect-color)); }

        #card-stack-area{ position:absolute; bottom:15%; right:10%; width:45%; height:60%; perspective:1000px; }

        .card{
            position:absolute; width:100%; height:100%; transform-style:preserve-3d; transition:transform .6s ease; cursor:pointer; border-radius:18px; box-shadow:0 10px 20px rgba(0,0,0,.4); overflow:hidden; display:flex;
            transform: translateX(var(--card-offset-x, 0px)) translateY(var(--card-offset-y, 0px));
        }
        .card.flipped{
            transform: translateX(var(--card-offset-x, 0px)) translateY(var(--card-offset-y, 0px)) rotateY(180deg);
            cursor:default;
        }

        .card.swiped-away{ transform:translate(140%, -50%) rotate(25deg) scale(.95) !important; opacity:0; pointer-events:none; transition: all .6s ease; }

        .card-face{ position:absolute; width:100%; height:100%; backface-visibility:hidden; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:18px;}
        .card-front{ background:linear-gradient(45deg,#00776b,#00bfa5); color:white; font-size:3em; z-index:2; width:100%; height:100%; }
        .card-back{ background-color:#e0e0e0; color:var(--text-dark); transform:rotateY(180deg); padding:20px; box-sizing:border-box; text-align:left; justify-content:flex-start; z-index:1; }
        .card-question{ font-size:1.2em; font-weight:bold; margin-bottom:20px; }
        .card-answers button, .card-input-area button{ width:100%; margin-bottom:10px; background-color:#f1f5f9; color:var(--text-dark); border:1px solid #ccc; text-align:left; padding:10px; }
        .card-answers button.correct, .card-input-area button.correct{ background-color:var(--correct-color) !important; border-color:#38a169 !important; color:white; }
        .card-answers button.incorrect, .card-input-area button.incorrect{ background-color:var(--incorrect-color) !important; border-color:#c53030 !important; color:white; }
        .card-input-area input{ width:100%; padding:10px; margin-bottom:10px; border-radius:6px; }

        #end-screen{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; width:100%; max-width:700px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:30px; box-sizing:border-box; }
        #end-screen h2{ font-size:2em; color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); text-align:center; margin:0; }
        #end-screen .end-player{ width:160px; height:160px; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
        #end-screen .confetti{ font-size:3em; }

        .hidden{ display:none !important; }

        @keyframes jump-animation{ 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-30px);} }
        @keyframes shake-animation{ 0%,100%{ transform:translateX(0);} 25%{ transform:translateX(-12px) rotate(-3deg);} 75%{ transform:translateX(12px) rotate(3deg);} }
        @keyframes sway-animation {
            0%   { transform: rotate(-8deg); }
            50%  { transform: rotate(8deg); }
            100% { transform: rotate(-8deg); }
        }
        #end-player-img.sway {
            animation: sway-animation 2.5s ease-in-out infinite;
        }
        @keyframes life-lost-animation {
            0%   { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.2; transform: scale(0.8); }
        }
        .life-heart.lost {
            animation: life-lost-animation 0.5s ease-out forwards;
        }

        .time-overlay{
            position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:2em; font-weight:bold; color:white; background:rgba(248, 113, 113, 0.7); z-index:3;
        }
    </style>
</head>
<body>
    <div class="master-container">
        <h1 class="main-title">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</h1>

        <div id="editor-wrapper">
            <div id="editor-panel">
                <div class="editor-panel-inner">
                    <div class="editor-section">
                        <h2 data-lang-key="editor_title">1. –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</h2>
                        <input type="text" id="game-title" value="–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è!">
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_characters">2. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
                        <div id="characters-container"></div>
                        <button id="add-character-btn" data-lang-key="editor_add_char">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_settings">3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</h2>
                        <label for="language-select" data-lang-key="editor_lang">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:</label>
                        <select id="language-select">
                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                            <option value="en">English</option>
                        </select>

                        <label for="card-count-input" data-lang-key="editor_card_count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∏–≥—Ä–µ (0 = –≤—Å–µ):</label>
                        <input type="number" id="card-count-input" value="0" min="0">

                        <div class="checkbox-group">
                           <input type="checkbox" id="timer-enabled-checkbox" checked>
                           <label for="timer-enabled-checkbox" data-lang-key="editor_timer">–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä (30 —Å–µ–∫/–≤–æ–ø—Ä–æ—Å)</label>
                        </div>
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_questions">4. –ó–∞–¥–∞–Ω–∏—è</h2>
                        <div id="questions-container"></div>
                        <button id="add-question-btn" data-lang-key="editor_add_q">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                    </div>
                </div>
            </div>

            <div id="preview-section">
                <iframe id="preview-iframe"></iframe>
                <div id="generate-code-wrapper">
                    <button id="generate-code-btn" data-lang-key="editor_generate">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                    <textarea id="iframe-code"></textarea>
                </div>
            </div>
        </div>

        <!-- In-iframe game area (used in preview mode) -->
        <div id="game-container" class="hidden">
            <div id="start-screen" class="game-frame">
                <h1 id="game-title-display"></h1>
                <h2 data-lang-key="game_select_char">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</h2>
                <div id="character-selector"></div>
                <button id="start-game-btn" disabled data-lang-key="game_start">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!</button>
            </div>

            <div id="game-process" class="hidden">
                <div id="game-ui-top">
                    <div id="timer-display"></div>
                    <div id="lives-container"></div>
                </div>

                <div id="character-display"><img id="player-char-img" src="" alt="–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂"></div>

                <div id="card-stack-area"></div>
            </div>

            <div id="end-screen" class="hidden">
                <div class="end-player"><img id="end-player-img" src="" alt="player" style="max-width:100%;max-height:100%"></div>
                <h2 id="end-title">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
                <div class="confetti hidden" id="confetti">üéâüéâüéâ</div>
                <button id="play-again-btn" onclick="window.location.reload()" data-lang-key="game_play_again">–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const isPlayerMode = urlParams.get('mode') === 'player';
        let characterDataUrls = [];
        let isCodeGenerated = false;

        const translations = {
            ru: {
                editor_title: "1. –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã",
                editor_characters: "2. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏",
                editor_add_char: "–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞",
                editor_settings: "3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã",
                editor_lang: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:",
                editor_card_count: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∏–≥—Ä–µ (0 = –≤—Å–µ):",
                editor_timer: "–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä (30 —Å–µ–∫/–≤–æ–ø—Ä–æ—Å)",
                editor_questions: "4. –ó–∞–¥–∞–Ω–∏—è",
                editor_add_q: "–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å",
                editor_generate: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥",
                editor_copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
                editor_copied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
                q_placeholder: "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞...",
                q_option_placeholder: "–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞",
                q_text_answer_placeholder: "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç...",
                q_add_option: "+ –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç",
                q_remove_q: "–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å",
                q_type_mc: "–û–¥–∏–Ω –∏–∑ –º–Ω–æ–≥–∏—Ö",
                q_type_text: "–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞",
                game_select_char: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:",
                game_start: "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!",
                game_check: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å",
                game_end_win: "–¢–´ –ü–û–ë–ï–î–ò–õ!",
                game_end_lose: "–¢–´ –ü–†–û–ò–ì–†–ê–õ!",
                game_play_again: "–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑",
                time_up: "–í–†–ï–ú–Ø –í–´–®–õ–û!"
            },
            en: {
                editor_title: "1. Game Title",
                editor_characters: "2. Characters",
                editor_add_char: "Add Character",
                editor_settings: "3. Game Settings",
                editor_lang: "Interface Language:",
                editor_card_count: "Number of cards in game (0 = all):",
                editor_timer: "Enable timer (30 sec/question)",
                editor_questions: "4. Questions",
                editor_add_q: "Add Question",
                editor_generate: "Generate Code",
                editor_copy: "Copy",
                editor_copied: "Copied!",
                q_placeholder: "Question text...",
                q_option_placeholder: "Answer option",
                q_text_answer_placeholder: "Correct answer...",
                q_add_option: "+ Add Option",
                q_remove_q: "Delete Question",
                q_type_mc: "Multiple Choice",
                q_type_text: "Text Input",
                game_select_char: "Select a Character:",
                game_start: "Start Game!",
                game_check: "Check",
                game_end_win: "YOU WIN!",
                game_end_lose: "YOU LOSE!",
                game_play_again: "Play Again",
                time_up: "TIME'S UP!"
            }
        };

        const correctSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(1e3).join('123'));
        const incorrectSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(1e3).join('321'));

        let gameConfig = {};
        let gameState = {
            lang: 'ru',
            character: '',
            questions: [],
            answeredCount: 0,
            lives: 5,
            timerRunning: false
        };
        let timerInterval = null;

        if (isPlayerMode) {
            document.getElementById('editor-wrapper').style.display = 'none';
            document.querySelector('.main-title').style.display = 'none';
            document.body.style.padding = '0';
            document.getElementById('game-container').classList.remove('hidden');

            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'gameConfig') {
                    initGame(event.data.config);
                }
            });
        } else {
            initEditor();
        }

        function updateElementText(lang, key, element, attr = 'textContent'){
            if (element && translations[lang] && translations[lang][key] !== undefined) element[attr] = translations[lang][key];
        }

        function updateUI(lang){
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (el.tagName === 'INPUT' && el.type === 'text') updateElementText(lang, key, el, 'placeholder');
                else updateElementText(lang, key, el);
            });
            document.querySelectorAll('.question-block').forEach(block => updateQuestionBlockLang(lang, block));
        }

        function updateQuestionBlockLang(lang, block){
            const t = translations[lang] || translations.ru;
            const qText = block.querySelector('.question-text'); if (qText) qText.placeholder = t.q_placeholder;
            const addOptBtn = block.querySelector('.add-option-btn'); if (addOptBtn) addOptBtn.textContent = t.q_add_option;
            block.querySelectorAll('.option-text').forEach((opt, i) => { opt.placeholder = `${t.q_option_placeholder} ${i+1}`; });
            const textIn = block.querySelector('.text-answer-input'); if (textIn) textIn.placeholder = t.q_text_answer_placeholder;
            const typeSelect = block.querySelector('.question-type-select');
            if (typeSelect && typeSelect.options && typeSelect.options.length >= 2){
                typeSelect.options[0].textContent = t.q_type_mc;
                typeSelect.options[1].textContent = t.q_type_text;
            }
        }

        function initEditor(){
            document.getElementById('add-character-btn').addEventListener('click', addCharacterInput);
            document.getElementById('add-question-btn').addEventListener('click', addQuestionBlock);
            document.getElementById('generate-code-btn').addEventListener('click', handleGenerateCodeClick);
            document.getElementById('editor-panel').addEventListener('input', updatePreview);
            document.getElementById('editor-panel').addEventListener('change', updatePreview);
            document.getElementById('language-select').addEventListener('change', (e) => updateUI(e.target.value));

            const previewIframe = document.getElementById('preview-iframe');
            previewIframe.src = `${window.location.pathname}?mode=player`;
            previewIframe.onload = () => updatePreview();

            updateUI('ru');
            addCharacterInput();
            addQuestionBlock();
        }

        function collectConfig(){
            const lang = document.getElementById('language-select').value;
            return {
                lang: lang,
                title: document.getElementById('game-title').value,
                characters: characterDataUrls.filter(Boolean),
                cardCount: parseInt(document.getElementById('card-count-input').value, 10) || 0,
                timerEnabled: document.getElementById('timer-enabled-checkbox').checked,
                questions: Array.from(document.querySelectorAll('.question-block')).map(block => {
                    const questionType = block.querySelector('.question-type-select').value;
                    const question = {
                        type: questionType,
                        question: block.querySelector('.question-text').value || ''
                    };
                    if (questionType === 'multiple-choice'){
                        question.options = Array.from(block.querySelectorAll('.option-text')).map(i => i.value);
                        const correctInput = block.querySelector('input[type="radio"]:checked');
                        question.answer = correctInput ? parseInt(correctInput.value, 10) : 0;
                    } else {
                        question.answer = block.querySelector('.text-answer-input').value || '';
                    }
                    return question;
                }).filter(q => q.question && q.question.trim())
            };
        }

        function updatePreview(){
            const config = collectConfig();
            const previewIframe = document.getElementById('preview-iframe');
            if (previewIframe.contentWindow){
                previewIframe.contentWindow.postMessage({ type: 'gameConfig', config }, '*');
            }
            isCodeGenerated = false;
            const lang = document.getElementById('language-select').value;
            document.getElementById('generate-code-btn').textContent = translations[lang].editor_generate;
        }

        function handleGenerateCodeClick(){
            const codeTextarea = document.getElementById('iframe-code');
            const btn = document.getElementById('generate-code-btn');
            const lang = document.getElementById('language-select').value;

            if (!isCodeGenerated){
                const config = collectConfig();
                const gameUrl = `${window.location.origin}${window.location.pathname}?mode=player`;
                const configString = JSON.stringify(config).replace(/</g, '\\u003c');

                codeTextarea.value =
`<div style="position: relative; width: 100%; padding-bottom: 56.25%;">
    <iframe id="game-iframe-123" src="${gameUrl}" frameborder="0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe>
</div>
<script>
    (function() {
        var iframe = document.getElementById('game-iframe-123');
        var gameConfig = ${configString};
        iframe.onload = function() {
            iframe.contentWindow.postMessage({ type: 'gameConfig', config: gameConfig }, '*');
        };
    })();
<\/script>`;
                codeTextarea.style.display = 'block';
                btn.textContent = translations[lang].editor_copy;
                isCodeGenerated = true;
            } else {
                codeTextarea.select();
                navigator.clipboard.writeText(codeTextarea.value).then(() => {
                    btn.textContent = translations[lang].editor_copied;
                    setTimeout(() => { btn.textContent = translations[lang].editor_copy; }, 2000);
                });
            }
        }

        function addCharacterInput(){
            const container = document.getElementById('characters-container');
            const index = container.children.length;
            characterDataUrls[index] = null;
            const group = document.createElement('div');
            group.className = 'character-upload-group';
            group.innerHTML = `
                <img src="https://placehold.co/40x40/101820/00ffe7?text=+" alt="preview" id="char-preview-${index}">
                <input type="file" id="char-upload-${index}" accept="image/*">
                <label for="char-upload-${index}">–ó–∞–≥—Ä—É–∑–∏—Ç—å...</label>
                <button type="button" class="char-remove-btn-x" title="–£–¥–∞–ª–∏—Ç—å">&times;</button>
            `;
            container.appendChild(group);

            group.querySelector('.char-remove-btn-x').onclick = () => {
                characterDataUrls[index] = null;
                group.remove();
                updatePreview();
            };

            document.getElementById(`char-upload-${index}`).addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.getElementById(`char-preview-${index}`);
                        if (img) img.src = e.target.result;
                        characterDataUrls[index] = e.target.result;
                        updatePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function addQuestionBlock(){
            const container = document.getElementById('questions-container');
            const qIndex = Date.now();
            const block = document.createElement('div');
            block.className = 'question-block';
            const lang = document.getElementById('language-select').value;
            const t = translations[lang] || translations.ru;

            block.innerHTML = `
                <div class="question-header">
                    <h4>–í–æ–ø—Ä–æ—Å ${container.children.length + 1}</h4>
                    <div class="question-actions">
                        <button type="button" class="icon-btn edit-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                        <button type="button" class="icon-btn remove-question-btn" title="${t.q_remove_q}">üóëÔ∏è</button>
                    </div>
                </div>
                <select class="question-type-select">
                    <option value="multiple-choice">${t.q_type_mc}</option>
                    <option value="text-input">${t.q_type_text}</option>
                </select>
                <textarea class="question-text" placeholder="${t.q_placeholder}"></textarea>
                <div class="question-type-wrapper multiple-choice">
                    <div class="options-container"></div>
                    <button type="button" class="add-option-btn">${t.q_add_option}</button>
                </div>
                <div class="question-type-wrapper text-input hidden">
                    <input type="text" class="text-answer-input" placeholder="${t.q_text_answer_placeholder}">
                </div>
            `;
            container.appendChild(block);

            const typeSelect = block.querySelector('.question-type-select');
            const mcWrapper = block.querySelector('.multiple-choice');
            const textWrapper = block.querySelector('.text-input');

            typeSelect.addEventListener('change', () => {
                const isMc = typeSelect.value === 'multiple-choice';
                mcWrapper.classList.toggle('hidden', !isMc);
                textWrapper.classList.toggle('hidden', isMc);
                updatePreview();
            });

            addOption(block.querySelector('.options-container'), qIndex);
            addOption(block.querySelector('.options-container'), qIndex);
            const firstRadio = block.querySelector('input[type="radio"]');
            if (firstRadio) firstRadio.checked = true;

            block.querySelector('.add-option-btn').onclick = () => { addOption(block.querySelector('.options-container'), qIndex); updatePreview(); };
            block.querySelector('.remove-question-btn').onclick = () => { block.remove(); updatePreview(); };
        }

        function addOption(container, qIndex){
            const optionIndex = container.children.length;
            const group = document.createElement('div');
            group.className = 'option-group';
            const lang = document.getElementById('language-select').value;
            group.innerHTML = `<input type="radio" name="correct_q${qIndex}" value="${optionIndex}"><input type="text" class="option-text" placeholder="${translations[lang].q_option_placeholder} ${optionIndex+1}">`;
            container.appendChild(group);
        }

        // ---------- Game functions ----------
        function initGame(config){
            if (!config) return;
            gameConfig = config;
            gameState.lang = config.lang || 'ru';
            updateUI(gameState.lang);

            document.getElementById('game-title-display').textContent = gameConfig.title || '';
            const charSelector = document.getElementById('character-selector');
            charSelector.innerHTML = '';
            (gameConfig.characters || []).forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.onclick = () => {
                    charSelector.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
                    img.classList.add('selected');
                    gameState.character = url;
                    checkStartButton();
                };
                charSelector.appendChild(img);
            });

            document.getElementById('start-game-btn').onclick = startGame;
            checkStartButton();
        }

        function checkStartButton(){
            document.getElementById('start-game-btn').disabled = !gameState.character;
        }

        function startGame(){
            try { correctSound.play().then(()=>correctSound.pause(), ()=>{}); correctSound.pause(); } catch(e){}
            try { incorrectSound.play().then(()=>incorrectSound.pause(), ()=>{}); incorrectSound.pause(); } catch(e){}

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-process').classList.remove('hidden');
            document.getElementById('player-char-img').src = gameState.character;

            let questionsToPlay = [...(gameConfig.questions || [])];
            questionsToPlay.sort(() => 0.5 - Math.random());

            const count = (gameConfig.cardCount > 0 && gameConfig.cardCount <= questionsToPlay.length) ? gameConfig.cardCount : questionsToPlay.length;
            gameState.questions = questionsToPlay.slice(0, count);

            gameState.answeredCount = 0;
            gameState.lives = 5;
            setupLivesDisplay();

            const stackArea = document.getElementById('card-stack-area');
            stackArea.innerHTML = '';

            for (let i = 0; i < gameState.questions.length; i++){
                const q = gameState.questions[i];
                const card = createCardElement(q, i);
                const offset = (gameState.questions.length - 1 - i) * 6;

                card.style.setProperty('--card-offset-x', `${offset}px`);
                card.style.setProperty('--card-offset-y', `${offset}px`);

                card.style.zIndex = 100 + i;
                stackArea.appendChild(card);
            }

            if (gameState.questions.length > 0){
                startTimerForCurrentCard();
            } else {
                endGame('win');
            }
        }

        function setupLivesDisplay(){
            const livesContainer = document.getElementById('lives-container');
            livesContainer.innerHTML = '';
            for (let i=0;i<5;i++){
                const heart = document.createElement('span');
                heart.className = 'life-heart';
                heart.textContent = '‚ù§Ô∏è';
                livesContainer.appendChild(heart);
            }
        }

        function loseLife(){
            if (gameState.lives > 0) {
                 const hearts = document.querySelectorAll('#lives-container .life-heart');
                 const heartToLose = hearts[gameState.lives - 1];
                 if (heartToLose) {
                    heartToLose.classList.add('lost');
                 }
            }
            gameState.lives--;
            if (gameState.lives < 0) gameState.lives = 0;

            if (gameState.lives <= 0){
                setTimeout(() => endGame('lose'), 700);
            }
        }

        function startTimerForCurrentCard(){
            clearInterval(timerInterval);
            const timerDisplay = document.getElementById('timer-display');
            if (!gameConfig.timerEnabled){
                timerDisplay.style.display = 'none';
                return;
            }
            timerDisplay.style.display = 'block';
            let timeLeft = 30;
            timerDisplay.textContent = timeLeft;
            gameState.timerRunning = true;

            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0){
                    clearInterval(timerInterval);
                    gameState.timerRunning = false;
                    handleTimeUpForTopCard();
                }
            }, 1000);
        }

        function handleTimeUpForTopCard(){
            const stackArea = document.getElementById('card-stack-area');
            const topCard = stackArea.querySelector('.card:not(.swiped-away):not(.removed)');
            const overlayText = translations[gameState.lang]?.time_up || "–í–†–ï–ú–Ø –í–´–®–õ–û!";
            if (topCard){
                const ov = document.createElement('div');
                ov.className = 'time-overlay';
                ov.textContent = overlayText;
                topCard.appendChild(ov);
                try { incorrectSound.play(); } catch(e){}
                setTimeout(() => {
                    if (ov && ov.parentNode) ov.parentNode.removeChild(ov);
                    const playerImg = document.getElementById('player-char-img');
                    if (playerImg){
                        playerImg.classList.remove('correct-answer','incorrect-answer');
                        void playerImg.offsetWidth;
                        playerImg.classList.add('incorrect-answer');
                    }
                    loseLife();
                    topCard.classList.add('swiped-away','removed');
                    gameState.answeredCount++;
                    setTimeout(() => {
                        if (playerImg) playerImg.classList.remove('incorrect-answer');
                        checkContinueAfterAnswer();
                    }, 700);
                }, 1500);
            } else {
                checkContinueAfterAnswer();
            }
        }

        function createCardElement(qData, qIndex){
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.qindex = qIndex;

            card.innerHTML = `
                <div class="card-face card-front"><div style="font-size:2em">?</div></div>
                <div class="card-face card-back">
                    <div class="card-question"></div>
                    <div class="card-content-area"></div>
                </div>
            `;
            const qTextEl = card.querySelector('.card-question');
            const content = card.querySelector('.card-content-area');

            qTextEl.textContent = qData.question || '';

            if (qData.type === 'multiple-choice'){
                content.className = 'card-content-area card-answers';
                (qData.options || []).forEach((opt, i) => {
                    const btn = document.createElement('button');
                    btn.textContent = opt || `${translations[gameState.lang].q_option_placeholder} ${i+1}`;
                    btn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        handleAnswerFromButton(card, i === qData.answer, btn);
                    });
                    content.appendChild(btn);
                });
            } else {
                content.className = 'card-content-area card-input-area';
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = translations[gameState.lang]?.q_text_answer_placeholder || '';
                const btn = document.createElement('button');
                btn.textContent = translations[gameState.lang]?.game_check || '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
                btn.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const correct = (input.value || '').trim().toLowerCase() === (qData.answer || '').trim().toLowerCase();
                    handleAnswerFromButton(card, correct, btn);
                });
                content.appendChild(input);
                content.appendChild(btn);
            }

            card.addEventListener('click', () => {
                if (!card.classList.contains('flipped')) {
                    card.classList.add('flipped');
                }
            });

            return card;
        }

        function handleAnswerFromButton(cardEl, isCorrect, buttonEl){
            clearInterval(timerInterval);
            gameState.timerRunning = false;

            const cardBack = cardEl.querySelector('.card-back');
            if (cardBack) cardBack.querySelectorAll('button,input').forEach(el => el.disabled = true);

            const playerImg = document.getElementById('player-char-img');
            if (playerImg){
                playerImg.classList.remove('correct-answer','incorrect-answer');
                void playerImg.offsetWidth;
            }

            if (isCorrect){
                try { correctSound.play(); } catch(e){}
                if (playerImg) playerImg.classList.add('correct-answer');
                buttonEl.classList.add('correct');
            } else {
                try { incorrectSound.play(); } catch(e){}
                if (playerImg) playerImg.classList.add('incorrect-answer');
                buttonEl.classList.add('incorrect');
                loseLife();
            }

            setTimeout(() => {
                if(playerImg) playerImg.classList.remove('correct-answer','incorrect-answer');
            }, 700);

            setTimeout(() => {
                cardEl.classList.add('swiped-away','removed');
                gameState.answeredCount++;
                checkContinueAfterAnswer();
            }, 900);
        }

        function checkContinueAfterAnswer(){
            if (gameState.lives <= 0){
                // The endGame('lose') is already called from loseLife()
                return;
            }
            if (gameState.answeredCount >= gameState.questions.length){
                endGame('win');
                return;
            }
            startTimerForCurrentCard();
        }

        function endGame(status){
            clearInterval(timerInterval);
            document.getElementById('game-process').classList.add('hidden');
            const endScreen = document.getElementById('end-screen');
            endScreen.classList.remove('hidden');

            const endTitle = document.getElementById('end-title');
            const confetti = document.getElementById('confetti');
            const endImg = document.getElementById('end-player-img');
            endImg.src = gameState.character || '';

            // –°–±—Ä–æ—Å –∫–ª–∞—Å—Å–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–π –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
            endImg.classList.remove('correct-answer', 'incorrect-answer', 'sway');
            void endImg.offsetWidth; // –¢—Ä—é–∫ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ CSS

            if (status === 'win'){
                endTitle.textContent = translations[gameState.lang]?.game_end_win || '–¢—ã –ø–æ–±–µ–¥–∏–ª!';
                confetti.classList.remove('hidden');
                endImg.classList.add('correct-answer'); // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä—ã–∂–∫–∞
                try { correctSound.play(); } catch(e){}
            } else {
                endTitle.textContent = translations[gameState.lang]?.game_end_lose || '–¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª!';
                confetti.classList.add('hidden');
                endImg.classList.add('sway'); // –ê–Ω–∏–º–∞—Ü–∏—è –∫–∞—á–∞–Ω–∏—è
                try { incorrectSound.play(); } catch(e){}
            }
        }

        window._gameState = gameState;
        window._gameConfig = gameConfig;
    });
    </script>
</body>
</html>
