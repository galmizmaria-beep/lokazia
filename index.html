<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактор Образовательных Квестов 2.0</title>
    <style>
        :root {
            --bg-color: #f4f7f9; --panel-bg: #ffffff; --border-color: #e0e6ed;
            --text-color: #333; --primary-color: #4a90e2; --primary-hover: #357abd;
            --danger-color: #d9534f; --success-color: #5cb85c; --font-family: 'Segoe UI', Roboto, sans-serif;
        }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .container { display: flex; width: 100%; height: 100%; }
        #editor-panel { width: 45%; padding: 20px; background-color: var(--panel-bg); border-right: 1px solid var(--border-color); overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        h1, h2 { color: var(--primary-color); }
        h1 { margin-top: 0; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        details { background-color: #fafafa; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; padding: 10px; transition: all 0.2s ease-in-out; }
        details[open] { background-color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        summary { font-weight: bold; font-size: 1.2em; cursor: pointer; list-style: none; padding: 5px; }
        summary::before { content: '▶ '; display: inline-block; transition: transform 0.2s; }
        details[open] summary::before { transform: rotate(90deg); }
        .form-group, .task-item { margin: 15px 0; border: 1px dashed var(--border-color); padding: 15px; border-radius: 8px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input[type="text"], textarea, select { width: calc(100% - 22px); padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; }
        textarea { resize: vertical; min-height: 60px; }
        .btn { background-color: var(--primary-color); color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        .btn:hover { background-color: var(--primary-hover); }
        .btn-add { margin-top: 10px; }
        .btn-delete { background-color: var(--danger-color); font-size: 0.8em; padding: 5px 8px; float: right; }
        .list-item { padding: 10px; margin-top: 10px; border-radius: 4px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border-color); background: #fff; }
        .list-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; border: 2px solid var(--border-color); cursor: pointer; }
        #preview-panel { width: 55%; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        #preview-window { flex-grow: 1; background-color: #333; border: 5px solid #222; border-radius: 10px; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; text-align: center; background-size: cover; background-position: center; transition: background-image 0.5s ease; }
        #preview-overlay { background-color: rgba(0, 0, 0, 0.5); padding: 20px; border-radius: 10px; color: white; }
        #preview-title { margin: 0; font-size: 2em; }
        #preview-description { font-size: 1.1em; margin-top: 10px; }
        #preview-character { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); max-height: 40%; width: auto; transition: all 0.3s ease; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)); }
        #iframe-code { width: calc(100% - 22px); min-height: 100px; background-color: #2d2d2d; color: #9fcc7a; font-family: 'Courier New', Courier, monospace; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px; }
        #generate-btn { width: 100%; padding: 15px; font-size: 1.2em; margin-top: 10px; font-weight: bold; }
        #generate-btn.copied { background-color: var(--success-color); }
        .task-options-container .option-group { display: flex; align-items: center; margin-bottom: 5px; }
        .task-options-container input[type="radio"] { width: auto; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Левая панель: Редактор -->
        <aside id="editor-panel">
            <h1>Редактор Квеста</h1>
            <details open>
                <summary>1. Настройки мира</summary>
                <div class="form-group">
                    <label for="quest-title">Название квеста</label>
                    <input type="text" id="quest-title" placeholder="Путешествие в мир знаний">
                    <label for="quest-description">Краткое описание</label>
                    <textarea id="quest-description" placeholder="Помоги герою пройти все испытания!"></textarea>
                </div>
            </details>
            <details><summary>2. Герои</summary><div id="heroes-list"></div><button class="btn btn-add" onclick="addItem('hero')">Добавить героя</button></details>
            <details><summary>3. Враги / Препятствия</summary><div id="enemies-list"></div><button class="btn btn-add" onclick="addItem('enemy')">Добавить врага</button></details>
            <details><summary>4. Предметы инвентаря</summary><div id="inventory-list"></div><button class="btn btn-add" onclick="addItem('item')">Добавить предмет</button></details>
            <details><summary>5. Локации</summary><div id="locations-list"></div><button class="btn btn-add" onclick="addItem('location')">Добавить локацию</button></details>
            <details>
                <summary>6. Уровни сложности</summary>
                <div class="form-group">
                    <label for="level-easy">Легкий</label><textarea id="level-easy" placeholder="Задания попроще, больше подсказок."></textarea>
                    <label for="level-medium">Средний</label><textarea id="level-medium" placeholder="Стандартный набор заданий."></textarea>
                    <label for="level-hard">Сложный</label><textarea id="level-hard" placeholder="Сложные задания, ограниченное время."></textarea>
                </div>
            </details>
            <details>
                <summary>7. Конструктор Заданий</summary>
                <div id="tasks-list"></div>
                <button class="btn btn-add" onclick="addTask()">Добавить задание</button>
            </details>
        </aside>

        <!-- Правая панель: Предпросмотр и Генерация -->
        <main id="preview-panel">
            <h2>Предпросмотр</h2>
            <div id="preview-window">
                <div id="preview-overlay">
                    <h2 id="preview-title">Название квеста</h2>
                    <p id="preview-description">Описание появится здесь.</p>
                </div>
                <img id="preview-character" src="" alt="">
            </div>

            <div id="output-section">
                <h2>Код для вставки</h2>
                <textarea id="iframe-code" readonly placeholder="Нажмите 'Сгенерировать код', чтобы получить iframe..."></textarea>
                <button id="generate-btn" class="btn">Сгенерировать код</button>
            </div>
        </main>
    </div>

    <script>
        // --- ЗВУКИ (встроены в код через Base64) ---
        const winSoundBase64 = "data:audio/mpeg;base64,SUQzBAAAAAAAI1RTSEUAAAABA... (very long string)"; // Замените на реальный Base64 звука
        const failSoundBase64 = "data:audio/mpeg;base64,SUQzBAAAAAAAI1RTSEUAAAABA... (very long string)"; // Замените на реальный Base64 звука
        // Примечание: Для краткости я оставил заглушки. Вы можете найти короткие mp3-файлы и сконвертировать их в Base64 онлайн.
        // Для примера, вот короткие звуки:
        const winSoundExample = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=";
        const failSoundExample = "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAA";

        document.addEventListener('DOMContentLoaded', () => {
            const previewTitle = document.getElementById('preview-title');
            const previewDescription = document.getElementById('preview-description');
            const previewWindow = document.getElementById('preview-window');
            const previewCharacter = document.getElementById('preview-character');

            document.getElementById('quest-title').addEventListener('input', (e) => { previewTitle.textContent = e.target.value || 'Название квеста'; });
            document.getElementById('quest-description').addEventListener('input', (e) => { previewDescription.textContent = e.target.value || 'Описание появится здесь.'; });

            window.addItem = (type) => {
                const id = Date.now();
                const container = document.getElementById(`${type}s-list`);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'list-item';
                itemDiv.id = `${type}-${id}`;
                
                let placeholderText = 'Название';
                if (type === 'hero') placeholderText = 'Имя героя';
                if (type === 'enemy') placeholderText = 'Имя врага';
                if (type === 'location') placeholderText = 'Название локации';
                
                itemDiv.innerHTML = `
                    <img src="https://via.placeholder.com/50" alt="${type}" id="img-${id}" data-base64="" ${type === 'hero' ? `onclick="setPreviewCharacter('${id}')"` : ''}>
                    <div style="flex-grow: 1;">
                        <input type="text" placeholder="${placeholderText}">
                        <textarea placeholder="Описание..." style="min-height: 40px; margin-top: 5px;"></textarea>
                        <input type="file" accept="image/*" style="margin-top: 5px;" onchange="handleImageUpload(this, '${id}')">
                    </div>
                    <button class="btn btn-delete" onclick="this.parentElement.remove()">X</button>
                `;
                container.appendChild(itemDiv);
            };

            window.handleImageUpload = (input, id) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64 = e.target.result;
                        const img = document.getElementById(`img-${id}`);
                        img.src = base64;
                        img.dataset.base64 = base64;
                        updatePreview();
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            };

            window.setPreviewCharacter = (id) => {
                const img = document.getElementById(`img-${id}`);
                if (img && img.dataset.base64) {
                    previewCharacter.src = img.dataset.base64;
                    previewCharacter.style.display = 'block';
                }
            };

            const updatePreview = () => {
                const firstLocation = document.querySelector('#locations-list .list-item img');
                if (firstLocation && firstLocation.dataset.base64) {
                    previewWindow.style.backgroundImage = `url('${firstLocation.dataset.base64}')`;
                } else {
                    previewWindow.style.backgroundImage = 'none';
                }

                const firstHero = document.querySelector('#heroes-list .list-item img');
                 if (!previewCharacter.src && firstHero && firstHero.dataset.base64) {
                    previewCharacter.src = firstHero.dataset.base64;
                    previewCharacter.style.display = 'block';
                } else if (!document.querySelector('#heroes-list .list-item')) {
                    previewCharacter.style.display = 'none';
                }
            };

            window.addTask = () => {
                const id = Date.now();
                const container = document.getElementById('tasks-list');
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task-item';
                taskDiv.id = `task-${id}`;
                taskDiv.innerHTML = `
                    <button class="btn btn-delete" onclick="this.parentElement.remove()">X</button>
                    <div class="form-group">
                        <label>Вопрос:</label>
                        <textarea placeholder="Введите текст вопроса..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Тип задания:</label>
                        <select onchange="updateTaskUI(this, '${id}')">
                            <option value="choice">Выбор ответа</option>
                            <option value="input">Ввод текста</option>
                        </select>
                    </div>
                    <div id="task-body-${id}">
                        <!-- Динамический контент для типа задания -->
                    </div>
                `;
                container.appendChild(taskDiv);
                updateTaskUI(taskDiv.querySelector('select'), id);
            };

            window.updateTaskUI = (select, id) => {
                const body = document.getElementById(`task-body-${id}`);
                const type = select.value;
                if (type === 'choice') {
                    body.innerHTML = `
                        <label>Варианты ответов (отметьте правильный):</label>
                        <div class="task-options-container">
                            ${[1,2,3,4].map(i => `
                            <div class="option-group">
                                <input type="radio" name="correct-answer-${id}" value="${i-1}">
                                <input type="text" placeholder="Вариант ${i}">
                            </div>`).join('')}
                        </div>`;
                } else if (type === 'input') {
                    body.innerHTML = `<label>Правильный ответ (текст):</label><input type="text" placeholder="Введите точный ответ">`;
                }
            };
            
            document.getElementById('generate-btn').addEventListener('click', () => {
                const gameData = {
                    title: document.getElementById('quest-title').value,
                    description: document.getElementById('quest-description').value,
                    levels: {
                        easy: document.getElementById('level-easy').value,
                        medium: document.getElementById('level-medium').value,
                        hard: document.getElementById('level-hard').value,
                    },
                    heroes: [], locations: [], enemies: [], items: [], tasks: []
                };

                document.querySelectorAll('#heroes-list .list-item').forEach(el => {
                    gameData.heroes.push({ name: el.querySelector('input').value, desc: el.querySelector('textarea').value, img: el.querySelector('img').dataset.base64 });
                });
                document.querySelectorAll('#locations-list .list-item').forEach(el => {
                    gameData.locations.push({ name: el.querySelector('input').value, desc: el.querySelector('textarea').value, img: el.querySelector('img').dataset.base64 });
                });
                // ... (можно добавить сбор врагов и предметов аналогично) ...
                
                document.querySelectorAll('.task-item').forEach(el => {
                    const task = {
                        question: el.querySelector('textarea').value,
                        type: el.querySelector('select').value,
                    };
                    if (task.type === 'choice') {
                        task.options = [];
                        el.querySelectorAll('.option-group input[type="text"]').forEach(opt => task.options.push(opt.value));
                        const correctRadio = el.querySelector('input[type="radio"]:checked');
                        task.correct = correctRadio ? parseInt(correctRadio.value) : 0;
                    } else {
                        task.correct = el.querySelector('#task-body-' + el.id.split('-')[1] + ' input').value;
                    }
                    gameData.tasks.push(task);
                });

                const playerHTML = createPlayerHTML(gameData);
                const iframeSrc = `data:text/html;base64,${btoa(unescape(encodeURIComponent(playerHTML)))}`;
                const finalCode = `<iframe src="${iframeSrc}" width="800" height="600" style="border:0;" allowfullscreen="" loading="lazy"></iframe>`;

                const iframeCodeTextarea = document.getElementById('iframe-code');
                iframeCodeTextarea.value = finalCode;
                navigator.clipboard.writeText(finalCode).then(() => {
                    const btn = document.getElementById('generate-btn');
                    btn.textContent = 'Скопировано!';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = 'Сгенерировать код';
                        btn.classList.remove('copied');
                    }, 2000);
                });
            });

            function createPlayerHTML(data) {
                // Вся логика и стили игры будут здесь. Это большая строка.
                return `
<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8">
<style>
body{margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; height:100vh; overflow:hidden; color: #fff; background: #1a1a1a;}
.screen{display:none; width:100%; height:100%; flex-direction:column; justify-content:center; align-items:center; padding:20px; box-sizing:border-box; text-align:center; background-size:cover; background-position:center; position:relative;}
.screen.active{display:flex;}
.screen::before{content:''; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1;}
.content{position:relative; z-index:2;}
h1{font-size:3em;} p{font-size:1.2em;}
.game-btn{background: #4a90e2; color:white; border:none; padding:15px 30px; border-radius:10px; font-size:1.2em; cursor:pointer; transition: transform 0.2s; margin: 10px;}
.game-btn:hover{transform: scale(1.05);}
.card-container{display:flex; gap:20px; flex-wrap:wrap; justify-content:center;}
.hero-card{background:rgba(40,40,40,0.8); border: 1px solid #444; border-radius:15px; padding:20px; width:200px; cursor:pointer; transition: all 0.2s;}
.hero-card:hover{transform: translateY(-10px); border-color: #4a90e2;}
.hero-card img{width:100%; border-radius:10px;}
.game-view{text-align:left;}
#game-character{position:absolute; bottom:10px; left:10px; height:30%; z-index:3;}
#task-modal{display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10; justify-content:center; align-items:center; flex-direction:column;}
#task-modal.active{display:flex;}
.task-content{background:#2a2a2a; padding:30px; border-radius:15px; width:80%; max-width:600px; text-align:center;}
.task-options button {display:block; width:100%; margin:10px 0;}
.task-options input {width: calc(100% - 24px); padding: 12px; margin-top:10px; font-size:1em; border-radius:5px; border:1px solid #555; background:#333; color:#fff;}
</style>
</head><body>
<audio id="win-sound" src="${winSoundExample}"></audio><audio id="fail-sound" src="${failSoundExample}"></audio>
<div id="start-screen" class="screen active"><div class="content"><h1></h1><p></p><button class="game-btn" onclick="game.showScreen('level-screen')">Начать!</button></div></div>
<div id="level-screen" class="screen"><div class="content"><h1>Выберите уровень</h1><div id="level-buttons"></div></div></div>
<div id="hero-screen" class="screen"><div class="content"><h1>Выберите героя</h1><div id="hero-cards" class="card-container"></div></div></div>
<div id="game-screen" class="screen"><img id="game-character" src=""><div class="content game-view"><h1>Игра началась!</h1><p>Выполняйте задания, чтобы пройти квест.</p></div></div>
<div id="task-modal"><div class="task-content"><h2 id="task-question"></h2><div id="task-body"></div></div></div>
<script>
const gameData = JSON.parse(decodeURIComponent(escape(atob('${btoa(unescape(encodeURIComponent(JSON.stringify(data))))}'))));
const game = {
    state: { level: null, hero: null, currentTask: 0, score: 0 },
    
    init() {
        document.querySelector('#start-screen h1').textContent = gameData.title;
        document.querySelector('#start-screen p').textContent = gameData.description;
        if (gameData.locations.length > 0) {
            document.querySelectorAll('.screen').forEach(s => s.style.backgroundImage = \`url(\${gameData.locations[0].img})\`);
        }
        
        const levelButtons = document.getElementById('level-buttons');
        Object.keys(gameData.levels).forEach(key => {
            const btn = document.createElement('button');
            btn.className = 'game-btn';
            btn.textContent = key.charAt(0).toUpperCase() + key.slice(1);
            btn.onclick = () => this.selectLevel(key);
            levelButtons.appendChild(btn);
        });

        const heroCards = document.getElementById('hero-cards');
        gameData.heroes.forEach((hero, index) => {
            const card = document.createElement('div');
            card.className = 'hero-card';
            card.innerHTML = \`<img src="\${hero.img}" alt="\${hero.name}"><h3>\${hero.name}</h3><p>\${hero.desc}</p>\`;
            card.onclick = () => this.selectHero(index);
            heroCards.appendChild(card);
        });
    },
    showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    },
    selectLevel(level) {
        this.state.level = level;
        this.showScreen('hero-screen');
    },
    selectHero(heroIndex) {
        this.state.hero = gameData.heroes[heroIndex];
        document.getElementById('game-character').src = this.state.hero.img;
        this.startGame();
    },
    startGame() {
        this.showScreen('game-screen');
        this.state.currentTask = 0;
        setTimeout(() => this.showNextTask(), 1500);
    },
    showNextTask() {
        if(this.state.currentTask >= gameData.tasks.length){
            alert('Поздравляем! Вы прошли квест! Ваш счет: ' + this.state.score);
            this.showScreen('start-screen');
            return;
        }
        const task = gameData.tasks[this.state.currentTask];
        document.getElementById('task-question').textContent = task.question;
        const taskBody = document.getElementById('task-body');
        if(task.type === 'choice') {
            taskBody.innerHTML = '<div class="task-options">' + task.options.map((opt, i) => \`<button class="game-btn" onclick="game.checkAnswer(\${i})">\${opt}</button>\`).join('') + '</div>';
        } else {
            taskBody.innerHTML = '<div class="task-options"><input type="text" id="text-answer" placeholder="Ваш ответ..."><button class="game-btn" onclick="game.checkAnswer()">Ответить</button></div>';
        }
        document.getElementById('task-modal').classList.add('active');
    },
    checkAnswer(answer) {
        const task = gameData.tasks[this.state.currentTask];
        let isCorrect = false;
        if(task.type === 'choice') {
            if(answer === task.correct) isCorrect = true;
        } else {
            const userAnswer = document.getElementById('text-answer').value;
            if(userAnswer.trim().toLowerCase() === task.correct.trim().toLowerCase()) isCorrect = true;
        }
        
        if(isCorrect) {
            document.getElementById('win-sound').play();
            this.state.score += 10;
        } else {
            document.getElementById('fail-sound').play();
        }
        
        document.getElementById('task-modal').classList.remove('active');
        this.state.currentTask++;
        setTimeout(() => this.showNextTask(), 1000);
    }
};
game.init();
<\/script></body></html>`;
            }
        });
    </script>
</body>
</html>
