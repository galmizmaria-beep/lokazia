<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</title>
    <style>
        :root{
            --bg-dark:#101820;
            --panel-bg:rgba(23,37,51,0.85);
            --accent-color:#00ffe7;
            --text-light:#e0e0e0;
            --text-dark:#333;
            --border-color:rgba(0,255,231,0.2);
            --hover-bg:rgba(0,255,231,0.05);
            --correct-color:#4ade80;
            --incorrect-color:#f87171;
            /* New Design Properties */
            --card-bg-image: linear-gradient(45deg,#00776b,#00bfa5);
            --card-bg-color: transparent;
            --dynamic-glow-color: var(--accent-color);
            --dynamic-glow-shadow: 0 0 15px var(--dynamic-glow-color);
        }
        html,body{width:100%;height:100%;margin:0;padding:0;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;}
        body{
            background-image:linear-gradient(180deg,#1a2a3a,#101820);
            color:var(--text-light);
            display:flex;justify-content:center;align-items:center;
        }
        .master-container{ width:100%; height:100%; display:flex; flex-direction:column; }
        .main-title{ text-align:center; color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); margin-bottom:20px; flex-shrink:0; }

        button{ background-color:transparent; color:var(--accent-color); border:1px solid var(--accent-color); padding:10px 15px; border-radius:6px; cursor:pointer; font-size:16px; font-weight:bold; transition:all .3s; }
        button:hover{ background-color:var(--accent-color); color:var(--bg-dark); box-shadow:0 0 15px var(--accent-color); }
        button:disabled{ background-color:#4a5568; border-color:#4a5568; color:#a0aec0; cursor:not-allowed; box-shadow:none; }

        input,textarea,select{ width:100%; padding:10px; border:1px solid var(--border-color); border-radius:4px; box-sizing:border-box; margin-top:5px; margin-bottom:10px; background-color:rgba(0,0,0,0.2); color:var(--text-light); transition:all .3s; }
        input:hover,textarea:hover,select:hover,input:focus,textarea:focus,select:focus{ border-color:var(--accent-color); box-shadow:0 0 5px var(--accent-color); outline:none; }
        input[type="color"] { padding: 0; height: 40px; border-radius: 8px; cursor: pointer; }
        input[type="range"] { padding: 0; }

        #editor-wrapper{ display:flex; gap:20px; height:100%; overflow:hidden; }
        #editor-panel{ flex:1; min-width:350px; max-width: 450px; }
        #preview-section{ flex:2.5; display:flex; flex-direction:column; }

        .editor-panel-inner{ background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:25px; backdrop-filter:blur(10px); height:100%; box-sizing:border-box; overflow-y:auto; }
        .editor-panel-inner h2, .editor-panel-inner h3{ color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); }

        .editor-section{ margin-bottom:15px; padding:10px; border-radius:8px; border:1px solid transparent; transition:all .3s; }
        .editor-section:hover{ background-color:var(--hover-bg); border-color:var(--border-color); }

        .question-block{ background:rgba(0,0,0,0.2); padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid var(--border-color); }
        .question-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .option-group{ display:flex; align-items:center; margin-bottom:8px; }

        .char-remove-btn-x{ position:absolute; top:-5px; right:-5px; width:22px; height:22px; border-radius:50%; background:#e53e3e; color:white; border:none; font-size:16px; font-weight:bold; display:flex; align-items:center; justify-content:center; cursor:pointer; padding:0; box-shadow:0 2px 4px rgba(0,0,0,.4); }

        #preview-iframe{ width:100%; flex-grow:1; border-radius:12px; border:1px solid var(--border-color); background-color:var(--bg-dark); }
        #iframe-code{ display:none; margin-top:10px; min-height:80px; font-size:12px; }

        /* --- GAME STYLES --- */
        #game-container{ width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; box-sizing:border-box; background:none; }
        #start-screen{ width:100%; max-width:700px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:30px; backdrop-filter:blur(10px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; box-sizing:border-box; }
        #game-title-display{ text-align:center; color:var(--accent-color); font-size:1.8em; margin:0; text-shadow:0 0 5px var(--accent-color); }
        #character-selector{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom: 20px; }
        #character-selector img{ width:80px; height:80px; border-radius:50%; border:3px solid transparent; cursor:pointer; object-fit:cover; transition:all .2s; }
        #character-selector img.selected{ border-color:var(--dynamic-glow-color); box-shadow:var(--dynamic-glow-shadow); transform:scale(1.05); }

        #game-process{ width:100%; height:100%; position:relative; padding:20px; box-sizing:border-box; display:block; }
        #game-ui-top{ position:absolute; top:20px; left:20px; right:20px; display:flex; justify-content:space-between; align-items:center; z-index: 100; }
        #lives-container{ display:flex; gap:5px; font-size:2.0em; }
        
        /* New Mission Layout */
        #current-mission-game-area { display: flex; align-items: center; justify-content: space-around; gap: 20px; width: 100%; height: 100%; }
        #character-display { position: relative; flex: 1; max-width: 40%; height: 90%; display: flex; justify-content: center; align-items: flex-end; }
        #player-char-img{ max-width:100%; max-height:100%; object-fit: contain; transition:transform .3s ease, filter .3s ease; }
        #player-char-img.correct-answer{ animation:jump-animation .6s ease; filter: drop-shadow(var(--dynamic-glow-shadow)); }
        #player-char-img.incorrect-answer{ animation:shake-animation .6s ease; filter: drop-shadow(0 0 15px var(--incorrect-color)); }

        #card-grid-area{ position: relative; flex: 1.5; max-width: 55%; height: 90%; overflow-y: auto; display:flex; flex-wrap: wrap; gap:15px; padding:10px; background:rgba(0,0,0,0.3); border-radius:8px; align-content: flex-start; justify-content: center; }
        .card{ width: 90px; height: 130px; background-image: var(--card-bg-image); background-color: var(--card-bg-color); background-size: cover; background-position: center; color:white; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:3em; font-weight:bold; cursor:pointer; transition: all 0.3s ease; box-shadow:0 5px 15px rgba(0,0,0,.3); position: relative; }
        .card:hover{ transform: translateY(-5px); box-shadow: 0 8px 20px var(--dynamic-glow-color); }
        .card.completed{ background: var(--correct-color); cursor: not-allowed; opacity: 0.6; color: transparent; pointer-events: none; }
        .card.completed::after { content: '‚úî'; font-size: 2.5em; color: white; position: absolute; }
        .card.incorrect-flash::after { content: '‚úñ'; position: absolute; font-size: 2.5em; color: white; animation: fade-out 0.8s ease-out forwards; }

        #question-modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter: blur(5px); display:flex; align-items:center; justify-content:center; z-index: 1000; }
        #question-modal-content{ background-color:#e0e0e0; color:var(--text-dark); padding:30px; border-radius:12px; min-width: 450px; max-width: 90vw; }
        .card-question{ font-size:1.2em; font-weight:bold; margin-bottom:20px; }
        .card-answers button, .card-input-area button{ width:100%; margin-bottom:10px; background-color:#f1f5f9; color:var(--text-dark); border:1px solid #ccc; text-align:left; padding:10px; }

        #end-screen{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; width:100%; max-width:700px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:30px; box-sizing:border-box; }
        #end-screen .end-player{ width:160px; height:160px; border-radius:12px; display:flex; align-items:center; justify-content:center; }

        .hidden{ display:none !important; }

        @keyframes jump-animation{ 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-30px);} }
        @keyframes shake-animation{ 0%,100%{ transform:translateX(0);} 25%{ transform:translateX(-12px) rotate(-3deg);} 75%{ transform:translateX(12px) rotate(3deg);} }
        @keyframes fade-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(1.5); } }
        @keyframes pulse-animation { 0% { box-shadow: var(--dynamic-glow-shadow); } 50% { box-shadow: 0 0 25px var(--dynamic-glow-color); } 100% { box-shadow: var(--dynamic-glow-shadow); } }

        #map-area { position: absolute; inset: 0; }
        .mission-map-icon { position: absolute; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: transform 0.3s ease; z-index: 20; transform: translate(-50%, -50%); }
        .mission-map-icon img { width: 60px; height: 60px; object-fit: cover; border-radius: 50%; border: 3px solid var(--dynamic-glow-color); }
        .mission-map-icon span { font-size: 0.9em; color: white; text-shadow: 0 0 5px black; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 4px; }
        .mission-map-icon:not(.locked):hover { transform: scale(1.2) translate(-41%, -41%); }
        .mission-map-icon.active { animation: pulse-animation 1.5s ease-in-out infinite; }
        .mission-map-icon.completed { filter: grayscale(100%) brightness(0.7); opacity: 0.8; pointer-events: none; }
        .mission-map-icon.locked { pointer-events: none; filter: grayscale(80%) brightness(0.5); opacity: 0.7; }
        .mission-map-icon.locked::before { content: 'üîí'; position: absolute; font-size: 2.5em; color: white; z-index: 10; }

        #mission-description-panel { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px 20px; max-width: 80%; text-align: center; z-index: 60; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease; }
        #mission-description-panel:not(.hidden) { opacity: 1; visibility: visible; }
        #mission-description-panel h3 { margin-top: 0; color: var(--accent-color); }
        #mission-description-panel p { margin-bottom: 0; min-height: 1.2em; }

        .mission-upload-group { background:rgba(0,0,0,0.2); padding:10px; border-radius:6px; border:1px solid var(--border-color); margin-bottom:15px; }
        .mission-header { display: flex; align-items: center; gap: 10px; position: relative; }
        .mission-header img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .mission-details { flex-grow: 1; }
        details.mission-questions-details { margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        details summary { cursor: pointer; color: var(--accent-color); font-weight: bold; }
        
        #difficulty-selector button.selected { background-color: var(--dynamic-glow-color); color: var(--bg-dark); box-shadow: var(--dynamic-glow-shadow); transform: scale(1.05); }

        #mission-map-screen, #current-mission-game-area {
             background-image: var(--map-bg-image, linear-gradient(180deg,#1a2a3a,#101820)); 
             background-size: cover; 
             background-position: center; 
             width: 100%; height: 100%; position: relative;
        }
    </style>
</head>
<body>
    <div class="master-container">
        <h1 class="main-title">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</h1>

        <div id="editor-wrapper">
            <div id="editor-panel">
                <div class="editor-panel-inner">
                    <div class="editor-section">
                        <h2 data-lang-key="editor_title_game">1. –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</h2>
                        <input type="text" id="game-title" value="–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è!">
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_lang_heading">2. –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</h2>
                        <select id="language-select">
                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_map_heading">3. –ö–∞—Ä—Ç–∞</h2>
                        <label for="map-bg-upload" data-lang-key="editor_upload_map_bg">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω –∫–∞—Ä—Ç—ã</label>
                        <input type="file" id="map-bg-upload" accept="image/*">
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_design_heading">4. –î–∏–∑–∞–π–Ω</h2>
                        <label for="card-bg-upload" data-lang-key="design_card_bg">–§–æ–Ω –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫</label>
                        <input type="file" id="card-bg-upload" accept="image/*">
                        <label for="card-color-picker" data-lang-key="design_card_color">–¶–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ (–µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ–Ω–∞)</label>
                        <input type="color" id="card-color-picker" value="#00bfa5">
                        <label for="glow-color-picker" data-lang-key="design_glow_color">–¶–≤–µ—Ç —Å–≤–µ—á–µ–Ω–∏—è</label>
                        <input type="color" id="glow-color-picker" value="#00ffe7">
                        <label for="glow-intensity-slider" data-lang-key="design_glow_intensity">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Å–≤–µ—á–µ–Ω–∏—è</label>
                        <input type="range" id="glow-intensity-slider" min="5" max="30" value="15">
                    </div>
                    
                    <div class="editor-section">
                        <h2 data-lang-key="editor_missions_heading">5. –ú–∏—Å—Å–∏–∏ –∏ –ó–∞–¥–∞–Ω–∏—è (–¥–æ 5)</h2>
                        <div id="missions-container"></div>
                        <button id="add-mission-btn" data-lang-key="editor_add_mission">–î–æ–±–∞–≤–∏—Ç—å –º–∏—Å—Å–∏—é</button>
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_characters_heading">6. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
                        <div id="characters-container"></div>
                        <button id="add-character-btn" data-lang-key="editor_add_char">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                    </div>
                    
                    <div class="editor-section">
                        <h2 data-lang-key="editor_music_heading">7. –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞</h2>
                        <input type="file" id="bg-music-upload" accept="audio/*">
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_difficulty_settings_heading">8. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∂–∏–∑–Ω–µ–π</h2>
                        <div>
                            <label for="easy-lives"><span data-lang-key="difficulty_easy">–õ–µ–≥–∫–∏–π</span>:</label>
                            <input type="number" id="easy-lives" value="5" min="1">
                        </div>
                        <div>
                            <label for="medium-lives"><span data-lang-key="difficulty_medium">–°—Ä–µ–¥–Ω–∏–π</span>:</label>
                            <input type="number" id="medium-lives" value="3" min="1">
                        </div>
                        <div>
                            <label for="hard-lives"><span data-lang-key="difficulty_hard">–°–ª–æ–∂–Ω—ã–π</span>:</label>
                            <input type="number" id="hard-lives" value="1" min="1">
                        </div>
                    </div>
                </div>
            </div>

            <div id="preview-section">
                <iframe id="preview-iframe"></iframe>
                <button id="generate-code-btn" data-lang-key="editor_generate">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                <textarea id="iframe-code"></textarea>
            </div>
        </div>

        <div id="game-container" class="hidden">
            <div id="start-screen" class="game-frame">
                <h1 id="game-title-display"></h1>
                <h2 data-lang-key="game_select_char">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</h2>
                <div id="character-selector"></div>
                <h2 data-lang-key="game_select_difficulty">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</h2>
                <div id="difficulty-selector">
                    <button data-difficulty="easy" data-lang-key="difficulty_easy">–õ–µ–≥–∫–∏–π</button>
                    <button data-difficulty="medium" data-lang-key="difficulty_medium">–°—Ä–µ–¥–Ω–∏–π</button>
                    <button data-difficulty="hard" data-lang-key="difficulty_hard">–°–ª–æ–∂–Ω—ã–π</button>
                </div>
                <button id="start-game-btn" disabled data-lang-key="game_start">–ù–∞—á–∞—Ç—å!</button>
            </div>

            <div id="game-process" class="hidden">
                <div id="mission-map-screen" class="hidden">
                    <div id="game-ui-top">
                         <div id="lives-container"></div>
                         <audio id="game-bg-music" loop></audio>
                    </div>
                    <div id="map-area"></div>
                    <div id="mission-description-panel" class="hidden">
                        <h3 id="current-mission-title"></h3>
                        <p id="current-mission-description"></p>
                    </div>
                </div>

                <div id="current-mission-game-area" class="hidden">
                     <div id="game-ui-top"><div id="lives-container"></div></div>
                    <div id="character-display"><img id="player-char-img" src=""></div>
                    <div id="card-grid-area"></div>
                </div>

                <div id="question-modal-overlay" class="hidden">
                    <div id="question-modal-content">
                        <div class="card-question"></div>
                        <div class="card-content-area"></div>
                    </div>
                </div>
            </div>

            <div id="end-screen" class="hidden">
                <div class="end-player"><img id="end-player-img" src=""></div>
                <h2 id="end-title">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
                <button onclick="window.location.reload()" data-lang-key="game_play_again">–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const isPlayerMode = urlParams.get('mode') === 'player';
    
    let gameDataUrls = {
        mapBackground: null,
        cardBackground: null,
        backgroundMusic: null,
    };
    let isCodeGenerated = false;

    const translations = {
        ru: {
            editor_title_game: "1. –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã",
            editor_lang_heading: "2. –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
            editor_map_heading: "3. –ö–∞—Ä—Ç–∞",
            editor_upload_map_bg: "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω –∫–∞—Ä—Ç—ã",
            editor_design_heading: "4. –î–∏–∑–∞–π–Ω",
            design_card_bg: "–§–æ–Ω –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫",
            design_card_color: "–¶–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ (–µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ–Ω–∞)",
            design_glow_color: "–¶–≤–µ—Ç —Å–≤–µ—á–µ–Ω–∏—è",
            design_glow_intensity: "–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Å–≤–µ—á–µ–Ω–∏—è",
            editor_missions_heading: "5. –ú–∏—Å—Å–∏–∏ –∏ –ó–∞–¥–∞–Ω–∏—è (–¥–æ 5)",
            editor_add_mission: "–î–æ–±–∞–≤–∏—Ç—å –º–∏—Å—Å–∏—é",
            mission_name_placeholder: "–ù–∞–∑–≤–∞–Ω–∏–µ –º–∏—Å—Å–∏–∏",
            mission_desc_placeholder: "–û–ø–∏—Å–∞–Ω–∏–µ –º–∏—Å—Å–∏–∏",
            mission_icon_upload_label: "–ò–∫–æ–Ω–∫–∞",
            mission_questions_heading: "–ó–∞–¥–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–π –º–∏—Å—Å–∏–∏",
            editor_characters_heading: "6. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏",
            editor_add_char: "–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞",
            editor_music_heading: "7. –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞",
            editor_difficulty_settings_heading: "8. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∂–∏–∑–Ω–µ–π",
            editor_add_q: "–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å",
            editor_generate: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥",
            editor_copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
            editor_copied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
            q_placeholder: "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞...",
            q_option_placeholder: "–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞",
            q_text_answer_placeholder: "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç...",
            q_add_option: "+ –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç",
            q_remove_q: "–£–¥–∞–ª–∏—Ç—å",
            q_type_mc: "–û–¥–∏–Ω –∏–∑ –º–Ω–æ–≥–∏—Ö",
            q_type_text: "–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞",
            no_characters_warning: "–°–æ–∑–¥–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!",
            no_missions_warning: "–°–æ–∑–¥–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –º–∏—Å—Å–∏—é!",
            no_questions_warning: "–î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞–Ω–∏—è –≤ –º–∏—Å—Å–∏–∏!",
            game_select_char: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:",
            game_select_difficulty: "–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:",
            game_start: "–ù–∞—á–∞—Ç—å!",
            game_check: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å",
            game_end_win: "–¢–´ –ü–û–ë–ï–î–ò–õ!",
            game_end_lose: "–¢–´ –ü–†–û–ò–ì–†–ê–õ!",
            game_play_again: "–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑",
            difficulty_easy: "–õ–µ–≥–∫–∏–π",
            difficulty_medium: "–°—Ä–µ–¥–Ω–∏–π",
            difficulty_hard: "–°–ª–æ–∂–Ω—ã–π",
            all_missions_completed: "–í—Å–µ –º–∏—Å—Å–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!"
        },
        en: {
            editor_title_game: "1. Game Title",
            editor_lang_heading: "2. Interface Language",
            editor_map_heading: "3. Map",
            editor_upload_map_bg: "Upload map background",
            editor_design_heading: "4. Design",
            design_card_bg: "Card background",
            design_card_color: "Card color (if no background)",
            design_glow_color: "Glow color",
            design_glow_intensity: "Glow intensity",
            editor_missions_heading: "5. Missions & Questions (up to 5)",
            editor_add_mission: "Add Mission",
            mission_name_placeholder: "Mission Name",
            mission_desc_placeholder: "Mission Description",
            mission_icon_upload_label: "Icon",
            mission_questions_heading: "Questions for this mission",
            editor_characters_heading: "6. Characters",
            editor_add_char: "Add Character",
            editor_music_heading: "7. Background Music",
            editor_difficulty_settings_heading: "8. Lives Settings",
            editor_add_q: "Add Question",
            editor_generate: "Generate Code",
            editor_copy: "Copy",
            editor_copied: "Copied!",
            q_placeholder: "Question text...",
            q_option_placeholder: "Answer option",
            q_text_answer_placeholder: "Correct answer...",
            q_add_option: "+ Add Option",
            q_remove_q: "Delete",
            q_type_mc: "Multiple Choice",
            q_type_text: "Text Input",
            no_characters_warning: "Create at least one character!",
            no_missions_warning: "Create at least one mission!",
            no_questions_warning: "Add questions to your missions!",
            game_select_char: "Select a Character:",
            game_select_difficulty: "Select Difficulty Level:",
            game_start: "Start!",
            game_check: "Check",
            game_end_win: "YOU WIN!",
            game_end_lose: "YOU LOSE!",
            game_play_again: "Play Again",
            difficulty_easy: "Easy",
            difficulty_medium: "Medium",
            difficulty_hard: "Hard",
            all_missions_completed: "All Missions Completed!"
        }
    };

    const MISSION_POSITIONS = [ { x: 25, y: 20 }, { x: 75, y: 20 }, { x: 50, y: 50 }, { x: 25, y: 80 }, { x: 75, y: 80 } ];

    let gameConfig = {};
    let gameState = { lang: 'ru', character: '', difficulty: null, globalLives: 0, completedMissions: new Set() };
    
    if (isPlayerMode) {
        document.getElementById('editor-wrapper').style.display = 'none';
        document.querySelector('.main-title').style.display = 'none';
        document.body.style.padding = '0';
        document.getElementById('game-container').classList.remove('hidden');
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'gameConfig') {
                initGame(event.data.config);
            }
        });
    } else {
        initEditor();
    }

    function updateUI(lang) {
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            const translation = translations[lang]?.[key];
            if (!translation) return;
            if (el.placeholder !== undefined) el.placeholder = translation;
            else el.textContent = translation;
        });
    }

    function initEditor() {
        document.getElementById('language-select').addEventListener('change', (e) => updateUI(e.target.value));
        document.getElementById('add-character-btn').addEventListener('click', addCharacterInput);
        document.getElementById('add-mission-btn').addEventListener('click', addMissionBlock);
        document.getElementById('generate-code-btn').addEventListener('click', handleGenerateCodeClick);
        ['input', 'change'].forEach(evt => document.getElementById('editor-panel').addEventListener(evt, updatePreview));

        const previewIframe = document.getElementById('preview-iframe');
        previewIframe.src = `${window.location.pathname}?mode=player`;
        previewIframe.onload = () => updatePreview();
        addCharacterInput(); 
        addMissionBlock();
        updateUI('ru');
    }

    function collectConfig() {
        const missions = Array.from(document.getElementById('missions-container').children).map(block => {
            const questions = Array.from(block.querySelectorAll('.question-block')).map(qBlock => {
                const questionType = qBlock.querySelector('.question-type-select').value;
                const question = { type: questionType, question: qBlock.querySelector('.question-text').value };
                if (questionType === 'multiple-choice') {
                    question.options = Array.from(qBlock.querySelectorAll('.option-text')).map(i => i.value);
                    const correctInput = qBlock.querySelector('input[type="radio"]:checked');
                    question.answer = correctInput ? parseInt(correctInput.value, 10) : 0;
                } else {
                    question.answer = qBlock.querySelector('.text-answer-input').value;
                }
                return question;
            }).filter(q => q.question);
            return {
                name: block.querySelector('.mission-name-input').value,
                description: block.querySelector('.mission-desc-input').value,
                iconUrl: block.querySelector('img').src.includes('placehold.co') ? null : block.querySelector('img').src,
                questions: questions,
            };
        }).filter(m => m.name && m.questions.length > 0);

        return {
            lang: document.getElementById('language-select').value,
            title: document.getElementById('game-title').value,
            characters: Array.from(document.getElementById('characters-container').querySelectorAll('img')).map(img => img.src).filter(src => !src.includes('placehold.co')),
            difficultySettings: {
                easy: { lives: parseInt(document.getElementById('easy-lives').value, 10) },
                medium: { lives: parseInt(document.getElementById('medium-lives').value, 10) },
                hard: { lives: parseInt(document.getElementById('hard-lives').value, 10) },
            },
            design: {
                cardBackground: gameDataUrls.cardBackground,
                cardColor: document.getElementById('card-color-picker').value,
                glowColor: document.getElementById('glow-color-picker').value,
                glowIntensity: document.getElementById('glow-intensity-slider').value,
                mapBackground: gameDataUrls.mapBackground,
            },
            music: gameDataUrls.backgroundMusic,
            missions: missions,
        };
    }

    function updatePreview() {
        const config = collectConfig();
        const previewIframe = document.getElementById('preview-iframe');
        if (previewIframe.contentWindow) {
            previewIframe.contentWindow.postMessage({ type: 'gameConfig', config }, '*');
        }
        isCodeGenerated = false;
        document.getElementById('generate-code-btn').textContent = translations[config.lang].editor_generate;
    }

    function handleGenerateCodeClick() {
        const codeTextarea = document.getElementById('iframe-code');
        const btn = document.getElementById('generate-code-btn');
        const lang = document.getElementById('language-select').value;
        if (!isCodeGenerated) {
            const config = collectConfig();
            const configString = JSON.stringify(config).replace(/</g, '\\u003c');
            codeTextarea.value = `<div style="position:relative;width:100%;padding-bottom:56.25%;"><iframe id="game-iframe-123" src="${window.location.href.split('?')[0]}?mode=player" frameborder="0" style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div><script>(function(){var iframe=document.getElementById('game-iframe-123');var gameConfig=${configString};iframe.onload=function(){iframe.contentWindow.postMessage({type:'gameConfig',config:gameConfig},'*');};})();<\/script>`;
            codeTextarea.style.display = 'block';
            btn.textContent = translations[lang].editor_copy;
            isCodeGenerated = true;
        } else {
            codeTextarea.select();
            navigator.clipboard.writeText(codeTextarea.value).then(() => {
                btn.textContent = translations[lang].editor_copied;
                setTimeout(() => { btn.textContent = translations[lang].editor_copy; }, 2000);
            });
        }
    }
    
    function createFileHandler(urlKey, previewImgId = null) {
        return (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    gameDataUrls[urlKey] = e.target.result;
                    if(previewImgId) document.getElementById(previewImgId).src = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(file);
            }
        };
    }
    document.getElementById('map-bg-upload').addEventListener('change', createFileHandler('mapBackground'));
    document.getElementById('card-bg-upload').addEventListener('change', createFileHandler('cardBackground'));
    document.getElementById('bg-music-upload').addEventListener('change', createFileHandler('backgroundMusic'));

    function addCharacterInput() {
        const container = document.getElementById('characters-container');
        const uniqueId = `char-${Date.now()}`;
        const group = document.createElement('div');
        group.className = 'character-upload-group';
        group.style = "display:flex; align-items:center; gap:10px; position:relative;";
        group.innerHTML = `<img src="https://placehold.co/40x40/101820/00ffe7?text=+" alt="preview" id="preview-${uniqueId}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;"><input type="file" id="${uniqueId}" accept="image/*" style="display:none;"><label for="${uniqueId}" style="flex-grow:1;text-align:center;background-color:#4a5568;padding:8px;border-radius:5px;cursor:pointer;" data-lang-key="editor_add_char">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label><button type="button" class="char-remove-btn-x">&times;</button>`;
        container.appendChild(group);
        group.querySelector('.char-remove-btn-x').onclick = () => { group.remove(); updatePreview(); };
        document.getElementById(uniqueId).addEventListener('change', createFileHandler(null, `preview-${uniqueId}`));
    }
    
    function addMissionBlock() {
        const container = document.getElementById('missions-container');
        const addBtn = document.getElementById('add-mission-btn');
        if (container.children.length >= 5) {
            addBtn.disabled = true;
            return;
        }
        const uniqueId = Date.now();
        const block = document.createElement('div');
        block.className = 'mission-upload-group';
        const lang = document.getElementById('language-select').value;
        const t = translations[lang];

        block.innerHTML = `
            <div class="mission-header">
                <img src="https://placehold.co/50x50/101820/00ffe7?text=M" id="mission-icon-${uniqueId}">
                <div class="mission-details">
                    <input type="text" class="mission-name-input" placeholder="${t.mission_name_placeholder}" value="${t.mission_name_placeholder} ${container.children.length + 1}">
                    <textarea class="mission-desc-input" placeholder="${t.mission_desc_placeholder}" rows="2"></textarea>
                    <input type="file" id="mission-file-${uniqueId}" accept="image/*" style="display:none;">
                    <label for="mission-file-${uniqueId}" class="button-like" data-lang-key="mission_icon_upload_label">${t.mission_icon_upload_label}</label>
                </div>
                <button type="button" class="char-remove-btn-x">&times;</button>
            </div>
            <details class="mission-questions-details">
                <summary data-lang-key="mission_questions_heading">${t.mission_questions_heading}</summary>
                <div class="mission-questions-container"></div>
                <button type="button" class="add-question-to-mission-btn" data-lang-key="editor_add_q">${t.editor_add_q}</button>
            </details>
        `;
        container.appendChild(block);

        block.querySelector('.char-remove-btn-x').onclick = () => {
            block.remove();
            document.getElementById('add-mission-btn').disabled = false;
            updatePreview();
        };
        block.querySelector('.add-question-to-mission-btn').onclick = (e) => {
            addQuestionBlock(e.target.closest('details').querySelector('.mission-questions-container'));
        };
        document.getElementById(`mission-file-${uniqueId}`).addEventListener('change', createFileHandler(null, `mission-icon-${uniqueId}`));
        if (container.children.length >= 5) addBtn.disabled = true;
    }

    function addQuestionBlock(container) {
        const qIndex = Date.now();
        const block = document.createElement('div');
        block.className = 'question-block';
        const lang = document.getElementById('language-select').value;
        const t = translations[lang];

        block.innerHTML = `
            <div class="question-header">
                <span>–í–æ–ø—Ä–æ—Å ${container.children.length + 1}</span>
                <button type="button" class="remove-question-btn" data-lang-key="q_remove_q">${t.q_remove_q}</button>
            </div>
            <select class="question-type-select"><option value="multiple-choice">${t.q_type_mc}</option><option value="text-input">${t.q_type_text}</option></select>
            <textarea class="question-text" placeholder="${t.q_placeholder}"></textarea>
            <div class="mc-options">
                <div class="options-container"></div>
                <button type="button" class="add-option-btn">${t.q_add_option}</button>
            </div>
            <div class="text-input-option hidden"><input type="text" class="text-answer-input" placeholder="${t.q_text_answer_placeholder}"></div>
        `;
        container.appendChild(block);

        const typeSelect = block.querySelector('.question-type-select');
        typeSelect.onchange = () => {
            const isMc = typeSelect.value === 'multiple-choice';
            block.querySelector('.mc-options').classList.toggle('hidden', !isMc);
            block.querySelector('.text-input-option').classList.toggle('hidden', isMc);
        };
        
        block.querySelector('.remove-question-btn').onclick = () => { block.remove(); updatePreview(); };
        const optionsContainer = block.querySelector('.options-container');
        block.querySelector('.add-option-btn').onclick = () => addOption(optionsContainer, qIndex);
        addOption(optionsContainer, qIndex); addOption(optionsContainer, qIndex);
        optionsContainer.querySelector('input[type="radio"]').checked = true;
    }

    function addOption(container, qIndex) {
        const optionIndex = container.children.length;
        const group = document.createElement('div');
        group.className = 'option-group';
        const lang = document.getElementById('language-select').value;
        group.innerHTML = `<input type="radio" name="correct_q${qIndex}" value="${optionIndex}"><input type="text" class="option-text" placeholder="${translations[lang].q_option_placeholder} ${optionIndex+1}">`;
        container.appendChild(group);
    }
    
    // GAME FUNCTIONS
    function initGame(config) {
        gameConfig = config;
        gameState.lang = config.lang || 'ru';
        updateUI(gameState.lang);

        const d = config.design;
        const root = document.documentElement;
        root.style.setProperty('--map-bg-image', d.mapBackground ? `url('${d.mapBackground}')` : '');
        root.style.setProperty('--card-bg-image', d.cardBackground ? `url('${d.cardBackground}')` : '');
        root.style.setProperty('--card-bg-color', d.cardColor || 'transparent');
        root.style.setProperty('--dynamic-glow-color', d.glowColor || '#00ffe7');
        root.style.setProperty('--dynamic-glow-shadow', `0 0 ${d.glowIntensity || 15}px ${d.glowColor || '#00ffe7'}`);

        document.getElementById('game-title-display').textContent = config.title;
        const charSelector = document.getElementById('character-selector');
        charSelector.innerHTML = '';
        if (config.characters?.length > 0) {
            config.characters.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.onclick = () => {
                    charSelector.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
                    img.classList.add('selected');
                    gameState.character = url;
                    checkStartButton();
                };
                charSelector.appendChild(img);
            });
        }
        document.querySelectorAll('#difficulty-selector button').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('#difficulty-selector button').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                gameState.difficulty = btn.dataset.difficulty;
                checkStartButton();
            };
        });
        document.getElementById('start-game-btn').onclick = startGame;
        checkStartButton();
    }

    function checkStartButton() {
        const btn = document.getElementById('start-game-btn');
        const canStart = gameState.character && gameState.difficulty && gameConfig.missions?.length > 0;
        btn.disabled = !canStart;
        
        let warning = document.getElementById('start-warning-msg');
        if (!canStart && !warning) {
            warning = document.createElement('p');
            warning.id = 'start-warning-msg';
            warning.style.color = 'red';
            btn.before(warning);
        }
        if (warning) {
            let msg = '';
            if (!gameState.character) msg = translations[gameState.lang].no_characters_warning;
            else if (!gameConfig.missions?.length > 0) msg = translations[gameState.lang].no_missions_warning;
            warning.textContent = msg;
        }
    }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-process').classList.remove('hidden');
        document.getElementById('player-char-img').src = gameState.character;

        gameState.globalLives = gameConfig.difficultySettings[gameState.difficulty].lives;
        gameState.completedMissions.clear();
        
        const music = document.getElementById('game-bg-music');
        if(gameConfig.music) {
            music.src = gameConfig.music;
            music.play().catch(()=>{});
        }
        showMissionMap();
    }

    function updateLivesDisplay() {
        document.querySelectorAll('#lives-container').forEach(container => {
            container.innerHTML = Array(gameState.globalLives).fill('<span>‚ù§Ô∏è</span>').join('');
        });
    }

    function loseLife() {
        if(gameState.globalLives > 0) gameState.globalLives--;
        updateLivesDisplay();
        if (gameState.globalLives <= 0) setTimeout(() => endGame('lose'), 700);
    }

    function showMissionMap() {
        document.getElementById('current-mission-game-area').classList.add('hidden');
        document.getElementById('mission-map-screen').classList.remove('hidden');
        updateLivesDisplay();

        const mapArea = document.getElementById('map-area');
        mapArea.innerHTML = '';
        const firstUncompleted = gameConfig.missions.findIndex((_, idx) => !gameState.completedMissions.has(idx));

        gameConfig.missions.slice(0, 5).forEach((mission, index) => {
            const iconDiv = document.createElement('div');
            iconDiv.className = 'mission-map-icon';
            const pos = MISSION_POSITIONS[index];
            iconDiv.style.left = `${pos.x}%`;
            iconDiv.style.top = `${pos.y}%`;
            iconDiv.innerHTML = `<img src="${mission.iconUrl || 'https://placehold.co/60x60/333/eee?text=M' + (index + 1)}"><span>${mission.name}</span>`;

            if (gameState.completedMissions.has(index)) iconDiv.classList.add('completed');
            else if (index > firstUncompleted) iconDiv.classList.add('locked');
            else if (index === firstUncompleted) iconDiv.classList.add('active');

            if (index === firstUncompleted) {
                iconDiv.onmouseenter = () => displayMissionDescription(mission);
                iconDiv.onmouseleave = () => document.getElementById('mission-description-panel').classList.add('hidden');
                iconDiv.onclick = () => startMission(index);
            }
            mapArea.appendChild(iconDiv);
        });
    }

    function displayMissionDescription(mission) {
        const panel = document.getElementById('mission-description-panel');
        panel.querySelector('h3').textContent = mission.name;
        typewriter(panel.querySelector('p'), mission.description || '');
        panel.classList.remove('hidden');
    }

    function startMission(missionIndex) {
        document.getElementById('mission-map-screen').classList.add('hidden');
        document.getElementById('current-mission-game-area').classList.remove('hidden');
        updateLivesDisplay();
        
        gameState.currentMissionIndex = missionIndex;
        gameState.currentMissionQuestions = gameConfig.missions[missionIndex].questions;
        gameState.completedCardsInMission = 0;

        const cardGrid = document.getElementById('card-grid-area');
        cardGrid.innerHTML = '';
        gameState.currentMissionQuestions.forEach((_, i) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.qindex = i;
            card.innerHTML = `<span>${i + 1}</span>`;
            card.onclick = () => showQuestionModal(i);
            cardGrid.appendChild(card);
        });
    }
    
    let typeWriterTimeout;
    function typewriter(element, text, speed = 40) {
        clearTimeout(typeWriterTimeout);
        element.innerHTML = "";
        let i = 0;
        function type() { if (i < text.length) { element.innerHTML += text.charAt(i++); typeWriterTimeout = setTimeout(type, speed); } }
        type();
    }

    function showQuestionModal(qIndex) {
        const qData = gameState.currentMissionQuestions[qIndex];
        const modal = document.getElementById('question-modal-overlay');
        modal.querySelector('.card-question').textContent = qData.question;
        const content = modal.querySelector('.card-content-area');
        content.innerHTML = '';

        if (qData.type === 'multiple-choice') {
            content.className = 'card-content-area card-answers';
            qData.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.textContent = opt;
                btn.onclick = () => handleAnswer(qIndex, i === qData.answer, btn);
                content.appendChild(btn);
            });
        } else {
            content.className = 'card-content-area card-input-area';
            content.innerHTML = `<input type="text"><button data-lang-key="game_check">${translations[gameState.lang].game_check}</button>`;
            content.querySelector('button').onclick = () => {
                const answer = content.querySelector('input').value;
                const correct = answer.trim().toLowerCase() === qData.answer.trim().toLowerCase();
                handleAnswer(qIndex, correct, content.querySelector('button'));
            };
        }
        modal.classList.remove('hidden');
    }

    function handleAnswer(qIndex, isCorrect, buttonEl) {
        const playerImg = document.getElementById('player-char-img');
        playerImg.classList.remove('correct-answer', 'incorrect-answer');
        void playerImg.offsetWidth;
        
        if (isCorrect) {
            playerImg.classList.add('correct-answer');
            setTimeout(() => {
                document.getElementById('question-modal-overlay').classList.add('hidden');
                document.querySelector(`.card[data-qindex="${qIndex}"]`).classList.add('completed');
                gameState.completedCardsInMission++;
                if (gameState.completedCardsInMission >= gameState.currentMissionQuestions.length) {
                    completeMission(gameState.currentMissionIndex);
                }
            }, 800);
        } else {
            playerImg.classList.add('incorrect-answer');
            const cardEl = document.querySelector(`.card[data-qindex="${qIndex}"]`);
            if (cardEl) {
                cardEl.classList.add('incorrect-flash');
                setTimeout(() => cardEl.classList.remove('incorrect-flash'), 800);
            }
            setTimeout(() => {
                document.getElementById('question-modal-overlay').classList.add('hidden');
                loseLife();
            }, 800);
        }
    }

    function completeMission(missionIndex) {
        gameState.completedMissions.add(missionIndex);
        if (gameState.completedMissions.size >= gameConfig.missions.length) {
            setTimeout(() => endGame('win'), 1000);
        } else {
            setTimeout(showMissionMap, 1000);
        }
    }

    function endGame(status) {
        document.getElementById('game-process').classList.add('hidden');
        const endScreen = document.getElementById('end-screen');
        endScreen.classList.remove('hidden');
        document.getElementById('end-player-img').src = gameState.character;
        const titleKey = status === 'win' ? 'all_missions_completed' : 'game_end_lose';
        document.getElementById('end-title').textContent = translations[gameState.lang][titleKey];
    }
});
</script>
</body>
</html>
