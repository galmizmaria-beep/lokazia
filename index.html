<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</title>
    <style>
        :root {
            --bg-dark: #101820;
            --panel-bg: rgba(23, 37, 51, 0.85);
            --accent-color: #00ffe7;
            --text-light: #e0e0e0;
            --text-dark: #333;
            --border-color: rgba(0, 255, 231, 0.2);
            --hover-bg: rgba(0, 255, 231, 0.05);
            --correct-color: #4ade80;
            --incorrect-color: #f87171;
        }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-image: linear-gradient(180deg, #1a2a3a, #101820);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .master-container {
            width: 95vw; max-width: 1400px; height: calc(95vw * 9 / 16); max-height: 95vh;
            display: flex; flex-direction: column;
        }
        .main-title {
            text-align: center; color: var(--accent-color); text-shadow: 0 0 5px var(--accent-color);
            margin-bottom: 20px; flex-shrink: 0;
        }
        button {
            background-color: transparent; color: var(--accent-color); border: 1px solid var(--accent-color);
            padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s;
        }
        button:hover { background-color: var(--accent-color); color: var(--bg-dark); box-shadow: 0 0 15px var(--accent-color); }
        button:disabled { background-color: #4a5568; border-color: #4a5568; color: #a0aec0; cursor: not-allowed; box-shadow: none; }

        input, textarea, select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;
            box-sizing: border-box; margin-top: 5px; margin-bottom: 10px; background-color: rgba(0,0,0,0.2);
            color: var(--text-light); transition: all 0.3s;
        }
        input:hover, textarea:hover, select:hover, input:focus, textarea:focus, select:focus {
            border-color: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); outline: none;
        }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .checkbox-group input[type="checkbox"] { width: auto; margin: 0; }

        #editor-wrapper { display: flex; gap: 20px; height: 100%; overflow: hidden; }
        #editor-panel { flex: 1; min-width: 350px; }
        #preview-section { flex: 1.5; display: flex; flex-direction: column; }

        .editor-panel-inner {
            background-color: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 12px;
            padding: 25px; backdrop-filter: blur(10px); height: 100%; box-sizing: border-box;
            overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--accent-color) transparent;
        }
        .editor-panel-inner h2 { color: var(--accent-color); text-shadow: 0 0 5px var(--accent-color); }

        .editor-section { margin-bottom: 15px; padding: 10px; border-radius: 8px; border: 1px solid transparent; transition: all 0.3s; }
        .editor-section:hover { background-color: var(--hover-bg); border-color: var(--border-color); }

        .question-block { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .option-group { display: flex; align-items: center; margin-bottom: 8px; }
        .option-group input[type="radio"] { width: auto; margin-right: 10px; margin-top: 0; }

        .character-upload-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; position: relative; }
        .character-upload-group img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .character-upload-group input[type="file"] { display: none; }
        .character-upload-group label { background-color: #4a5568; color: white; padding: 8px 12px; border-radius: 5px; cursor: pointer; text-align: center; flex-grow: 1; }
        .char-remove-btn-x {
            position: absolute; top: -5px; right: -5px; width: 22px; height: 22px; border-radius: 50%;
            background: #e53e3e; color: white; border: none; font-size: 16px; font-weight: bold;
            display: flex; justify-content: center; align-items: center; cursor: pointer; line-height: 1;
            padding: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }

        .question-buttons { display: flex; gap: 10px; margin-top: 15px; }

        #preview-iframe { width: 100%; flex-grow: 1; border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--bg-dark); }
        #generate-code-wrapper { margin-top: 20px; }
        #iframe-code { display: none; margin-top: 10px; min-height: 80px; font-size: 12px; }

        /* --- –°–¢–ò–õ–ò –ò–ì–†–´ --- */
        #game-container {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; box-sizing: border-box; background: none;
        }
        .game-frame {
            width: 100%; max-width: 500px; background-color: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 30px; backdrop-filter: blur(10px);
        }
        #start-screen h2 { color: var(--accent-color); margin-top: 1em; margin-bottom: 0.5em; }
        #start-screen img {
            width: 80px; height: 80px; border: 3px solid transparent; border-radius: 50%;
            cursor: pointer; transition: all 0.3s; object-fit: cover; margin: 5px;
        }
        #start-screen img:hover { transform: scale(1.1); }
        #start-screen img.selected { border-color: var(--accent-color); transform: scale(1.1); box-shadow: 0 0 10px var(--accent-color); }

        #game-process { width: 100%; height: 100%; position: relative; padding: 20px; box-sizing: border-box; }
        #game-ui-top { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; }
        #lives-container { display: flex; gap: 5px; font-size: 2.5em; }
        .life-heart.lost { animation: flash-out 0.5s ease-out forwards; }
        #timer-display { font-size: 2em; color: var(--accent-color); text-shadow: 0 0 5px var(--accent-color); }

        #character-display {
            position: absolute; bottom: 5%; left: 10%; width: 25%; height: 50%;
            display: flex; justify-content: center; align-items: center;
        }
        #player-char-img { max-width: 100%; max-height: 100%; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        #player-char-img.correct-answer { animation: jump-animation 0.5s ease; box-shadow: 0 0 30px 10px var(--correct-color); }
        #player-char-img.incorrect-answer { animation: shake-animation 0.5s ease; box-shadow: 0 0 30px 10px var(--incorrect-color); }

        #card-stack-area {
            position: absolute; bottom: 15%; right: 15%; width: 35%; height: 60%;
            perspective: 1000px;
        }
        .card {
            position: absolute; width: 100%; height: 100%; transform-style: preserve-3d; transition: all 0.6s ease;
            cursor: pointer; border-radius: 18px; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        .card.swiped-away { transform: translate(150%, -50%) rotate(30deg) !important; opacity: 0; }
        .card.flipped { transform: rotateY(180deg); cursor: default; }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column;
            justify-content: center; align-items: center; border-radius: 18px; overflow: auto;
        }
        .card-front { background: linear-gradient(45deg, #00776b, #00bfa5); color: white; font-size: 3em; }
        .card-back {
            background-color: #e0e0e0; color: var(--text-dark); transform: rotateY(180deg); padding: 20px;
            box-sizing: border-box; text-align: left; justify-content: flex-start;
        }
        .card-question { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; }
        .card-answers button, .card-input-area button { width: 100%; margin-bottom: 10px; background-color: #f1f5f9; color: var(--text-dark); border: 1px solid #ccc; text-align: left; }
        .card-answers button:hover:not(:disabled) { background-color: #e2e8f0; }
        .card-answers button.correct, .card-input-area button.correct { background-color: var(--correct-color) !important; border-color: #38a169 !important; color: white; }
        .card-answers button.incorrect, .card-input-area button.incorrect { background-color: var(--incorrect-color) !important; border-color: #c53030 !important; color: white; }

        #end-screen h2 { font-size: 2.5em; color: var(--accent-color); }
        .hidden { display: none !important; }

        @keyframes jump-animation { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-30px); } }
        @keyframes shake-animation { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px) rotate(-3deg); } 75% { transform: translateX(10px) rotate(3deg); } }
        @keyframes flash-out { 0% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0; transform: scale(0.5); } }

    </style>
</head>
<body>
    <div class="master-container">
        <h1 class="main-title">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</h1>
        <div id="editor-wrapper">
            <div id="editor-panel">
                <div class="editor-panel-inner">
                    <div class="editor-section">
                        <h2 data-lang-key="editor_title">1. –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</h2>
                        <input type="text" id="game-title" value="–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è!">
                    </div>
                    <div class="editor-section">
                        <h2 data-lang-key="editor_characters">2. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
                        <div id="characters-container"></div>
                        <button id="add-character-btn" data-lang-key="editor_add_char">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                    </div>
                    <div class="editor-section">
                        <h2 data-lang-key="editor_settings">3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</h2>
                        <label for="language-select" data-lang-key="editor_lang">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:</label>
                        <select id="language-select">
                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                            <option value="en">English</option>
                        </select>
                        <label for="card-count-input" data-lang-key="editor_card_count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∏–≥—Ä–µ (0 = –≤—Å–µ):</label>
                        <input type="number" id="card-count-input" value="0" min="0">
                        <div class="checkbox-group">
                           <input type="checkbox" id="timer-enabled-checkbox">
                           <label for="timer-enabled-checkbox" data-lang-key="editor_timer">–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä (30 —Å–µ–∫/–≤–æ–ø—Ä–æ—Å)</label>
                        </div>
                    </div>
                    <div class="editor-section">
                        <h2 data-lang-key="editor_questions">4. –ó–∞–¥–∞–Ω–∏—è</h2>
                        <div id="questions-container"></div>
                        <button id="add-question-btn" data-lang-key="editor_add_q">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                    </div>
                </div>
            </div>
            <div id="preview-section">
                <iframe id="preview-iframe"></iframe>
                <div id="generate-code-wrapper">
                    <button id="generate-code-btn" data-lang-key="editor_generate">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                    <textarea id="iframe-code"></textarea>
                </div>
            </div>
        </div>
        <div id="game-container" class="hidden">
            <div id="start-screen" class="game-frame">
                <h1 id="game-title-display"></h1>
                <h2 data-lang-key="game_select_char">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</h2>
                <div id="character-selector"></div>
                <button id="start-game-btn" disabled data-lang-key="game_start">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!</button>
            </div>
            <div id="game-process" class="hidden">
                <div id="game-ui-top">
                    <div id="timer-display"></div>
                    <div id="lives-container"></div>
                </div>
                <div id="character-display"><img id="player-char-img" src="" alt="–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂"></div>
                <div id="card-stack-area"></div>
            </div>
            <div id="end-screen" class="hidden game-frame">
                <h2 id="end-title">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
                <button id="play-again-btn" onclick="window.location.reload()" data-lang-key="game_play_again">–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const isPlayerMode = urlParams.get('mode') === 'player';
        let characterDataUrls = [];
        let isCodeGenerated = false;

        const translations = {
            ru: {
                editor_title: "1. –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã",
                editor_characters: "2. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏",
                editor_add_char: "–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞",
                editor_settings: "3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã",
                editor_lang: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:",
                editor_card_count: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∏–≥—Ä–µ (0 = –≤—Å–µ):",
                editor_timer: "–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä (30 —Å–µ–∫/–≤–æ–ø—Ä–æ—Å)",
                editor_questions: "4. –ó–∞–¥–∞–Ω–∏—è",
                editor_add_q: "–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å",
                editor_generate: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥",
                editor_copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
                editor_copied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
                q_placeholder: "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞...",
                q_option_placeholder: "–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞",
                q_text_answer_placeholder: "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç...",
                q_add_option: "–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç",
                q_remove_q: "–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å",
                q_type_mc: "–û–¥–∏–Ω –∏–∑ –º–Ω–æ–≥–∏—Ö",
                q_type_text: "–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞",
                game_select_char: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:",
                game_start: "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!",
                game_check: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å",
                game_end_win: "üéâ –û—Ç–ª–∏—á–Ω–æ! –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∏–≥—Ä—É! üéâ",
                game_end_lose: "üò¢ –£–≤—ã, –≤—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞!",
                game_play_again: "–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑",
            },
            en: {
                editor_title: "1. Game Title",
                editor_characters: "2. Characters",
                editor_add_char: "Add Character",
                editor_settings: "3. Game Settings",
                editor_lang: "Interface Language:",
                editor_card_count: "Number of cards in game (0 = all):",
                editor_timer: "Enable timer (30 sec/question)",
                editor_questions: "4. Questions",
                editor_add_q: "Add Question",
                editor_generate: "Generate Code",
                editor_copy: "Copy",
                editor_copied: "Copied!",
                q_placeholder: "Question text...",
                q_option_placeholder: "Answer option",
                q_text_answer_placeholder: "Correct answer...",
                q_add_option: "Add Option",
                q_remove_q: "Delete Question",
                q_type_mc: "Multiple Choice",
                q_type_text: "Text Input",
                game_select_char: "Select a Character:",
                game_start: "Start Game!",
                game_check: "Check",
                game_end_win: "üéâ Excellent! You've completed the game! üéâ",
                game_end_lose: "üò¢ Oh no, you lost. Try again!",
                game_play_again: "Play Again",
            }
        };

        const correctSound = new Audio('data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjQwLjEwMQAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV6aW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV//OECAwEAFQAAECEAAFBqZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZm...T..AAAAAAAAAAAAA//OECAcAYfgAAECAAAP////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-');
        const incorrectSound = new Audio('data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjQwLjEwMQAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV6aW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV//OECBAAAMPgAAaBIAABpB///////////p//////////////////8AAAAATGF2YzU2LjI1AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//OECBwAY0QAACAAADSAAAAQARERGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaG-');

        if isPlayerMode {
            document.getElementById('editor-wrapper').style.display = 'none';
            document.querySelector('.main-title').style.display = 'none';
            document.body.style.padding = '0';
            document.getElementById('game-container').classList.remove('hidden');

            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'gameConfig') {
                    initGame(event.data.config);
                }
            });
        } else {
            initEditor();
        }

        function updateElementText(lang, key, element, attr = 'textContent') {
            if (element) {
                element[attr] = translations[lang][key];
            }
        }

        function updateUI(lang) {
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (el.tagName === 'INPUT' && el.type === 'text') {
                    updateElementText(lang, key, el, 'placeholder');
                } else {
                    updateElementText(lang, key, el);
                }
            });
             document.querySelectorAll('.question-block').forEach(block => updateQuestionBlockLang(lang, block));
        }

        function updateQuestionBlockLang(lang, block) {
            block.querySelector('.question-text').placeholder = translations[lang].q_placeholder;
            block.querySelector('.add-option-btn').textContent = translations[lang].q_add_option;
            block.querySelector('.remove-question-btn').textContent = translations[lang].q_remove_q;
            block.querySelectorAll('.option-text').forEach((opt, i) => {
                opt.placeholder = `${translations[lang].q_option_placeholder} ${i+1}`;
            });
            if(block.querySelector('.text-answer-input')) {
                block.querySelector('.text-answer-input').placeholder = translations[lang].q_text_answer_placeholder;
            }
            const typeSelect = block.querySelector('.question-type-select');
            typeSelect.options[0].textContent = translations[lang].q_type_mc;
            typeSelect.options[1].textContent = translations[lang].q_type_text;
        }


        function initEditor() {
            document.getElementById('add-character-btn').addEventListener('click', addCharacterInput);
            document.getElementById('add-question-btn').addEventListener('click', addQuestionBlock);
            document.getElementById('generate-code-btn').addEventListener('click', handleGenerateCodeClick);
            document.getElementById('editor-panel').addEventListener('input', updatePreview);
            document.getElementById('language-select').addEventListener('change', (e) => updateUI(e.target.value));

            const previewIframe = document.getElementById('preview-iframe');
            previewIframe.src = `${window.location.pathname}?mode=player`;
            previewIframe.onload = () => updatePreview();

            updateUI('ru');
            addCharacterInput();
            addQuestionBlock();
        }

        function collectConfig() {
            const lang = document.getElementById('language-select').value;
            return {
                lang: lang,
                title: document.getElementById('game-title').value,
                characters: characterDataUrls.filter(Boolean),
                cardCount: parseInt(document.getElementById('card-count-input').value) || 0,
                timerEnabled: document.getElementById('timer-enabled-checkbox').checked,
                questions: Array.from(document.querySelectorAll('.question-block')).map(block => {
                    const questionType = block.querySelector('.question-type-select').value;
                    const question = {
                        type: questionType,
                        question: block.querySelector('.question-text').value
                    };
                    if (questionType === 'multiple-choice') {
                        question.options = Array.from(block.querySelectorAll('.option-text')).map(input => input.value);
                        const correctInput = block.querySelector('input[type="radio"]:checked');
                        question.answer = correctInput ? parseInt(correctInput.value) : 0;
                    } else if (questionType === 'text-input') {
                        question.answer = block.querySelector('.text-answer-input').value;
                    }
                    return question;
                }).filter(q => q.question)
            };
        }

        async function updatePreview() {
            const config = await collectConfig();
            const previewIframe = document.getElementById('preview-iframe');
            if (previewIframe.contentWindow) {
                previewIframe.contentWindow.postMessage({ type: 'gameConfig', config }, '*');
            }
            isCodeGenerated = false;
            const lang = document.getElementById('language-select').value;
            document.getElementById('generate-code-btn').textContent = translations[lang].editor_generate;
        }

        async function handleGenerateCodeClick() {
            const codeTextarea = document.getElementById('iframe-code');
            const btn = document.getElementById('generate-code-btn');
            const lang = document.getElementById('language-select').value;

            if (!isCodeGenerated) {
                const config = await collectConfig();
                const gameUrl = `${window.location.origin}${window.location.pathname}?mode=player`;
                const configString = JSON.stringify(config);

                codeTextarea.value =
`<div style="position: relative; width: 100%; padding-bottom: 56.25%;">
    <iframe id="game-iframe-123" src="${gameUrl}" frameborder="0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe>
</div>
<script>
    (function() {
        var iframe = document.getElementById('game-iframe-123');
        var gameConfig = ${configString};
        iframe.onload = function() {
            iframe.contentWindow.postMessage({ type: 'gameConfig', config: gameConfig }, '*');
        };
    })();
<\/script>`;

                codeTextarea.style.display = 'block';
                btn.textContent = translations[lang].editor_copy;
                isCodeGenerated = true;
            } else {
                codeTextarea.select();
                navigator.clipboard.writeText(codeTextarea.value).then(() => {
                    btn.textContent = translations[lang].editor_copied;
                    setTimeout(() => { btn.textContent = translations[lang].editor_copy; }, 2000);
                });
            }
        }

        function addCharacterInput() {
            const container = document.getElementById('characters-container');
            const index = container.children.length;
            characterDataUrls[index] = null;
            const group = document.createElement('div');
            group.className = 'character-upload-group';
            group.innerHTML = `
                <img src="https://placehold.co/40x40/101820/00ffe7?text=+" alt="preview" id="char-preview-${index}">
                <input type="file" id="char-upload-${index}" accept="image/*">
                <label for="char-upload-${index}">–ó–∞–≥—Ä—É–∑–∏—Ç—å...</label>
                <button type="button" class="char-remove-btn-x">&times;</button>
            `;
            container.appendChild(group);

            group.querySelector('.char-remove-btn-x').onclick = () => {
                characterDataUrls[index] = null;
                group.remove();
                updatePreview();
            };

            document.getElementById(`char-upload-${index}`).addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById(`char-preview-${index}`).src = e.target.result;
                        characterDataUrls[index] = e.target.result;
                        updatePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function addQuestionBlock() {
            const container = document.getElementById('questions-container');
            const qIndex = Date.now();
            const block = document.createElement('div');
            block.className = 'question-block';
            const lang = document.getElementById('language-select').value;

            block.innerHTML = `
                <h4>–í–æ–ø—Ä–æ—Å ${container.children.length + 1}</h4>
                <select class="question-type-select">
                    <option value="multiple-choice">${translations[lang].q_type_mc}</option>
                    <option value="text-input">${translations[lang].q_type_text}</option>
                </select>
                <textarea class="question-text" placeholder="${translations[lang].q_placeholder}"></textarea>
                <div class="question-type-wrapper multiple-choice">
                    <div class="options-container"></div>
                </div>
                <div class="question-type-wrapper text-input hidden">
                    <input type="text" class="text-answer-input" placeholder="${translations[lang].q_text_answer_placeholder}">
                </div>
                <div class="question-buttons">
                    <button type="button" class="add-option-btn">${translations[lang].q_add_option}</button>
                    <button type="button" class="remove-question-btn remove-btn">${translations[lang].q_remove_q}</button>
                </div>`;
            container.appendChild(block);

            const typeSelect = block.querySelector('.question-type-select');
            const mcWrapper = block.querySelector('.multiple-choice');
            const textWrapper = block.querySelector('.text-input');
            const addOptionBtn = block.querySelector('.add-option-btn');

            typeSelect.addEventListener('change', () => {
                const isMc = typeSelect.value === 'multiple-choice';
                mcWrapper.classList.toggle('hidden', !isMc);
                addOptionBtn.classList.toggle('hidden', !isMc);
                textWrapper.classList.toggle('hidden', isMc);
                updatePreview();
            });

            addOption(block.querySelector('.options-container'), qIndex);
            addOption(block.querySelector('.options-container'), qIndex);
            block.querySelector('input[type="radio"]').checked = true;

            addOptionBtn.onclick = () => addOption(block.querySelector('.options-container'), qIndex);
            block.querySelector('.remove-question-btn').onclick = () => { block.remove(); updatePreview(); };
        }

        function addOption(container, qIndex) {
            const optionIndex = container.children.length;
            const group = document.createElement('div');
            group.className = 'option-group';
            const lang = document.getElementById('language-select').value;
            group.innerHTML = `<input type="radio" name="correct_q${qIndex}" value="${optionIndex}"><input type="text" class="option-text" placeholder="${translations[lang].q_option_placeholder} ${optionIndex + 1}">`;
            container.appendChild(group);
        }

        // ======================= –õ–û–ì–ò–ö–ê –ò–ì–†–´ =======================
        let gameConfig = {};
        let gameState = { character: '', currentCardIndex: 0, lives: 5, questions: [] };
        let timerInterval = null;

        function initGame(config) {
            gameConfig = config;
            gameState.lang = config.lang || 'ru';
            updateUI(gameState.lang);

            document.getElementById('game-title-display').textContent = gameConfig.title;
            const charSelector = document.getElementById('character-selector');
            charSelector.innerHTML = '';
            gameConfig.characters.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.onclick = () => {
                    charSelector.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
                    img.classList.add('selected');
                    gameState.character = url;
                    checkStartButton();
                };
                charSelector.appendChild(img);
            });
            document.getElementById('start-game-btn').onclick = startGame;
        }

        function checkStartButton() { document.getElementById('start-game-btn').disabled = !gameState.character; }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-process').classList.remove('hidden');
            document.getElementById('player-char-img').src = gameState.character;

            // Prepare questions
            const shuffled = [...gameConfig.questions].sort(() => 0.5 - Math.random());
            const count = gameConfig.cardCount > 0 ? gameConfig.cardCount : shuffled.length;
            gameState.questions = shuffled.slice(0, count);

            const stackArea = document.getElementById('card-stack-area');
            stackArea.innerHTML = '';
            gameState.currentCardIndex = 0;
            gameState.lives = 5;
            updateLivesDisplay();

            const reversedQuestions = [...gameState.questions].reverse();
            reversedQuestions.forEach((q, index) => {
                const card = createCardElement(q, gameState.questions.length - 1 - index);
                const offset = index * 4;
                card.style.transform = `translateX(${offset}px) translateY(${offset}px)`;
                stackArea.appendChild(card);
            });
            if (gameState.questions.length > 0) {
                startTimer();
            } else {
                endGame('win');
            }
        }

        function updateLivesDisplay() {
            const livesContainer = document.getElementById('lives-container');
            livesContainer.innerHTML = '';
            for(let i=0; i < 5; i++) {
                const heart = document.createElement('span');
                heart.className = 'life-heart';
                heart.textContent = '‚ù§Ô∏è';
                if(i >= gameState.lives) {
                    heart.style.opacity = '0.2';
                }
                livesContainer.appendChild(heart);
            }
        }
        
        function loseLife() {
            gameState.lives--;
            const hearts = document.querySelectorAll('.life-heart');
            const heartToLose = hearts[gameState.lives];
            if (heartToLose) {
                heartToLose.classList.add('lost');
            }
            if (gameState.lives <= 0) {
                setTimeout(() => endGame('lose'), 500);
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            const timerDisplay = document.getElementById('timer-display');
            if (!gameConfig.timerEnabled) {
                timerDisplay.style.display = 'none';
                return;
            }
            timerDisplay.style.display = 'block';
            let timeLeft = 30;
            timerDisplay.textContent = timeLeft;

            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    incorrectSound.play();
                    loseLife();
                    setTimeout(nextCard, 1000);
                }
            }, 1000);
        }

        function createCardElement(qData, index) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.index = index;
            card.innerHTML = `<div class="card-face card-front"></div><div class="card].game_check;
                btn.onclick = () => checkAnswer(input.value.trim().toLowerCase() === qData.answer.trim().toLowerCase(), btn);
                contentContainer.appendChild(input);
                contentContainer.appendChild(btn);
            }
            card.addEventListener('click', (e) => {
                if (!card.classList.contains('flipped') && e.target.closest('.card-front')) {
                    card.classList.add('flipped');
                }
            }, { capture: true });
            return card;
        }

        function checkAnswer(isCorrect, button) {
            clearInterval(timerInterval);
            const cardBack = button.closest('.card-back');
            cardBack.querySelectorAll('button, input').forEach(el => el.disabled = true);
            
            const playerImg = document.getElementById('player-char-img');
            playerImg.classList.remove('correct-answer', 'incorrect-answer');
            void playerImg.offsetWidth; // Trigger reflow

            if (isCorrect) {
                correctSound.play();
                playerImg.classList.add('correct-answer');
                button.classList.add('correct');
            } else {
                incorrectSound.play();
                playerImg.classList.add('incorrect-answer');
                button.classList.add('incorrect');
                if (button.closest('.card-answers')) {
                    const correctButton = cardBack.querySelectorAll('button')[gameState.questions[gameState.currentCardIndex].answer];
                    if (correctButton) correctButton.classList.add('correct');
                }
                loseLife();
            }

            setTimeout(() => playerImg.classList.remove('correct-answer', 'incorrect-answer'), 600);
            if (gameState.lives > 0) {
                 setTimeout(nextCard, 2000);
            }
        }

        function nextCard() {
            if (gameState.lives <= 0) return;

            const stackArea = document.getElementById('card-stack-area');
            const currentCard = stackArea.querySelector(`.card[data-index="${gameState.currentCardIndex}"]`);
            if (currentCard) currentCard.classList.add('swiped-away');

            gameState.currentCardIndex++;
            if (gameState.currentCardIndex >= gameState.questions.length) {
                setTimeout(() => endGame('win'), 600);
            } else {
                startTimer();
            }
        }

        function endGame(status) {
            clearInterval(timerInterval);
            document.getElementById('game-process').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            const endTitle = document.getElementById('end-title');
            if (status === 'win') {
                endTitle.textContent = translations[gameState.lang].game_end_win;
            } else {
                endTitle.textContent = translations[gameState.lang].game_end_lose;
            }
        }
    });
    </script>
</body>
</html>
