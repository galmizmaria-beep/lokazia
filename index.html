<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</title>
    <style>
        :root{
            --bg-dark:#101820;
            --panel-bg:rgba(23,37,51,0.85);
            --accent-color:#00ffe7;
            --text-light:#e0e0e0;
            --text-dark:#333;
            --border-color:rgba(0,255,231,0.2);
            --hover-bg:rgba(0,255,231,0.05);
            --correct-color:#4ade80;
            --incorrect-color:#f87171;
        }
        html,body{width:100%;height:100%;margin:0;padding:0;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;}
        body{
            background-image:linear-gradient(180deg,#1a2a3a,#101820);
            color:var(--text-light);
            display:flex;justify-content:center;align-items:center;
        }
        .master-container{
            width:95vw;max-width:1400px;height:calc(95vw * 9 / 16);max-height:95vh;display:flex;flex-direction:column;
        }
        .main-title{ text-align:center; color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); margin-bottom:20px; flex-shrink:0; }

        button{ background-color:transparent; color:var(--accent-color); border:1px solid var(--accent-color); padding:10px 15px; border-radius:6px; cursor:pointer; font-size:16px; font-weight:bold; transition:all .3s; }
        button:hover{ background-color:var(--accent-color); color:var(--bg-dark); box-shadow:0 0 15px var(--accent-color); }
        button:disabled{ background-color:#4a5568; border-color:#4a5568; color:#a0aec0; cursor:not-allowed; box-shadow:none; }

        input,textarea,select{ width:100%; padding:10px; border:1px solid var(--border-color); border-radius:4px; box-sizing:border-box; margin-top:5px; margin-bottom:10px; background-color:rgba(0,0,0,0.2); color:var(--text-light); transition:all .3s; }
        input:hover,textarea:hover,select:hover,input:focus,textarea:focus,select:focus{ border-color:var(--accent-color); box-shadow:0 0 5px var(--accent-color); outline:none; }

        #editor-wrapper{ display:flex; gap:20px; height:100%; overflow:hidden; }
        #editor-panel{ flex:1; min-width:350px; }
        #preview-section{ flex:1.5; display:flex; flex-direction:column; }

        .editor-panel-inner{ background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:25px; backdrop-filter:blur(10px); height:100%; box-sizing:border-box; overflow-y:auto; }
        .editor-panel-inner h2, .editor-panel-inner h3{ color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); }

        .editor-section{ margin-bottom:15px; padding:10px; border-radius:8px; border:1px solid transparent; transition:all .3s; }
        .editor-section:hover{ background-color:var(--hover-bg); border-color:var(--border-color); }

        .question-block{ background:rgba(0,0,0,0.2); padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid var(--border-color); }
        .question-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .question-header h4{ margin:0; font-size:1.1em; }
        .question-actions .icon-btn{ background:none; border:none; color:var(--text-light); font-size:20px; cursor:pointer; padding:2px 5px; opacity:0.7; }
        .question-actions .icon-btn:hover{ opacity:1; color:var(--accent-color); }
        .question-actions .icon-btn.edit-btn{ cursor:not-allowed; opacity:0.3; }

        .option-group{ display:flex; align-items:center; margin-bottom:8px; }
        .character-upload-group{ display:flex; align-items:center; gap:10px; margin-bottom:15px; position:relative; }
        .character-upload-group img{ width:40px;height:40px;border-radius:50%;object-fit:cover; }
        .character-upload-group input[type="file"]{ display:none; }
        .character-upload-group label{ background-color:#4a5568; color:white; padding:8px 12px; border-radius:5px; cursor:pointer; text-align:center; flex-grow:1; }

        .char-remove-btn-x{ position:absolute; top:-5px; right:-5px; width:22px; height:22px; border-radius:50%; background:#e53e3e; color:white; border:none; font-size:16px; font-weight:bold; display:flex; align-items:center; justify-content:center; cursor:pointer; padding:0; box-shadow:0 2px 4px rgba(0,0,0,.4); }

        #preview-iframe{ width:100%; flex-grow:1; border-radius:12px; border:1px solid var(--border-color); background-color:var(--bg-dark); }
        #iframe-code{ display:none; margin-top:10px; min-height:80px; font-size:12px; }

        /* --- GAME STYLES --- */
        #game-container{ width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; box-sizing:border-box; background:none; }

        #start-screen{ width:100%; max-width:700px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:30px; backdrop-filter:blur(10px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; box-sizing:border-box; }
        #game-title-display{ text-align:center; color:var(--accent-color); font-size:1.8em; margin:0; text-shadow:0 0 5px var(--accent-color); }
        #character-selector{ display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin-bottom: 20px; }
        #character-selector img{ width:80px; height:80px; border-radius:50%; border:3px solid transparent; cursor:pointer; object-fit:cover; transition:all .2s; }
        #character-selector img.selected{ border-color:var(--accent-color); box-shadow:0 0 10px var(--accent-color); transform:scale(1.05); }

        #start-game-btn{ align-self:center; }

        .game-frame{ width:100%; max-width:700px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:20px; box-sizing:border-box; }

        #game-process{ width:100%; height:100%; position:relative; padding:20px; box-sizing:border-box; display:block; }
        #game-ui-top{ position:absolute; top:20px; left:20px; right:20px; display:flex; justify-content:space-between; align-items:center; z-index: 100; }
        #global-timer-display{ font-size:2em; color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); }
        #lives-container{ display:flex; gap:5px; font-size:2.0em; }
        .life-heart { transition: all 0.5s ease; }

        #character-display{ position:absolute; bottom:5%; left:10%; width:25%; height:50%; display:flex; justify-content:center; align-items:center; z-index: 10; }
        #player-char-img{ max-width:100%; max-height:100%; transition:transform .3s ease, filter .3s ease; }
        #player-char-img.correct-answer{ animation:jump-animation .6s ease; filter: drop-shadow(0 0 15px var(--correct-color)); }
        #player-char-img.incorrect-answer{ animation:shake-animation .6s ease; filter: drop-shadow(0 0 15px var(--incorrect-color)); }

        #card-grid-area{ position:absolute; bottom:15%; right:10%; width:60%; height:70%; display:flex; flex-wrap: wrap; gap: 15px; align-content: flex-start; justify-content: center; }
        
        .card{
            width: 90px; height: 130px;
            background:linear-gradient(45deg,#00776b,#00bfa5);
            color:white;
            border-radius:12px;
            display:flex; align-items:center; justify-content:center;
            font-size:3em; font-weight:bold;
            cursor:pointer;
            transition: all 0.3s ease;
            box-shadow:0 5px 15px rgba(0,0,0,.3);
        }
        .card:hover{
            transform: translateY(-5px);
            box-shadow:0 8px 20px rgba(0,255,231,0.3);
        }
        .card.completed{
            background: var(--correct-color);
            cursor: not-allowed;
            opacity: 0.6;
            color: transparent; /* Hide number */
        }
        .card.completed:after {
            content: '‚úî';
            font-size: 1.5em;
            color: white;
            position: absolute;
        }

        /* MODAL STYLES */
        #question-modal-overlay{
            position:fixed; inset:0;
            background:rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display:flex; align-items:center; justify-content:center;
            z-index: 1000;
        }
        #question-modal-content{
            background-color:#e0e0e0; color:var(--text-dark);
            padding:30px; border-radius:12px;
            min-width: 450px; max-width: 90vw;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .card-question{ font-size:1.2em; font-weight:bold; margin-bottom:20px; }
        .card-answers button, .card-input-area button{ width:100%; margin-bottom:10px; background-color:#f1f5f9; color:var(--text-dark); border:1px solid #ccc; text-align:left; padding:10px; }
        .card-answers button:hover, .card-input-area button:hover{ background-color: #e2e8f0; }

        .card-answers button.correct, .card-input-area button.correct{ background-color:var(--correct-color) !important; border-color:#38a169 !important; color:white; }
        .card-answers button.incorrect, .card-input-area button.incorrect{ background-color:var(--incorrect-color) !important; border-color:#c53030 !important; color:white; }
        .card-input-area input{ width:100%; padding:10px; margin-bottom:10px; border-radius:6px; color: var(--text-dark); background: white; border:1px solid #ccc; }


        #end-screen{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; width:100%; max-width:700px; background-color:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:30px; box-sizing:border-box; }
        #end-screen h2{ font-size:2em; color:var(--accent-color); text-shadow:0 0 5px var(--accent-color); text-align:center; margin:0; }
        #end-screen .end-player{ width:160px; height:160px; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
        #end-screen .confetti{ font-size:3em; }

        .hidden{ display:none !important; }

        @keyframes jump-animation{ 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-30px);} }
        @keyframes shake-animation{ 0%,100%{ transform:translateX(0);} 25%{ transform:translateX(-12px) rotate(-3deg);} 75%{ transform:translateX(12px) rotate(3deg);} }
        @keyframes sway-animation {
            0%   { transform: rotate(-8deg); }
            50%  { transform: rotate(8deg); }
            100% { transform: rotate(-8deg); }
        }
        #end-player-img.sway {
            animation: sway-animation 2.5s ease-in-out infinite;
        }
        @keyframes life-lost-animation {
            0%   { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.2; transform: scale(0.8); }
        }
        .life-heart.lost {
            animation: life-lost-animation 0.5s ease-out forwards;
        }

        /* Editor styles for difficulty columns */
        .difficulty-questions-wrapper {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .difficulty-column {
            flex: 1;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            min-width: 280px;
            display: flex;
            flex-direction: column;
        }
        .difficulty-column h3 {
            color: var(--accent-color);
            text-shadow: 0 0 3px var(--accent-color);
            margin-top: 0;
            text-align: center;
        }
        .difficulty-column .question-block {
            background: none; /* No extra background for blocks within columns */
            border: none;
            padding: 10px;
        }
        .difficulty-column .add-question-btn {
            margin-top: 15px;
            flex-shrink: 0;
        }

        /* Editor styles for difficulty settings */
        .difficulty-settings-group {
            background: rgba(0,0,0,0.2);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        .difficulty-settings-group h4 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 10px;
        }
        .difficulty-settings-group label {
            display: block;
            margin-top: 5px;
            margin-bottom: 2px;
            font-size: 0.9em;
        }
        .difficulty-settings-group input[type="number"] {
            width: calc(100% - 20px); /* Adjusting for padding */
            padding: 8px;
            margin-bottom: 8px;
        }

        /* Mission Upload Group */
        .mission-upload-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            position: relative;
            background:rgba(0,0,0,0.2);
            padding:10px;
            border-radius:6px;
            border:1px solid var(--border-color);
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }
        .mission-upload-group > div {
            flex-grow: 1;
        }
        .mission-upload-group img {
            width: 50px; /* Larger for mission icons */
            height: 50px;
            object-fit: cover;
            border-radius: 8px; /* Slightly rounded corners */
            flex-shrink: 0;
        }
        .mission-upload-group label {
            flex-grow: 1; /* Allow label to take available space */
        }
        .mission-upload-group input[type="text"] {
            width: calc(100% - 22px);
        }
        .mission-upload-group .char-remove-btn-x { /* Reusing styles for mission remove */
            top: -8px; /* Adjust position */
            right: -8px;
        }

        /* Game Styles - Difficulty Selector */
        #difficulty-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            width: 100%; /* Ensure it spans */
            max-width: 500px;
        }
        #difficulty-selector button {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            font-size: 1.2em;
            border-width: 2px;
        }
        #difficulty-selector button.selected {
            background-color: var(--accent-color);
            color: var(--bg-dark);
            box-shadow: 0 0 20px var(--accent-color);
            transform: scale(1.05);
        }

        /* Game Styles - Mission Map */
        #mission-map-screen {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            background-image: linear-gradient(180deg,#1a2a3a,#101820); /* Default map background */
            background-size: cover;
            background-position: center;
            border-radius: 12px;
        }
        #map-area {
            position: relative;
            width: 80%; /* Adjust as needed */
            height: 80%;
            display: flex;
            flex-wrap: wrap; /* For grid-like mission layout */
            gap: 20px;
            justify-content: center;
            align-items: center;
        }
        .mission-map-icon {
            position: relative;
            width: 100px;
            height: 100px;
            background-color: var(--panel-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,.4);
        }
        .mission-map-icon:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 20px var(--accent-color);
        }
        .mission-map-icon.completed {
            border-color: var(--correct-color);
            opacity: 0.7;
            cursor: not-allowed;
            box-shadow: 0 0 10px var(--correct-color);
        }
        .mission-map-icon.locked {
            filter: grayscale(80%);
            opacity: 0.5;
            cursor: not-allowed;
        }
        .mission-map-icon img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 5px;
        }
        .mission-map-icon span {
            color: var(--text-light);
            font-size: 0.9em;
            text-align: center;
            word-break: break-word; /* For long names */
        }

        #player-char-on-map {
            position: absolute;
            width: 80px; /* Size of character on map */
            height: 80px;
            pointer-events: none; /* Character doesn't block clicks */
            transition: transform 0.8s ease-in-out; /* Smooth movement */
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #player-char-map-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 8px var(--accent-color)); /* Glow for character */
        }

        #mission-description-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 25px;
            max-width: 500px;
            text-align: center;
            z-index: 60;
            box-shadow: 0 5px 25px rgba(0,0,0,.5);
        }
        #mission-description-panel h3 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 10px;
        }
        #mission-description-panel p {
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 15px;
        }
        #mission-description-panel button {
            margin-top: 10px;
        }

        #current-mission-game-area {
            width: 100%;
            height: 100%;
            position: relative;
            padding: 20px;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            background-image:linear-gradient(180deg,#1a2a3a,#101820); /* Default background for mission area */
        }

        /* Global Game UI elements */
        #global-timer-display {
            font-size: 2em;
            color: var(--accent-color);
            text-shadow:0 0 5px var(--accent-color);
        }
        #game-ui-top {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100; /* Ensure UI is on top */
        }

        /* Music Controls */
        #music-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #music-toggle-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2em;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1; /* Center icon */
        }
        #music-volume-slider {
            width: 80px;
            height: 8px; /* Adjust height */
            appearance: none;
            background: var(--border-color);
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }
        #music-volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            box-shadow: 0 0 5px var(--accent-color);
        }
        #music-volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            box-shadow: 0 0 5px var(--accent-color);
        }

        /* End screen changes for "Time's Up" */
        #end-screen.time-up {
            background-color: var(--incorrect-color); /* Red background for time up */
        }
        #end-screen.time-up h2 {
            color: white;
            text-shadow: 0 0 8px black;
        }
    </style>
</head>
<body>
    <div class="master-container">
        <h1 class="main-title">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</h1>

        <div id="editor-wrapper">
            <div id="editor-panel">
                <div class="editor-panel-inner">
                    <div class="editor-section">
                        <h2 data-lang-key="editor_title">1. –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</h2>
                        <input type="text" id="game-title" value="–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è!">
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_characters_heading">2. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
                        <div id="characters-container"></div>
                        <button id="add-character-btn" data-lang-key="editor_add_char">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_music_heading">3. –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞</h2>
                        <input type="file" id="bg-music-upload" accept="audio/*">
                        <div id="bg-music-preview-name"></div>
                        <audio id="bg-music-player-preview" controls class="hidden"></audio>
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_settings">4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</h2>
                        <label for="language-select" data-lang-key="editor_lang">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:</label>
                        <select id="language-select">
                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                            <option value="en">English</option>
                        </select>

                        <label for="card-count-input" data-lang-key="editor_cards_per_mission">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∫–∞–∂–¥–æ–π –º–∏—Å—Å–∏–∏:</label>
                        <input type="number" id="card-count-input" value="5" min="1">

                        <label for="global-timer-input" data-lang-key="editor_global_timer_minutes">–û–±—â–µ–µ –≤—Ä–µ–º—è –Ω–∞ –∏–≥—Ä—É (–º–∏–Ω—É—Ç, 0 = –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞):</label>
                        <input type="number" id="global-timer-input" value="15" min="0">

                        <h3 data-lang-key="editor_difficulty_settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</h3>
                        <div class="difficulty-settings-group">
                            <h4><span data-lang-key="difficulty_easy">–õ–µ–≥–∫–∏–π</span></h4>
                            <label for="easy-lives" data-lang-key="settings_lives">–ñ–∏–∑–Ω–∏:</label><input type="number" id="easy-lives" value="5" min="1">
                            <label for="easy-time-multiplier" data-lang-key="settings_time_multiplier">–ú–Ω–æ–∂–∏—Ç–µ–ª—å –≤—Ä–µ–º–µ–Ω–∏ (1.0 = –Ω–æ—Ä–º):</label><input type="number" id="easy-time-multiplier" value="1.2" step="0.1">
                        </div>
                        <div class="difficulty-settings-group">
                            <h4><span data-lang-key="difficulty_medium">–°—Ä–µ–¥–Ω–∏–π</span></h4>
                            <label for="medium-lives" data-lang-key="settings_lives">–ñ–∏–∑–Ω–∏:</label><input type="number" id="medium-lives" value="3" min="1">
                            <label for="medium-time-multiplier" data-lang-key="settings_time_multiplier">–ú–Ω–æ–∂–∏—Ç–µ–ª—å –≤—Ä–µ–º–µ–Ω–∏ (1.0 = –Ω–æ—Ä–º):</label><input type="number" id="medium-time-multiplier" value="1.0" step="0.1">
                        </div>
                        <div class="difficulty-settings-group">
                            <h4><span data-lang-key="difficulty_hard">–°–ª–æ–∂–Ω—ã–π</span></h4>
                            <label for="hard-lives" data-lang-key="settings_lives">–ñ–∏–∑–Ω–∏:</label><input type="number" id="hard-lives" value="1" min="1">
                            <label for="hard-time-multiplier" data-lang-key="settings_time_multiplier">–ú–Ω–æ–∂–∏—Ç–µ–ª—å –≤—Ä–µ–º–µ–Ω–∏ (1.0 = –Ω–æ—Ä–º):</label><input type="number" id="hard-time-multiplier" value="0.8" step="0.1">
                        </div>
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_missions_heading">5. –ú–∏—Å—Å–∏–∏ (–¥–æ 10)</h2>
                        <div id="missions-container"></div>
                        <button id="add-mission-btn" data-lang-key="editor_add_mission">–î–æ–±–∞–≤–∏—Ç—å –º–∏—Å—Å–∏—é</button>
                    </div>

                    <div class="editor-section">
                        <h2 data-lang-key="editor_questions_heading">6. –ó–∞–¥–∞–Ω–∏—è –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</h2>
                        <div class="difficulty-questions-wrapper">
                            <div class="difficulty-column">
                                <h3 data-lang-key="difficulty_easy">–õ–µ–≥–∫–∏–µ</h3>
                                <div id="easy-questions-container"></div>
                                <button class="add-question-btn" data-difficulty="easy" data-lang-key="editor_add_q">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                            </div>
                            <div class="difficulty-column">
                                <h3 data-lang-key="difficulty_medium">–°—Ä–µ–¥–Ω–∏–µ</h3>
                                <div id="medium-questions-container"></div>
                                <button class="add-question-btn" data-difficulty="medium" data-lang-key="editor_add_q">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                            </div>
                            <div class="difficulty-column">
                                <h3 data-lang-key="difficulty_hard">–°–ª–æ–∂–Ω—ã–µ</h3>
                                <div id="hard-questions-container"></div>
                                <button class="add-question-btn" data-difficulty="hard" data-lang-key="editor_add_q">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="preview-section">
                <iframe id="preview-iframe"></iframe>
                <div id="generate-code-wrapper">
                    <button id="generate-code-btn" data-lang-key="editor_generate">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                    <textarea id="iframe-code"></textarea>
                </div>
            </div>
        </div>

        <!-- In-iframe game area (used in preview mode) -->
        <div id="game-container" class="hidden">
            <div id="start-screen" class="game-frame">
                <h1 id="game-title-display"></h1>
                <h2 data-lang-key="game_select_char">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</h2>
                <div id="character-selector"></div>
                <h2 data-lang-key="game_select_difficulty">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</h2>
                <div id="difficulty-selector">
                    <button id="difficulty-easy-btn" data-difficulty="easy" data-lang-key="difficulty_easy">–õ–µ–≥–∫–∏–π</button>
                    <button id="difficulty-medium-btn" data-difficulty="medium" data-lang-key="difficulty_medium">–°—Ä–µ–¥–Ω–∏–π</button>
                    <button id="difficulty-hard-btn" data-difficulty="hard" data-lang-key="difficulty_hard">–°–ª–æ–∂–Ω—ã–π</button>
                </div>
                <button id="start-game-btn" disabled data-lang-key="game_start">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!</button>
            </div>

            <div id="game-process" class="hidden">
                <div id="game-ui-top">
                    <div id="global-timer-display"></div>
                    <div id="lives-container"></div>
                    <div id="music-controls">
                        <audio id="game-bg-music" loop></audio>
                        <button id="music-toggle-btn">üîá</button>
                        <input type="range" id="music-volume-slider" min="0" max="1" step="0.01" value="0.5">
                    </div>
                </div>

                <div id="mission-map-screen" class="hidden">
                    <div id="map-area">
                        <!-- Mission icons will be rendered here -->
                    </div>
                    <div id="player-char-on-map" style="position: absolute; transform: translate(-50%, -50%); top: 0; left: 0;">
                        <img id="player-char-map-img" src="" alt="–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–∂">
                    </div>
                    <div id="mission-description-panel">
                        <h3 id="current-mission-title"></h3>
                        <p id="current-mission-description"></p>
                        <button id="start-mission-btn" data-lang-key="game_start_mission">–ù–∞—á–∞—Ç—å –º–∏—Å—Å–∏—é!</button>
                    </div>
                </div>

                <div id="current-mission-game-area" class="hidden">
                    <div id="character-display"><img id="player-char-img" src="" alt="–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂"></div>
                    <div id="card-grid-area"></div>
                </div>

                <div id="question-modal-overlay" class="hidden">
                    <div id="question-modal-content">
                        <div class="card-question"></div>
                        <div class="card-content-area"></div>
                    </div>
                </div>
            </div>

            <div id="end-screen" class="hidden">
                <div class="end-player"><img id="end-player-img" src="" alt="player" style="max-width:100%;max-height:100%"></div>
                <h2 id="end-title">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
                <div class="confetti hidden" id="confetti">üéâüéâüéâ</div>
                <button id="play-again-btn" onclick="window.location.reload()" data-lang-key="game_play_again">–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const isPlayerMode = urlParams.get('mode') === 'player';
        let characterDataUrls = []; // Stores URLs for characters
        let missionData = []; // Stores mission config (name, desc, iconUrl, categories)
        let backgroundMusicUrl = null; // Stores global background music URL
        let isCodeGenerated = false;

        const translations = {
            ru: {
                editor_title: "1. –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã",
                editor_characters_heading: "2. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏",
                editor_add_char: "–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞",
                editor_music_heading: "3. –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞",
                editor_settings: "4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã",
                editor_lang: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:",
                editor_cards_per_mission: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∫–∞–∂–¥–æ–π –º–∏—Å—Å–∏–∏:",
                editor_global_timer_minutes: "–û–±—â–µ–µ –≤—Ä–µ–º—è –Ω–∞ –∏–≥—Ä—É (–º–∏–Ω—É—Ç, 0 = –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞):",
                editor_difficulty_settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:",
                settings_lives: "–ñ–∏–∑–Ω–∏:",
                settings_time_multiplier: "–ú–Ω–æ–∂–∏—Ç–µ–ª—å –≤—Ä–µ–º–µ–Ω–∏ (1.0 = –Ω–æ—Ä–º):",
                editor_missions_heading: "5. –ú–∏—Å—Å–∏–∏ (–¥–æ 10)",
                editor_add_mission: "–î–æ–±–∞–≤–∏—Ç—å –º–∏—Å—Å–∏—é",
                mission_name_placeholder: "–ù–∞–∑–≤–∞–Ω–∏–µ –º–∏—Å—Å–∏–∏",
                mission_desc_placeholder: "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∏—Å—Å–∏–∏",
                mission_icon_upload_label: "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∫–æ–Ω–∫—É...",
                mission_categories_placeholder: "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)",
                editor_questions_heading: "6. –ó–∞–¥–∞–Ω–∏—è –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏",
                editor_generate: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥",
                editor_copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
                editor_copied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
                q_placeholder: "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞...",
                q_option_placeholder: "–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞",
                q_text_answer_placeholder: "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç...",
                q_add_option: "+ –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç",
                q_remove_q: "–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å",
                q_type_mc: "–û–¥–∏–Ω –∏–∑ –º–Ω–æ–≥–∏—Ö",
                q_type_text: "–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞",
                q_categories_placeholder: "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–æ–ø—Ä–æ—Å–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)",

                game_select_char: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:",
                game_select_difficulty: "–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:",
                game_start: "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!",
                game_check: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å",
                game_end_win: "–¢–´ –ü–û–ë–ï–î–ò–õ!",
                game_end_lose: "–¢–´ –ü–†–û–ò–ì–†–ê–õ!",
                game_play_again: "–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑",
                game_try_again: "–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!",
                game_start_mission: "–ù–∞—á–∞—Ç—å –º–∏—Å—Å–∏—é!",
                time_up: "–í–†–ï–ú–Ø –í–´–®–õ–û!",
                difficulty_easy: "–õ–µ–≥–∫–∏–π",
                difficulty_medium: "–°—Ä–µ–¥–Ω–∏–π",
                difficulty_hard: "–°–ª–æ–∂–Ω—ã–π",
                music_on: "üîä",
                music_off: "üîá",
                mission_completed_text: "–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!",
                all_missions_completed: "–í—Å–µ –º–∏—Å—Å–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!"
            },
            en: {
                editor_title: "1. Game Title",
                editor_characters_heading: "2. Characters",
                editor_add_char: "Add Character",
                editor_music_heading: "3. Background Music",
                editor_settings: "4. Game Settings",
                editor_lang: "Interface Language:",
                editor_cards_per_mission: "Cards per Mission:",
                editor_global_timer_minutes: "Total game time (minutes, 0 = no timer):",
                editor_difficulty_settings: "Difficulty Settings:",
                settings_lives: "Lives:",
                settings_time_multiplier: "Time Multiplier (1.0 = normal):",
                editor_missions_heading: "5. Missions (up to 10)",
                editor_add_mission: "Add Mission",
                mission_name_placeholder: "Mission Name",
                mission_desc_placeholder: "Brief mission description",
                mission_icon_upload_label: "Upload Icon...",
                mission_categories_placeholder: "Categories (comma-separated)",
                editor_questions_heading: "6. Questions by Difficulty",
                editor_generate: "Generate Code",
                editor_copy: "Copy",
                editor_copied: "Copied!",
                q_placeholder: "Question text...",
                q_option_placeholder: "Answer option",
                q_text_answer_placeholder: "Correct answer...",
                q_add_option: "+ Add Option",
                q_remove_q: "Delete Question",
                q_type_mc: "Multiple Choice",
                q_type_text: "Text Input",
                q_categories_placeholder: "Question categories (comma-separated)",

                game_select_char: "Select a Character:",
                game_select_difficulty: "Select Difficulty Level:",
                game_start: "Start Game!",
                game_check: "Check",
                game_end_win: "YOU WIN!",
                game_end_lose: "YOU LOSE!",
                game_play_again: "Play Again",
                game_try_again: "Try Again!",
                game_start_mission: "Start Mission!",
                time_up: "TIME'S UP!",
                difficulty_easy: "Easy",
                difficulty_medium: "Medium",
                difficulty_hard: "Hard",
                music_on: "üîä",
                music_off: "üîá",
                mission_completed_text: "Mission Completed!",
                all_missions_completed: "All Missions Completed!"
            }
        };

        const correctSound = new Audio('data:audio/wav;base64,UklGRlAZGF0YU'+Array(1e3).join('123'));
        const incorrectSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(1e3).join('321'));

        let gameConfig = {};
        let gameState = {
            lang: 'ru',
            character: '', // Selected character URL
            difficulty: null, // 'easy', 'medium', 'hard'
            globalLives: 0,
            currentMissionIndex: 0,
            currentMissionQuestions: [], // Questions for current mission
            completedCardsInMission: 0,
            globalTimeLeft: 0, // In seconds
            globalTimerRunning: false,
            // Track completed missions by index
            completedMissions: new Set()
        };
        let globalTimerInterval = null;
        let bgAudioElement = null; // Reference to the game's background audio element

        if (isPlayerMode) {
            document.getElementById('editor-wrapper').style.display = 'none';
            document.querySelector('.main-title').style.display = 'none';
            document.body.style.padding = '0';
            document.getElementById('game-container').classList.remove('hidden');

            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'gameConfig') {
                    initGame(event.data.config);
                }
            });

        } else {
            initEditor();
        }

        function updateElementText(lang, key, element, attr = 'textContent'){
            if (element && translations[lang] && translations[lang][key] !== undefined) element[attr] = translations[lang][key];
        }

        function updateUI(lang){
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (el.tagName === 'INPUT' && (el.type === 'text' || el.type === 'number')) updateElementText(lang, key, el, 'placeholder');
                else updateElementText(lang, key, el);
            });
            document.querySelectorAll('.question-block').forEach(block => updateQuestionBlockLang(lang, block));
            document.querySelectorAll('.mission-upload-group').forEach(group => updateMissionBlockLang(lang, group));
            
            // Specific UI elements that might not have data-lang-key
            const musicToggleBtn = document.getElementById('music-toggle-btn');
            if (musicToggleBtn) {
                musicToggleBtn.textContent = bgAudioElement && !bgAudioElement.paused ? translations[lang].music_on : translations[lang].music_off;
            }
        }

        function updateQuestionBlockLang(lang, block){
            const t = translations[lang] || translations.ru;
            const qText = block.querySelector('.question-text'); if (qText) qText.placeholder = t.q_placeholder;
            const addOptBtn = block.querySelector('.add-option-btn'); if (addOptBtn) addOptBtn.textContent = t.q_add_option;
            block.querySelectorAll('.option-text').forEach((opt, i) => { opt.placeholder = `${t.q_option_placeholder} ${i+1}`; });
            const textIn = block.querySelector('.text-answer-input'); if (textIn) textIn.placeholder = t.q_text_answer_placeholder;
            const qCategories = block.querySelector('.question-categories-input'); if (qCategories) qCategories.placeholder = t.q_categories_placeholder;
            const typeSelect = block.querySelector('.question-type-select');
            if (typeSelect && typeSelect.options && typeSelect.options.length >= 2){
                typeSelect.options[0].textContent = t.q_type_mc;
                typeSelect.options[1].textContent = t.q_type_text;
            }
        }

        function updateMissionBlockLang(lang, block) {
            const t = translations[lang] || translations.ru;
            const nameInput = block.querySelector('.mission-name-input'); if (nameInput) nameInput.placeholder = t.mission_name_placeholder;
            const descInput = block.querySelector('.mission-desc-input'); if (descInput) descInput.placeholder = t.mission_desc_placeholder;
            const iconLabel = block.querySelector('.mission-icon-upload-label'); if (iconLabel) iconLabel.textContent = t.mission_icon_upload_label;
            const categoriesInput = block.querySelector('.mission-categories-input'); if (categoriesInput) categoriesInput.placeholder = t.mission_categories_placeholder;
        }

        function initEditor(){
            document.getElementById('add-character-btn').addEventListener('click', addCharacterInput);
            document.getElementById('bg-music-upload').addEventListener('change', handleMusicUpload);
            document.getElementById('add-mission-btn').addEventListener('click', addMissionBlock);
            document.querySelectorAll('.add-question-btn').forEach(btn => {
                btn.addEventListener('click', (e) => addQuestionBlock(e.target.dataset.difficulty));
            });

            document.getElementById('generate-code-btn').addEventListener('click', handleGenerateCodeClick);
            document.getElementById('editor-panel').addEventListener('input', updatePreview);
            document.getElementById('editor-panel').addEventListener('change', updatePreview);
            document.getElementById('language-select').addEventListener('change', (e) => updateUI(e.target.value));

            const previewIframe = document.getElementById('preview-iframe');
            previewIframe.src = `${window.location.pathname}?mode=player`;
            
            previewIframe.onload = () => {
                updatePreview();
            };

            updateUI('ru');
            addCharacterInput(); // Add first character input by default
            addMissionBlock(); // Add first mission block by default
            addQuestionBlock('easy'); // Add first question for each difficulty
            addQuestionBlock('medium');
            addQuestionBlock('hard');
        }

        function collectConfig(){
            const lang = document.getElementById('language-select').value;
            const difficultySettings = {
                easy: {
                    lives: parseInt(document.getElementById('easy-lives').value, 10),
                    timeMultiplier: parseFloat(document.getElementById('easy-time-multiplier').value)
                },
                medium: {
                    lives: parseInt(document.getElementById('medium-lives').value, 10),
                    timeMultiplier: parseFloat(document.getElementById('medium-time-multiplier').value)
                },
                hard: {
                    lives: parseInt(document.getElementById('hard-lives').value, 10),
                    timeMultiplier: parseFloat(document.getElementById('hard-time-multiplier').value)
                }
            };

            const allQuestions = {};
            ['easy', 'medium', 'hard'].forEach(difficulty => {
                allQuestions[difficulty] = Array.from(document.getElementById(`${difficulty}-questions-container`).querySelectorAll('.question-block')).map(block => {
                    const questionType = block.querySelector('.question-type-select').value;
                    const question = {
                        difficulty: difficulty,
                        type: questionType,
                        question: block.querySelector('.question-text').value || '',
                        categories: block.querySelector('.question-categories-input').value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean)
                    };
                    if (questionType === 'multiple-choice'){
                        question.options = Array.from(block.querySelectorAll('.option-text')).map(i => i.value);
                        const correctInput = block.querySelector('input[type="radio"]:checked');
                        question.answer = correctInput ? parseInt(correctInput.value, 10) : 0;
                    } else {
                        question.answer = block.querySelector('.text-answer-input').value || '';
                    }
                    return question;
                }).filter(q => q.question && q.question.trim()); // Only include questions with text
            });

            return {
                lang: lang,
                title: document.getElementById('game-title').value,
                characters: characterDataUrls.filter(Boolean),
                backgroundMusic: backgroundMusicUrl,
                cardCountPerMission: parseInt(document.getElementById('card-count-input').value, 10) || 5,
                globalTimerMinutes: parseInt(document.getElementById('global-timer-input').value, 10) || 0,
                difficultySettings: difficultySettings,
                missions: missionData.filter(m => m.name && m.name.trim()), // Filter out empty missions
                questions: allQuestions
            };
        }

        function updatePreview(){
            const config = collectConfig();
            const previewIframe = document.getElementById('preview-iframe');
            if (previewIframe.contentWindow){
                previewIframe.contentWindow.postMessage({ type: 'gameConfig', config }, '*');
            }
            isCodeGenerated = false;
            const lang = document.getElementById('language-select').value;
            document.getElementById('generate-code-btn').textContent = translations[lang].editor_generate;
        }

        function handleGenerateCodeClick(){
            const codeTextarea = document.getElementById('iframe-code');
            const btn = document.getElementById('generate-code-btn');
            const lang = document.getElementById('language-select').value;

            if (!isCodeGenerated){
                const config = collectConfig();
                const gameUrl = `${window.location.origin}${window.location.pathname}?mode=player`;
                const configString = JSON.stringify(config).replace(/</g, '\\u003c');

                codeTextarea.value =
`<div style="position: relative; width: 100%; padding-bottom: 56.25%;">
    <iframe id="game-iframe-123" src="${gameUrl}" frameborder="0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe>
</div>
<script>
    (function() {
        var iframe = document.getElementById('game-iframe-123');
        var gameConfig = ${configString};
        iframe.onload = function() {
            iframe.contentWindow.postMessage({ type: 'gameConfig', config: gameConfig }, '*');
        };
    })();
<\/script>`;
                codeTextarea.style.display = 'block';
                btn.textContent = translations[lang].editor_copy;
                isCodeGenerated = true;
            } else {
                codeTextarea.select();
                navigator.clipboard.writeText(codeTextarea.value).then(() => {
                    btn.textContent = translations[lang].editor_copied;
                    setTimeout(() => { btn.textContent = translations[lang].editor_copy; }, 2000);
                });
            }
        }

        function addCharacterInput(){
            const container = document.getElementById('characters-container');
            const index = characterDataUrls.length; // Use length for new index
            characterDataUrls.push(null); // Add placeholder for new char
            
            const group = document.createElement('div');
            group.className = 'character-upload-group';
            group.innerHTML = `
                <img src="https://placehold.co/40x40/101820/00ffe7?text=+" alt="preview" id="char-preview-${index}">
                <input type="file" id="char-upload-${index}" accept="image/*">
                <label for="char-upload-${index}">–ó–∞–≥—Ä—É–∑–∏—Ç—å...</label>
                <button type="button" class="char-remove-btn-x" title="–£–¥–∞–ª–∏—Ç—å">&times;</button>
            `;
            container.appendChild(group);

            group.querySelector('.char-remove-btn-x').onclick = () => {
                // Remove from array and DOM, then update all indices
                characterDataUrls.splice(index, 1);
                group.remove();
                updateCharacterInputsIndices(); // Re-index all existing
                updatePreview();
            };

            document.getElementById(`char-upload-${index}`).addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.getElementById(`char-preview-${index}`);
                        if (img) img.src = e.target.result;
                        characterDataUrls[index] = e.target.result;
                        updatePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
            updatePreview(); // Initial update
        }

        function updateCharacterInputsIndices() {
            const container = document.getElementById('characters-container');
            Array.from(container.children).forEach((group, newIndex) => {
                const oldIndex = parseInt(group.querySelector('img').id.replace('char-preview-', ''), 10);
                
                // Update element IDs and for attributes
                group.querySelector('img').id = `char-preview-${newIndex}`;
                const fileInput = group.querySelector('input[type="file"]');
                fileInput.id = `char-upload-${newIndex}`;
                group.querySelector('label').setAttribute('for', `char-upload-${newIndex}`);

                // Update array reference if order changed
                if (oldIndex !== newIndex) {
                     // This is tricky if elements were truly reordered. Simpler to just rebuild characterDataUrls if order matters.
                     // For now, if we just remove, the array shrinks and newIndex correctly points to what was at oldIndex.
                }
            });
        }

        function handleMusicUpload(event) {
            const file = event.target.files[0];
            const previewPlayer = document.getElementById('bg-music-player-preview');
            const previewName = document.getElementById('bg-music-preview-name');
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    backgroundMusicUrl = e.target.result;
                    previewPlayer.src = e.target.result;
                    previewPlayer.classList.remove('hidden');
                    previewName.textContent = file.name;
                    updatePreview();
                };
                reader.readAsDataURL(file);
            } else {
                backgroundMusicUrl = null;
                previewPlayer.src = '';
                previewPlayer.classList.add('hidden');
                previewName.textContent = '';
                updatePreview();
            }
        }

        function addMissionBlock(){
            const container = document.getElementById('missions-container');
            const index = missionData.length;
            missionData.push({
                name: '',
                description: '',
                iconUrl: null,
                categories: []
            });
            const block = document.createElement('div');
            block.className = 'mission-upload-group';
            const lang = document.getElementById('language-select').value;
            const t = translations[lang] || translations.ru;

            block.innerHTML = `
                <img src="https://placehold.co/50x50/101820/00ffe7?text=M${index+1}" alt="mission-icon" id="mission-icon-preview-${index}">
                <div>
                    <input type="text" class="mission-name-input" placeholder="${t.mission_name_placeholder}" value="${t.mission_name_placeholder} ${index+1}">
                    <input type="text" class="mission-desc-input" placeholder="${t.mission_desc_placeholder}">
                    <input type="file" id="mission-icon-upload-${index}" accept="image/*">
                    <label for="mission-icon-upload-${index}" class="mission-icon-upload-label">${t.mission_icon_upload_label}</label>
                    <input type="text" class="mission-categories-input" placeholder="${t.mission_categories_placeholder}">
                </div>
                <button type="button" class="char-remove-btn-x" title="–£–¥–∞–ª–∏—Ç—å">&times;</button>
            `;
            container.appendChild(block);

            block.querySelector('.char-remove-btn-x').onclick = () => {
                missionData.splice(index, 1);
                block.remove();
                updateMissionBlockIndices();
                updatePreview();
            };

            block.querySelector('.mission-name-input').addEventListener('input', (e) => {
                missionData[index].name = e.target.value; updatePreview();
            });
            block.querySelector('.mission-desc-input').addEventListener('input', (e) => {
                missionData[index].description = e.target.value; updatePreview();
            });
            block.querySelector('.mission-categories-input').addEventListener('input', (e) => {
                missionData[index].categories = e.target.value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean); updatePreview();
            });

            document.getElementById(`mission-icon-upload-${index}`).addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.getElementById(`mission-icon-preview-${index}`);
                        if (img) img.src = e.target.result;
                        missionData[index].iconUrl = e.target.result;
                        updatePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
            updatePreview();
        }

        function updateMissionBlockIndices() {
            const container = document.getElementById('missions-container');
            Array.from(container.children).forEach((group, newIndex) => {
                // Update element IDs and for attributes
                const oldIndex = parseInt(group.querySelector('img').id.replace('mission-icon-preview-', ''), 10); // Get old index to match old data
                
                group.querySelector('img').id = `mission-icon-preview-${newIndex}`;
                group.querySelector('.mission-name-input').value = missionData[newIndex] ? missionData[newIndex].name : '';
                group.querySelector('.mission-desc-input').value = missionData[newIndex] ? missionData[newIndex].description : '';
                const iconInput = group.querySelector('input[type="file"]');
                iconInput.id = `mission-icon-upload-${newIndex}`;
                group.querySelector('label.mission-icon-upload-label').setAttribute('for', `mission-icon-upload-${newIndex}`);
                group.querySelector('.mission-categories-input').value = missionData[newIndex] ? missionData[newIndex].categories.join(',') : '';
            });
        }


        function addQuestionBlock(difficulty){
            const container = document.getElementById(`${difficulty}-questions-container`);
            const qIndex = Date.now(); // Unique ID for radios
            const block = document.createElement('div');
            block.className = 'question-block';
            const lang = document.getElementById('language-select').value;
            const t = translations[lang] || translations.ru;

            block.innerHTML = `
                <div class="question-header">
                    <h4>–í–æ–ø—Ä–æ—Å ${container.children.length + 1}</h4>
                    <div class="question-actions">
                        <button type="button" class="icon-btn remove-question-btn" title="${t.q_remove_q}">üóëÔ∏è</button>
                    </div>
                </div>
                <select class="question-type-select">
                    <option value="multiple-choice">${t.q_type_mc}</option>
                    <option value="text-input">${t.q_type_text}</option>
                </select>
                <textarea class="question-text" placeholder="${t.q_placeholder}"></textarea>
                <input type="text" class="question-categories-input" placeholder="${t.q_categories_placeholder}">
                <div class="question-type-wrapper multiple-choice">
                    <div class="options-container"></div>
                    <button type="button" class="add-option-btn">${t.q_add_option}</button>
                </div>
                <div class="question-type-wrapper text-input hidden">
                    <input type="text" class="text-answer-input" placeholder="${t.q_text_answer_placeholder}">
                </div>
            `;
            container.appendChild(block);

            const typeSelect = block.querySelector('.question-type-select');
            const mcWrapper = block.querySelector('.multiple-choice');
            const textWrapper = block.querySelector('.text-input');

            typeSelect.addEventListener('change', () => {
                const isMc = typeSelect.value === 'multiple-choice';
                mcWrapper.classList.toggle('hidden', !isMc);
                textWrapper.classList.toggle('hidden', isMc);
                updatePreview();
            });

            addOption(block.querySelector('.options-container'), qIndex);
            addOption(block.querySelector('.options-container'), qIndex);
            const firstRadio = block.querySelector('input[type="radio"]');
            if (firstRadio) firstRadio.checked = true;

            block.querySelector('.add-option-btn').onclick = () => { addOption(block.querySelector('.options-container'), qIndex); updatePreview(); };
            block.querySelector('.remove-question-btn').onclick = () => { block.remove(); updatePreview(); };
            
            updatePreview(); // Initial update
        }

        function addOption(container, qIndex){
            const optionIndex = container.children.length;
            const group = document.createElement('div');
            group.className = 'option-group';
            const lang = document.getElementById('language-select').value;
            group.innerHTML = `<input type="radio" name="correct_q${qIndex}" value="${optionIndex}"><input type="text" class="option-text" placeholder="${translations[lang].q_option_placeholder} ${optionIndex+1}">`;
            container.appendChild(group);
        }

        // ---------- Game functions ----------
        function initGame(config){
            if (!config) return;
            gameConfig = config;
            gameState.lang = config.lang || 'ru';
            updateUI(gameState.lang);

            document.getElementById('game-title-display').textContent = gameConfig.title || '';
            
            // Character selection
            const charSelector = document.getElementById('character-selector');
            charSelector.innerHTML = '';
            (gameConfig.characters || []).forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.onclick = () => {
                    charSelector.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
                    img.classList.add('selected');
                    gameState.character = url;
                    checkStartButton();
                };
                charSelector.appendChild(img);
            });

            // Difficulty selection
            const difficultySelector = document.getElementById('difficulty-selector');
            ['easy', 'medium', 'hard'].forEach(diff => {
                const btn = document.getElementById(`difficulty-${diff}-btn`);
                btn.onclick = () => {
                    difficultySelector.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    gameState.difficulty = diff;
                    checkStartButton();
                };
            });

            document.getElementById('start-game-btn').onclick = startGame;
            checkStartButton(); // Initially disable start button

            // Setup global background music
            bgAudioElement = document.getElementById('game-bg-music');
            const musicToggleBtn = document.getElementById('music-toggle-btn');
            const musicVolumeSlider = document.getElementById('music-volume-slider');

            if (gameConfig.backgroundMusic) {
                bgAudioElement.src = gameConfig.backgroundMusic;
                bgAudioElement.volume = musicVolumeSlider.value;
                bgAudioElement.play().catch(e => {
                    console.warn("Autoplay failed, user interaction needed.", e);
                    // Prompt user to interact if autoplay fails
                    // e.g., show a play button to start music
                });
                musicToggleBtn.textContent = translations[gameState.lang].music_on;
            } else {
                musicToggleBtn.classList.add('hidden');
                musicVolumeSlider.classList.add('hidden');
            }

            musicToggleBtn.onclick = () => {
                if (bgAudioElement.paused) {
                    bgAudioElement.play();
                    musicToggleBtn.textContent = translations[gameState.lang].music_on;
                } else {
                    bgAudioElement.pause();
                    musicToggleBtn.textContent = translations[gameState.lang].music_off;
                }
            };
            musicVolumeSlider.oninput = (e) => {
                bgAudioElement.volume = e.target.value;
            };
        }

        function checkStartButton(){
            const startBtn = document.getElementById('start-game-btn');
            startBtn.disabled = !(gameState.character && gameState.difficulty);
        }

        function startGame(){
            // Preload sounds (browser specific, often requires user interaction)
            try { correctSound.play().then(()=>correctSound.pause(), ()=>{}); correctSound.pause(); } catch(e){}
            try { incorrectSound.play().then(()=>incorrectSound.pause(), ()=>{}); incorrectSound.pause(); } catch(e){}

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-process').classList.remove('hidden');
            document.getElementById('player-char-img').src = gameState.character;
            document.getElementById('player-char-map-img').src = gameState.character;

            // Set initial lives based on difficulty
            gameState.globalLives = gameConfig.difficultySettings[gameState.difficulty].lives;
            setupLivesDisplay();

            // Set global timer
            if (gameConfig.globalTimerMinutes > 0) {
                gameState.globalTimeLeft = Math.round(gameConfig.globalTimerMinutes * 60 * gameConfig.difficultySettings[gameState.difficulty].timeMultiplier);
                startGlobalTimer();
            } else {
                document.getElementById('global-timer-display').classList.add('hidden');
            }
            
            gameState.currentMissionIndex = 0;
            gameState.completedMissions.clear();
            showMissionMap();
        }

        function startGlobalTimer(){
            clearInterval(globalTimerInterval);
            const timerDisplay = document.getElementById('global-timer-display');
            timerDisplay.classList.remove('hidden');
            gameState.globalTimerRunning = true;

            globalTimerInterval = setInterval(() => {
                gameState.globalTimeLeft--;
                const minutes = Math.floor(gameState.globalTimeLeft / 60);
                const seconds = gameState.globalTimeLeft % 60;
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (gameState.globalTimeLeft <= 0){
                   clearInterval(globalTimerInterval);
                   gameState.globalTimerRunning = false;
                   endGame('timeup');
                }
            }, 1000);
        }

        function setupLivesDisplay(){
            const livesContainer = document.getElementById('lives-container');
            livesContainer.innerHTML = '';
            for (let i=0;i<gameConfig.difficultySettings[gameState.difficulty].lives;i++){
                const heart = document.createElement('span');
                heart.className = 'life-heart';
                heart.textContent = '‚ù§Ô∏è';
                if (i >= gameState.globalLives) {
                    heart.classList.add('lost'); // Mark initial lost lives if starting with less than max
                }
                livesContainer.appendChild(heart);
            }
        }

        function loseLife(){
            if (gameState.globalLives > 0) {
                 const hearts = document.querySelectorAll('#lives-container .life-heart');
                 const heartToLose = hearts[gameState.globalLives - 1];
                 if (heartToLose) {
                    heartToLose.classList.add('lost');
                 }
            }
            gameState.globalLives--;
            if (gameState.globalLives <= 0){
                setTimeout(() => endGame('lose'), 700);
            }
        }

        function showMissionMap() {
            document.getElementById('current-mission-game-area').classList.add('hidden');
            document.getElementById('mission-map-screen').classList.remove('hidden');

            const mapArea = document.getElementById('map-area');
            mapArea.innerHTML = '';

            const playerCharMapImg = document.getElementById('player-char-on-map');
            playerCharMapImg.style.display = 'block';

            gameConfig.missions.forEach((mission, index) => {
                const missionIconDiv = document.createElement('div');
                missionIconDiv.className = 'mission-map-icon';
                missionIconDiv.dataset.missionIndex = index;
                missionIconDiv.innerHTML = `<img src="${mission.iconUrl || 'https://placehold.co/60x60/333/eee?text=M' + (index + 1)}" alt="${mission.name}"><span>${mission.name}</span>`;

                const isLocked = index > 0 && !gameState.completedMissions.has(index - 1);
                const isCompleted = gameState.completedMissions.has(index);

                if (isCompleted) {
                    missionIconDiv.classList.add('completed');
                } else if (isLocked) {
                    missionIconDiv.classList.add('locked');
                } else {
                    missionIconDiv.onclick = () => selectMission(index);
                }
                mapArea.appendChild(missionIconDiv);
            });
            
            // Position player character on the map
            const currentMissionIcon = document.querySelector(`.mission-map-icon[data-mission-index="${gameState.currentMissionIndex}"]`);
            if (currentMissionIcon) {
                const iconRect = currentMissionIcon.getBoundingClientRect();
                const mapRect = mapArea.getBoundingClientRect();
                // Position relative to mapArea
                playerCharMapImg.style.transform = `translate(${iconRect.left - mapRect.left + iconRect.width / 2}px, ${iconRect.top - mapRect.top + iconRect.height / 2}px)`;
            } else { // Hide if no mission or first mission not yet rendered (e.g. empty map)
                 playerCharMapImg.style.display = 'none';
            }

            // Hide mission description panel initially or until a mission is selected
            document.getElementById('mission-description-panel').classList.add('hidden');

            // If it's the very beginning of the game, auto-select the first mission
            if (gameState.currentMissionIndex === 0 && !gameState.completedMissions.has(0)) {
                selectMission(0);
            } else if (gameState.completedMissions.has(gameState.currentMissionIndex)) {
                // If current mission completed, and no next mission, show final win
                if (gameState.currentMissionIndex >= gameConfig.missions.length -1) {
                    endGame('win');
                } else {
                    // Automatically move to the next mission if current is completed and there are more
                    selectMission(gameState.currentMissionIndex + 1);
                }
            } else {
                // If we are on the map and current mission is not completed, select it again to show description
                 selectMission(gameState.currentMissionIndex);
            }
        }

        function selectMission(index) {
            gameState.currentMissionIndex = index;
            const mission = gameConfig.missions[index];
            const panel = document.getElementById('mission-description-panel');
            
            document.getElementById('current-mission-title').textContent = mission.name;
            document.getElementById('current-mission-description').textContent = mission.description;
            panel.classList.remove('hidden');

            const startMissionBtn = document.getElementById('start-mission-btn');
            startMissionBtn.onclick = () => startMission(index);

            // Update player char position on map to selected mission
            const playerCharMapImg = document.getElementById('player-char-on-map');
            const targetIcon = document.querySelector(`.mission-map-icon[data-mission-index="${index}"]`);
            if (targetIcon) {
                const mapArea = document.getElementById('map-area');
                const targetRect = targetIcon.getBoundingClientRect();
                const mapRect = mapArea.getBoundingClientRect();
                playerCharMapImg.style.transform = `translate(${targetRect.left - mapRect.left + targetRect.width / 2}px, ${targetRect.top - mapRect.top + targetRect.height / 2}px)`;
            }
        }

        function startMission(missionIndex) {
            document.getElementById('mission-map-screen').classList.add('hidden');
            document.getElementById('current-mission-game-area').classList.remove('hidden');
            document.getElementById('player-char-on-map').style.display = 'none'; // Hide character on map during mission

            const mission = gameConfig.missions[missionIndex];
            
            // Filter questions for this mission based on categories and selected difficulty
            let availableQuestions = [];
            ['easy', 'medium', 'hard'].forEach(diff => {
                if (gameConfig.questions[diff]) {
                    gameConfig.questions[diff].forEach(q => {
                        const questionCategories = new Set(q.categories);
                        const missionCategories = new Set(mission.categories);
                        
                        // Check if question difficulty matches selected global difficulty
                        // AND if question has at least one category that matches mission category
                        if (q.difficulty === gameState.difficulty &&
                            mission.categories.some(mc => questionCategories.has(mc))) {
                            availableQuestions.push(q);
                        }
                    });
                }
            });

            // Shuffle and select questions for the current mission
            availableQuestions.sort(() => 0.5 - Math.random());
            gameState.currentMissionQuestions = availableQuestions.slice(0, gameConfig.cardCountPerMission);
            gameState.completedCardsInMission = 0;

            const gridArea = document.getElementById('card-grid-area');
            gridArea.innerHTML = '';

            if (gameState.currentMissionQuestions.length > 0){
                for (let i = 0; i < gameState.currentMissionQuestions.length; i++){
                    const card = createCardElement(i);
                    gridArea.appendChild(card);
                }
            } else {
                // No questions for this mission/difficulty, automatically complete or handle
                console.warn(`No questions found for mission "${mission.name}" with difficulty "${gameState.difficulty}" and categories "${mission.categories.join(', ')}".`);
                // For now, let's treat it as completed if no questions are found.
                setTimeout(() => completeMission(missionIndex), 500);
            }
        }
        
        function createCardElement(qIndex){
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.qindex = qIndex;
            card.innerHTML = `<span>${qIndex + 1}</span>`;
            card.addEventListener('click', () => {
                if (!card.classList.contains('completed')) {
                    showQuestionModal(qIndex);
                }
            });
            return card;
        }

        function showQuestionModal(qIndex){
            const qData = gameState.currentMissionQuestions[qIndex];
            const modalOverlay = document.getElementById('question-modal-overlay');
            const qTextEl = modalOverlay.querySelector('.card-question');
            const content = modalOverlay.querySelector('.card-content-area');

            qTextEl.textContent = qData.question || '';
            content.innerHTML = '';

            if (qData.type === 'multiple-choice'){
                content.className = 'card-content-area card-answers';
                (qData.options || []).forEach((opt, i) => {
                    const btn = document.createElement('button');
                    btn.textContent = opt || `${translations[gameState.lang].q_option_placeholder} ${i+1}`;
                    btn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        handleAnswer(qIndex, i === qData.answer, btn);
                    });
                    content.appendChild(btn);
                });
            } else {
                content.className = 'card-content-area card-input-area';
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = translations[gameState.lang]?.q_text_answer_placeholder || '';
                const btn = document.createElement('button');
                btn.textContent = translations[gameState.lang]?.game_check || '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
                btn.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    const correct = (input.value || '').trim().toLowerCase() === (qData.answer || '').trim().toLowerCase();
                    handleAnswer(qIndex, correct, btn);
                });
                content.appendChild(input);
                content.appendChild(btn);
            }
            modalOverlay.classList.remove('hidden');
        }

        function closeQuestionModal(){
            document.getElementById('question-modal-overlay').classList.add('hidden');
        }

        function handleAnswer(qIndex, isCorrect, buttonEl){
            const modalContent = document.getElementById('question-modal-content');
            modalContent.querySelectorAll('button,input').forEach(el => el.disabled = true);
            
            const playerImg = document.getElementById('player-char-img');
            playerImg.classList.remove('correct-answer','incorrect-answer');
            void playerImg.offsetWidth;
            
            if (isCorrect){
                try { correctSound.play(); } catch(e){}
                playerImg.classList.add('correct-answer');
                buttonEl.classList.add('correct');
                
                setTimeout(() => {
                    closeQuestionModal();
                    const cardEl = document.querySelector(`#card-grid-area .card[data-qindex="${qIndex}"]`);
                    cardEl.classList.add('completed');
                    gameState.completedCardsInMission++;
                    checkMissionCompletion();
                }, 900);

            } else {
                try { incorrectSound.play(); } catch(e){}
                playerImg.classList.add('incorrect-answer');
                buttonEl.classList.add('incorrect');
                
                setTimeout(() => {
                   closeQuestionModal();
                   loseLife();
                }, 900);
            }

            setTimeout(() => {
                playerImg.classList.remove('correct-answer','incorrect-answer');
            }, 700);
        }

        function checkMissionCompletion(){
            if (gameState.globalLives <= 0) {
                endGame('lose');
                return;
            }
            if (gameState.completedCardsInMission >= gameState.currentMissionQuestions.length) {
                setTimeout(() => completeMission(gameState.currentMissionIndex), 500);
            }
        }

        function completeMission(missionIndex){
            gameState.completedMissions.add(missionIndex);
            
            // Check if all missions are completed
            if (gameState.completedMissions.size >= gameConfig.missions.length) {
                setTimeout(() => endGame('win'), 1000);
            } else {
                // Transition to next mission on map
                gameState.currentMissionIndex++;
                setTimeout(() => {
                    document.getElementById('current-mission-game-area').classList.add('hidden');
                    // Show a temporary "Mission Completed" message before going to map
                    // For now, directly show map. Could add a small popup here.
                    showMissionMap();
                }, 1000);
            }
        }

        function endGame(status){
            clearInterval(globalTimerInterval);
            document.getElementById('game-process').classList.add('hidden');
            const endScreen = document.getElementById('end-screen');
            endScreen.classList.remove('hidden');

            const endTitle = document.getElementById('end-title');
            const endButton = document.getElementById('play-again-btn');
            const confetti = document.getElementById('confetti');
            const endImg = document.getElementById('end-player-img');
            endImg.src = gameState.character || '';

            endImg.classList.remove('correct-answer', 'incorrect-answer', 'sway');
            void endImg.offsetWidth;
            endScreen.classList.remove('time-up'); // Ensure removed for other states
            
            const t = translations[gameState.lang];

            if (status === 'win'){
                endTitle.textContent = gameState.completedMissions.size === gameConfig.missions.length ? t.all_missions_completed : t.game_end_win;
                endButton.textContent = t.game_play_again;
                confetti.classList.remove('hidden');
                endImg.classList.add('correct-answer');
                try { correctSound.play(); } catch(e){}
            } else if (status === 'lose') {
                endTitle.textContent = t.game_end_lose;
                endButton.textContent = t.game_play_again;
                confetti.classList.add('hidden');
                endImg.classList.add('sway');
                try { incorrectSound.play(); } catch(e){}
            } else if (status === 'timeup') {
                endScreen.classList.add('time-up');
                endTitle.textContent = t.time_up;
                endButton.textContent = t.game_try_again;
                confetti.classList.add('hidden');
                endImg.classList.add('sway');
                try { incorrectSound.play(); } catch(e){}
            }
        }
    });
    </script>
</body>
</html>
