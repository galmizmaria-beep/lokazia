<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ò–≥—Ä</title>
    <style>
        :root {
            --bg-dark: #101820;
            --panel-bg: rgba(23, 37, 51, 0.85);
            --accent-color: #00ffe7;
            --text-light: #e0e0e0;
            --text-dark: #333;
            --border-color: rgba(0, 255, 231, 0.2);
            --hover-bg: rgba(0, 255, 231, 0.05);
        }

        /* --- –û–ë–©–ò–ï –°–¢–ò–õ–ò --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-image: linear-gradient(180deg, #1a2a3a, #101820);
            color: var(--text-light);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .master-container {
            width: 100%;
            max-width: 1400px;
        }

        button {
            background-color: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            background-color: var(--accent-color);
            color: var(--bg-dark);
            box-shadow: 0 0 15px var(--accent-color);
        }
        button:disabled {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            margin-top: 5px;
            margin-bottom: 10px;
            background-color: rgba(0,0,0,0.2);
            color: var(--text-light);
            transition: all 0.3s;
        }
        input:hover, textarea:hover, input:focus, textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 5px var(--accent-color);
            outline: none;
        }

        /* --- –°–¢–ò–õ–ò –†–ï–î–ê–ö–¢–û–†–ê --- */
        #editor-wrapper {
            display: flex;
            gap: 20px;
        }
        #editor-panel { flex: 1; min-width: 400px; }
        #preview-panel { flex: 1.5; }
        
        .editor-panel-inner {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        
        .editor-panel-inner h1, .editor-panel-inner h2 { color: var(--accent-color); text-shadow: 0 0 5px var(--accent-color); }
        .editor-panel-inner p { color: #a0aec0; }
        
        .editor-section {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.3s;
        }
        .editor-section:hover {
            background-color: var(--hover-bg);
            border-color: var(--border-color);
        }
        
        .question-block {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        .option-group { display: flex; align-items: center; margin-bottom: 8px; }
        .option-group input[type="radio"] { width: auto; margin-right: 10px; margin-top: 0; }
        
        .remove-btn { border-color: #e53e3e; color: #e53e3e; }
        .remove-btn:hover { background-color: #e53e3e; color: white; box-shadow: 0 0 15px #e53e3e;}

        #preview-iframe {
            width: 100%;
            height: 700px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-dark);
        }
        
        #generated-code-area { display: none; margin-top: 20px; }
        #iframe-code { min-height: 120px; }
        
        /* --- –°–¢–ò–õ–ò –ò–ì–†–´ --- */
        #game-container {
            width: 100%;
            height: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .game-frame {
            width: 100%;
            max-width: 500px;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        #start-screen h2 { color: var(--accent-color); margin-top: 0;}
        #start-screen img {
            width: 80px; height: 80px;
            border: 3px solid transparent;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            object-fit: cover;
            margin: 5px;
        }
        #start-screen img:hover { transform: scale(1.1); }
        #start-screen img.selected { border-color: var(--accent-color); transform: scale(1.1); box-shadow: 0 0 10px var(--accent-color); }
        .level-selector { margin: 20px 0; }
        .level-btn.selected { background-color: var(--accent-color); color: var(--bg-dark); }
        
        #game-layout {
            display: flex;
            width: 100%;
            height: 100%;
            gap: 20px;
        }
        #character-display {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }
        #character-display img { max-width: 100%; max-height: 80%; border-radius: 12px; }
        
        #card-stack-area {
            flex: 1.2;
            position: relative;
            perspective: 1000px;
            min-height: 450px;
        }
        .card {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: all 0.6s ease;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        .card.swiped-away {
            transform: translate(150%, -50%) rotate(30deg) !important;
            opacity: 0;
        }
        .card.flipped { transform: rotateY(180deg); cursor: default; }
        
        .card-face {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            overflow: hidden;
        }
        .card-front { background: linear-gradient(45deg, #00776b, #00bfa5); color: white; font-size: 3em; }
        .card-back {
            background-color: #e0e0e0;
            color: var(--text-dark);
            transform: rotateY(180deg);
            padding: 20px;
            box-sizing: border-box;
            text-align: left;
            justify-content: flex-start;
        }
        .card-question { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; }
        .card-answers button {
            width: 100%;
            margin-bottom: 10px;
            background-color: #f1f5f9;
            color: var(--text-dark);
            border: 1px solid #ccc;
            text-align: left;
        }
        .card-answers button:hover:not(:disabled) { background-color: #e2e8f0; }
        .card-answers button.correct { background-color: #4ade80 !important; border-color: #38a169 !important; color: white; }
        .card-answers button.incorrect { background-color: #f87171 !important; border-color: #c53030 !important; color: white; }

        #end-screen h2 { font-size: 2.5em; color: var(--accent-color); }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="master-container">
        <!-- ======================= –†–ï–î–ê–ö–¢–û–† (–≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ======================= -->
        <div id="editor-wrapper">
            <div id="editor-panel">
                <div class="editor-panel-inner">
                    <h1>üìù –†–µ–¥–∞–∫—Ç–æ—Ä –ò–≥—Ä—ã</h1>
                    <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã —Å–ª–µ–≤–∞, –∏ –≤—ã —Å—Ä–∞–∑—É —É–≤–∏–¥–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–∫–Ω–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø—Ä–∞–≤–∞.</p>
                    
                    <div class="editor-section">
                        <h2>1. –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                        <label for="game-title">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã:</label>
                        <input type="text" id="game-title" value="–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è!">
                    </div>

                    <div class="editor-section">
                        <h2>2. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
                        <div id="characters-container">
                            <input type="text" class="character-input" placeholder="https://..." value="https://images.gnwcdn.com/2023/usgamer/mega-man-battle-network-legacy-collection-screenshot-4-1.jpg/EG11/thumbnail/1920x1080/format/jpg/quality/80">
                        </div>
                        <button id="add-character-btn">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                    </div>

                    <div class="editor-section">
                        <h2>3. –£—Ä–æ–≤–Ω–∏</h2>
                        <p>–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —É—Ä–æ–≤–Ω–∏ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –º–µ—Ö–∞–Ω–∏–∫—É "—Å—Ç–æ–ø–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫", –Ω–æ –∏—Ö –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤ –±—É–¥—É—â–µ–º.</p>
                        <label for="level-easy-name">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è 1:</label>
                        <input type="text" id="level-easy-name" value="–õ–µ–≥–∫–∏–π">
                        <label for="level-hard-name">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è 2:</label>
                        <input type="text" id="level-hard-name" value="–°–ª–æ–∂–Ω—ã–π">
                    </div>

                    <div class="editor-section">
                        <h2>4. –ó–∞–¥–∞–Ω–∏—è</h2>
                        <div id="questions-container"></div>
                        <button id="add-question-btn">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                    </div>

                    <button id="generate-code-btn">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ iframe</button>
                    <div id="generated-code-area">
                        <h3>–ì–æ—Ç–æ–≤–æ!</h3>
                        <textarea id="iframe-code" readonly onclick="this.select()"></textarea>
                    </div>
                </div>
            </div>
            <div id="preview-panel">
                <iframe id="preview-iframe"></iframe>
            </div>
        </div>

        <!-- ======================= –ò–ì–†–ê (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ iframe) ======================= -->
        <div id="game-container" class="hidden">
             <!-- –≠–∫—Ä–∞–Ω 1: –°—Ç–∞—Ä—Ç -->
            <div id="start-screen" class="game-frame">
                <h1 id="game-title-display"></h1>
                <div class="start-section">
                    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</h2>
                    <div id="character-selector"></div>
                </div>
                <div class="start-section">
                     <h2>–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å:</h2>
                    <div id="level-selector"></div>
                </div>
                <button id="start-game-btn" disabled>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É!</button>
            </div>
            <!-- –≠–∫—Ä–∞–Ω 2: –ò–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å -->
            <div id="game-process" class="hidden">
                <div id="game-layout">
                    <div id="character-display">
                        <img id="player-char-img" src="" alt="–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂">
                    </div>
                    <div id="card-stack-area"></div>
                </div>
            </div>
            <!-- –≠–∫—Ä–∞–Ω 3: –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã -->
            <div id="end-screen" class="hidden game-frame">
                <h2 id="end-title">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
                <button onclick="window.location.reload()">–°—ã–≥—Ä–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const editorWrapper = document.getElementById('editor-wrapper');
        const gameContainer = document.getElementById('game-container');
        let gameConfig = {};
        let gameState = { level: '', character: '', currentCardIndex: 0 };
        const urlParams = new URLSearchParams(window.location.search);
        const configData = urlParams.get('config');

        if (configData) {
            try {
                const decodedConfig = decodeURIComponent(atob(configData));
                gameConfig = JSON.parse(decodedConfig);
                editorWrapper.classList.add('hidden');
                document.querySelector('body').style.padding = '0'; 
                gameContainer.classList.remove('hidden');
                initGame();
            } catch (e) {
                document.body.innerHTML = "<h1>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã.</h1>";
            }
        } else {
            initEditor();
        }

        // ======================= –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê =======================
        function initEditor() {
            document.getElementById('add-character-btn').addEventListener('click', addCharacterInput);
            document.getElementById('add-question-btn').addEventListener('click', addQuestionBlock);
            document.getElementById('generate-code-btn').addEventListener('click', () => {
                document.getElementById('generated-code-area').style.display = 'block';
            });
            
            // Live Preview Listener
            document.getElementById('editor-panel').addEventListener('input', updatePreview);

            addQuestionBlock();
            updatePreview();
        }

        function collectConfig() {
            const config = {
                title: document.getElementById('game-title').value,
                characters: Array.from(document.querySelectorAll('.character-input')).map(input => input.value).filter(Boolean),
                levels: [
                    document.getElementById('level-easy-name').value,
                    document.getElementById('level-hard-name').value
                ],
                questions: []
            };
            document.querySelectorAll('.question-block').forEach((block, index) => {
                const questionText = block.querySelector('.question-text').value;
                const options = Array.from(block.querySelectorAll('.option-text')).map(input => input.value);
                const correctOptionInput = block.querySelector(`input[name="correct_q${index}"]:checked`);
                if (questionText && options.length > 1 && options.every(Boolean) && correctOptionInput) {
                    config.questions.push({
                        question: questionText,
                        options: options,
                        answer: parseInt(correctOptionInput.value)
                    });
                }
            });
            return config;
        }
        
        function updatePreview() {
            const config = collectConfig();
            if (config.questions.length === 0 || config.characters.length === 0) return;

            const jsonConfig = JSON.stringify(config);
            const base64Config = btoa(encodeURIComponent(jsonConfig));
            const gameUrl = `${window.location.origin}${window.location.pathname}?config=${base64Config}`;
            
            document.getElementById('preview-iframe').src = gameUrl;
            document.getElementById('iframe-code').value = `<iframe src="${gameUrl}" width="800" height="700" frameborder="0"></iframe>`;
        }

        function addCharacterInput() {
            const container = document.getElementById('characters-container');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'character-input';
            input.placeholder = 'https://...';
            container.appendChild(input);
            updatePreview();
        }

        function addQuestionBlock() {
            const container = document.getElementById('questions-container');
            const questionIndex = Date.now(); // Use timestamp for unique name
            const block = document.createElement('div');
            block.className = 'question-block';
            block.innerHTML = `<h4>–í–æ–ø—Ä–æ—Å ${container.children.length + 1}</h4><textarea class="question-text" placeholder="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞..."></textarea><div class="options-container"><div class="option-group"><input type="radio" name="correct_q${questionIndex}" value="0" checked><input type="text" class="option-text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ 1"></div><div class="option-group"><input type="radio" name="correct_q${questionIndex}" value="1"><input type="text" class="option-text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ 2"></div></div><button type="button" class="add-option-btn">–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button><button type="button" class="remove-question-btn remove-btn">–£–¥–∞–ª–∏—Ç—å</button>`;
            container.appendChild(block);
            block.querySelector('.add-option-btn').onclick = () => addOption(block, questionIndex);
            block.querySelector('.remove-question-btn').onclick = () => { block.remove(); updatePreview(); };
        }

        function addOption(block, qIndex) {
            const container = block.querySelector('.options-container');
            const optionIndex = container.children.length;
            const group = document.createElement('div');
            group.className = 'option-group';
            group.innerHTML = `<input type="radio" name="correct_q${qIndex}" value="${optionIndex}"><input type="text" class="option-text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ ${optionIndex + 1}">`;
            container.appendChild(group);
        }

        // ======================= –õ–û–ì–ò–ö–ê –ò–ì–†–´ =======================
        function initGame() {
            document.getElementById('game-title-display').textContent = gameConfig.title;
            const charSelector = document.getElementById('character-selector');
            gameConfig.characters.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.onclick = () => {
                    document.querySelectorAll('#character-selector img').forEach(i => i.classList.remove('selected'));
                    img.classList.add('selected');
                    gameState.character = url;
                    checkStartButton();
                };
                charSelector.appendChild(img);
            });
            const levelSelector = document.getElementById('level-selector');
            gameConfig.levels.forEach(levelName => {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                btn.textContent = levelName;
                btn.onclick = () => {
                    document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    gameState.level = levelName;
                    checkStartButton();
                };
                levelSelector.appendChild(btn);
            });
            document.getElementById('start-game-btn').onclick = startGame;
        }
        
        function checkStartButton() {
            document.getElementById('start-game-btn').disabled = !(gameState.character && gameState.level);
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-process').classList.remove('hidden');
            document.getElementById('player-char-img').src = gameState.character;
            
            const stackArea = document.getElementById('card-stack-area');
            stackArea.innerHTML = '';
            gameState.currentCardIndex = 0;
            
            gameConfig.questions.reverse().forEach((q, index) => {
                const card = createCardElement(q, gameConfig.questions.length - 1 - index);
                const offset = (gameConfig.questions.length - 1 - index) * 4;
                card.style.transform = `translateX(${offset}px) translateY(${offset}px)`;
                stackArea.appendChild(card);
            });
        }

        function createCardElement(qData, index) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.index = index;
            card.innerHTML = `<div class="card-face card-front"></div><div class="card-face card-back"><div class="card-question">${qData.question}</div><div class="card-answers"></div></div>`;
            
            const answersContainer = card.querySelector('.card-answers');
            qData.options.forEach((opt, optIndex) => {
                const btn = document.createElement('button');
                btn.textContent = opt;
                btn.onclick = () => checkAnswer(optIndex === qData.answer, btn);
                answersContainer.appendChild(btn);
            });

            card.addEventListener('click', () => {
                if (!card.classList.contains('flipped')) {
                    card.classList.add('flipped');
                }
            }, { once: true });
            return card;
        }

        function checkAnswer(isCorrect, button) {
            const cardBack = button.closest('.card-back');
            cardBack.querySelectorAll('button').forEach(b => b.disabled = true);
            
            button.classList.add(isCorrect ? 'correct' : 'incorrect');
            
            if (!isCorrect) {
                const correctButton = cardBack.querySelectorAll('button')[gameConfig.questions[gameState.currentCardIndex].answer];
                correctButton.classList.add('correct');
            }

            setTimeout(nextCard, 1500);
        }

        function nextCard() {
            const stackArea = document.getElementById('card-stack-area');
            const currentCard = stackArea.querySelector(`.card[data-index="${gameState.currentCardIndex}"]`);
            if (currentCard) {
                currentCard.classList.add('swiped-away');
            }
            
            gameState.currentCardIndex++;
            
            if (gameState.currentCardIndex >= gameConfig.questions.length) {
                setTimeout(endGame, 600);
            }
        }

        function endGame() {
            document.getElementById('game-process').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('end-title').textContent = "üéâ –û—Ç–ª–∏—á–Ω–æ! –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∏–≥—Ä—É! üéâ";
        }
    });
    </script>
</body>
</html>
